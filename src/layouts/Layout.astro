---
import '../styles/global.css';
import AgeGate from '../components/AgeGate.astro';
import { ViewTransitions } from 'astro:transitions';

export interface Props {
  title: string;
  description?: string;
}

const { title, description = "Mint Cannabis Deals" } = Astro.props;

// Fetch categories and regions for navigation
const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';
let categories: any[] = [];
let regions: any[] = [];

try {
  const response = await fetch(`${API_BASE}/categories?pagination[pageSize]=100`);
  if (response.ok) {
    const data = await response.json();

    categories = (data?.data || []).map((cat: any) => {
      // Handle both direct and nested attribute structures
      const catData = cat.attributes || cat;
      const name = catData.Name || catData.name || '';
      const slug = catData.slug || catData.Slug || cat.documentId || '';

      return {
        name,
        slug,
        icon: getCategoryIcon(slug)
      };
    }).filter((cat: any) => cat.name && cat.slug);
  }
} catch (error) {
  // Silently handle error - categories will remain empty array
}

// Fetch regions for navigation
let navRegions: any[] = [];
try {
  const response = await fetch(`${API_BASE}/regions?populate=region_type&pagination[pageSize]=100`);
  if (response.ok) {
    const data = await response.json();

    navRegions = (data?.data || []).map((region: any) => {
      const name = region.name || '';
      const code = region.code || '';
      const slug = name ? name.toLowerCase().replace(/\s+/g, '-') : '';

      // Get region type
      const regionType = region.region_type?.name || region.region_type?.Name || '';

      return {
        id: region.id || region.documentId,
        name,
        code,
        slug,
        regionType
      };
    })
    .filter((region: any) => {
      // Filter for only states - check if region type is "State" or contains "state"
      const isState = region.regionType &&
                     (region.regionType.toLowerCase() === 'state' ||
                      region.regionType.toLowerCase().includes('state'));
      return region.name && region.slug && isState;
    })
    .sort((a: any, b: any) => a.name.localeCompare(b.name));
  }
} catch (error) {
  // Silently handle error - regions will remain empty array
}

// Fetch stores/locations for navigation grouped by region
let storesByRegion: any = {};
try {
  const response = await fetch(`${API_BASE}/stores?populate=*&pagination[pageSize]=500`);
  if (response.ok) {
    const data = await response.json();

    const stores = (data?.data || []).map((store: any) => {
      const name = store.name || '';
      const id = store.id || store.documentId;
      const slug = store.slug || (name ? name.toLowerCase().replace(/\s+/g, '-') : id);
      const regionData = store.region;

      // Safely extract region name - handle both nested and direct structures
      let regionName = 'Other';
      if (regionData) {
        if (typeof regionData === 'string') {
          regionName = regionData;
        } else if (typeof regionData === 'object') {
          regionName = regionData.name || regionData.Name || 'Other';
        }
      }

      const regionId = regionData?.id || regionData?.documentId || 'other';

      // Check if store is 24 hours by examining hours array
      const is24Hour = store.hours && Array.isArray(store.hours)
        ? store.hours.some((day: any) => day.is24hours === true || day.is_24hour === true)
        : false;

      return {
        id,
        name,
        slug,
        regionName,
        regionId,
        is24Hour
      };
    }).filter((store: any) => store.name);

    // Group stores by region
    stores.forEach((store: any) => {
      if (!storesByRegion[store.regionName]) {
        storesByRegion[store.regionName] = [];
      }
      storesByRegion[store.regionName].push(store);
    });

    // Sort stores within each region alphabetically
    Object.keys(storesByRegion).forEach(regionName => {
      storesByRegion[regionName].sort((a: any, b: any) => a.name.localeCompare(b.name));
    });
  }
} catch (error) {
  // Silently handle error - storesByRegion will remain empty object
}

function getCategoryIcon(slug: string) {
  const icons: Record<string, string> = {
    'flower': 'üåø',
    'pre-rolls': 'üö¨',
    'vaporizers': 'üí®',
    'concentrates': 'üçØ',
    'edibles': 'üç≠',
    'topicals': 'üß¥',
    'cartridges': 'üñäÔ∏è',
    'tinctures': 'üíß'
  };
  return icons[slug] || 'üå±';
}
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ViewTransitions />

    <!-- Theme initialization (prevent FOUC) -->
    <script is:inline>
      // Load saved theme immediately before page render
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'default';
        if (savedTheme && savedTheme !== 'default') {
          document.documentElement.setAttribute('data-theme', savedTheme);
        }
      })();
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <AgeGate />

    <header class="bg-black shadow-lg">
      <div class="max-w-[95%] mx-auto px-8 sm:px-12 lg:px-16 xl:px-20">
        <div class="flex justify-between items-center py-6">
          <div class="flex items-center">
            <a href="/" class="flex items-center space-x-2 hover:opacity-80 transition-opacity">
              <img
                src="/assets/Mint_Full_Logo.png"
                alt="Mint Cannabis"
                class="h-12 w-auto object-contain"
              />
            </a>
          </div>

          <nav class="hidden md:flex space-x-8 items-center uppercase">
            <a href="/" class="text-gray-200 hover:text-yellow-600 px-3 py-2 rounded-md text-sm font-semibold">
              Home
            </a>

            <!-- Locations Dropdown (States + Stores) -->
            <div class="relative" id="locationsDropdown">
              <a href="/regions" class="text-gray-200 hover-mint-green px-3 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
                Locations
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </a>

              <!-- Dropdown Menu -->
              <div id="locationsMenu" class="absolute left-0 mt-1 w-80 border border-black rounded-lg hidden z-50" style="background-color: rgba(25, 25, 25, 0.95); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), 0 10px 25px rgba(0, 0, 0, 0.6), 0 0 15px rgba(0, 255, 0, 0.2);">
                <div class="py-2 max-h-[70vh] overflow-y-auto">
                  <div class="px-4 py-3">
                    <p class="text-yellow-400 font-bold text-base pb-1 leading-snug">Browse by State & Location</p>
                  </div>
                  {navRegions.map(region => {
                    const storesInRegion = storesByRegion[region.name] || [];
                    return (
                      <div class="mb-2">
                        {/* State Header */}
                        <a
                          href={`/region/${region.slug}`}
                          class="block px-4 py-2 text-base text-white font-bold hover-mint-green transition-colors border-b border-gray-700"
                        >
                          {region.name}
                          {region.code && <span class="text-sm text-gray-400 ml-2">({region.code})</span>}
                        </a>
                        {/* Stores under this state */}
                        {storesInRegion.length > 0 && (
                          <div class="bg-black/30">
                            {storesInRegion.map((store: any) => (
                              <a
                                href={`/location/${store.slug}`}
                                class="block px-6 py-2 text-sm text-gray-300 hover-mint-green transition-colors"
                              >
                                <span class="flex items-center gap-2">
                                  <span class="text-gray-500">‚îî</span>
                                  <span>{store.name}</span>
                                  {store.is24Hour && <span class="text-xs text-yellow-400">24hr</span>}
                                </span>
                              </a>
                            ))}
                          </div>
                        )}
                      </div>
                    );
                  })}
                  <a href="/regions" class="block px-4 py-3 text-base font-bold text-center text-white hover-mint-green transition-colors border-t border-gray-700">
                    View All Locations ‚Üí
                  </a>
                </div>
              </div>
            </div>
            <a href="/map" class="text-gray-200 hover:text-purple-600 px-3 py-2 rounded-md text-sm font-semibold">
              Map
            </a>
            <a href="/locations-deals" class="text-gray-200 hover:text-yellow-500 px-3 py-2 rounded-md text-sm font-semibold">
              Location Deals
            </a>
            <a href="/deals" class="text-gray-200 hover:text-orange-600 px-3 py-2 rounded-md text-sm font-semibold">
              Deals
            </a>
          </nav>
        </div>
      </div>
    </header>

    <main>
      <slot />
    </main>

    <footer class="bg-gray-800 text-white">
      <div class="max-w-[95%] mx-auto px-8 sm:px-12 lg:px-16 xl:px-20 py-12">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
          <!-- About Section with Logo -->
          <div>
            <a href="/" class="inline-block mb-4 hover:opacity-80 transition-opacity">
              <img
                src="/assets/Mint_Full_Logo.png"
                alt="Mint Cannabis"
                class="h-16 w-auto object-contain"
              />
            </a>
            <p class="text-gray-400 text-sm">
              Your trusted source for premium cannabis products and deals.
            </p>
          </div>

          <!-- Quick Links -->
          <div>
            <h3 class="text-lg font-semibold text-white mb-4">Quick Links</h3>
            <ul class="space-y-2">
              <li>
                <a href="/" class="text-gray-400 hover:text-yellow-400 text-sm transition-colors">Home</a>
              </li>
              <li class="relative" id="categoriesDropdown">
                <a href="/categories" class="text-gray-400 hover-mint-green text-sm transition-colors inline-flex items-center gap-1">
                  Categories
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </a>

                <!-- Dropdown Menu (opens upward) -->
                <div id="categoriesMenu" class="absolute bottom-full left-0 mb-1 w-72 border border-black rounded-lg hidden z-50" style="background-color: rgba(25, 25, 25, 0.95); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), 0 10px 25px rgba(0, 0, 0, 0.6), 0 0 15px rgba(0, 255, 0, 0.2);">
                  <div class="py-2 max-h-96 overflow-y-auto">
                    <div class="px-4 py-3">
                      <p class="text-yellow-400 font-bold text-base pb-1 leading-snug">Browse by Category</p>
                    </div>
                    {categories.map(category => (
                      <a
                        href={`/${category.slug}`}
                        class="block px-4 py-3 text-base text-gray-200 hover-mint-green transition-colors"
                      >
                        <span class="font-medium">{category.name}</span>
                      </a>
                    ))}
                    <a href="/categories" class="block px-4 py-3 text-base font-bold text-center text-white hover-mint-green transition-colors">
                      View All Categories ‚Üí
                    </a>
                  </div>
                </div>
              </li>
              <li>
                <a href="/regions" class="text-gray-400 hover-mint-green text-sm transition-colors">Locations</a>
              </li>
              <li>
                <a href="/map" class="text-gray-400 hover:text-purple-400 text-sm transition-colors">Map</a>
              </li>
              <li>
                <a href="/locations-deals" class="text-gray-400 hover:text-yellow-400 text-sm transition-colors">Location Deals</a>
              </li>
              <li>
                <a href="/deals" class="text-gray-400 hover:text-orange-400 text-sm transition-colors">Deals</a>
              </li>
            </ul>
          </div>

          <!-- Resources -->
          <div>
            <h3 class="text-lg font-semibold text-white mb-4">Resources</h3>
            <ul class="space-y-2">
              <li>
                <a href="/dosing-guide" class="text-gray-400 hover-mint-green text-sm transition-colors">Dosing Guide</a>
              </li>
              <li>
                <a href="/coa" class="text-gray-400 hover-mint-green text-sm transition-colors">Certificate of Analysis</a>
              </li>
              <li>
                <a href="/regions" class="text-gray-400 hover-mint-green text-sm transition-colors">Regions</a>
              </li>
            </ul>
          </div>

          <!-- Contact -->
          <div>
            <h3 class="text-lg font-semibold text-white mb-4">Contact</h3>
            <ul class="space-y-2">
              <li>
                <a href="/contact-us" class="text-gray-400 hover:text-yellow-400 text-sm transition-colors">Contact Us</a>
              </li>
              <li>
                <a href="tel:480-749-6468" class="text-gray-400 hover:text-yellow-400 text-sm transition-colors">480-749-MINT (6468)</a>
              </li>
              <li>
                <a href="mailto:info@mintdeals.com" class="text-gray-400 hover:text-yellow-400 text-sm transition-colors">info@mintdeals.com</a>
              </li>
            </ul>
          </div>
        </div>

        <div class="border-t border-gray-700 pt-8 text-center">
          <p class="text-gray-400 text-sm">
            ¬© 2025 Mint Cannabis. All rights reserved.
          </p>
          <!-- Debug: User Location Display -->
          <p id="userLocationDebug" class="text-yellow-400 text-xs mt-2 font-mono">
            Location: Loading...
          </p>
        </div>
      </div>
    </footer>

    <script>
      // Display user's current location for debugging with Tempe as default
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);
            const debugEl = document.getElementById('userLocationDebug');
            if (debugEl) {
              debugEl.textContent = `Your Location: Lat ${lat}, Lon ${lon}`;
            }
          },
          (error) => {
            const debugEl = document.getElementById('userLocationDebug');
            if (debugEl) {
              debugEl.textContent = `Using Tempe location (default): Lat 33.4145, Lon -111.9192`;
            }
          }
        );
      } else {
        const debugEl = document.getElementById('userLocationDebug');
        if (debugEl) {
          debugEl.textContent = 'Using Tempe location (default): Lat 33.4145, Lon -111.9192';
        }
      }
    </script>

    <script>
      // Initialize all dropdowns
      function initializeDropdowns() {
        // Categories dropdown functionality
        const categoriesDropdown = document.getElementById('categoriesDropdown');
        const categoriesMenu = document.getElementById('categoriesMenu');

        if (categoriesDropdown && categoriesMenu) {
          let isOpen = false;
          let closeTimeout: NodeJS.Timeout | null = null;

          // Open dropdown on mouseenter
          categoriesDropdown.addEventListener('mouseenter', () => {
            if (closeTimeout) clearTimeout(closeTimeout);
            categoriesMenu.classList.remove('hidden');
            isOpen = true;
          });

          // Keep open when hovering over menu
          categoriesMenu.addEventListener('mouseenter', () => {
            if (closeTimeout) clearTimeout(closeTimeout);
            isOpen = true;
          });

          // Close dropdown with delay on mouseleave
          categoriesDropdown.addEventListener('mouseleave', () => {
            closeTimeout = setTimeout(() => {
              categoriesMenu.classList.add('hidden');
              isOpen = false;
            }, 200);
          });

          categoriesMenu.addEventListener('mouseleave', () => {
            closeTimeout = setTimeout(() => {
              categoriesMenu.classList.add('hidden');
              isOpen = false;
            }, 200);
          });
        }

        // Locations dropdown functionality
        const locationsDropdown = document.getElementById('locationsDropdown');
        const locationsMenu = document.getElementById('locationsMenu');

        if (locationsDropdown && locationsMenu) {
          let isOpen = false;
          let closeTimeout: NodeJS.Timeout | null = null;

          // Open dropdown on mouseenter
          locationsDropdown.addEventListener('mouseenter', () => {
            if (closeTimeout) clearTimeout(closeTimeout);
            locationsMenu.classList.remove('hidden');
            isOpen = true;
          });

          // Keep open when hovering over menu
          locationsMenu.addEventListener('mouseenter', () => {
            if (closeTimeout) clearTimeout(closeTimeout);
            isOpen = true;
          });

          // Close dropdown with delay on mouseleave
          locationsDropdown.addEventListener('mouseleave', () => {
            closeTimeout = setTimeout(() => {
              locationsMenu.classList.add('hidden');
              isOpen = false;
            }, 200);
          });

          locationsMenu.addEventListener('mouseleave', () => {
            closeTimeout = setTimeout(() => {
              locationsMenu.classList.add('hidden');
              isOpen = false;
            }, 200);
          });
        }
      }

      // Initialize on page load
      initializeDropdowns();

      // Re-initialize after Astro View Transitions
      document.addEventListener('astro:page-load', initializeDropdowns);
    </script>

    <style is:global>
      .hover-mint-green:hover {
        color: #009247 !important;
      }
      .text-mint-green {
        color: #009247 !important;
      }
      .bg-mint-green {
        background-color: #009247 !important;
      }
      .border-mint-green {
        border-color: #009247 !important;
      }
    </style>
  </body>
</html>
