---
export const prerender = true;

import Layout from '../layouts/Layout.astro';

// Dutchie API configuration
const DUTCHIE_API_URL = 'https://plus.dutchie.com/plus/2021-07/graphql';
const DUTCHIE_API_KEY = 'public-eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJBUEktQ0xJRU5UIiwiZXhwIjozMzI4NzcyNTY2OCwiaWF0IjoxNzMwODE2ODY4LCJpc3MiOiJodHRwczovL2R1dGNoaWUuY29tIiwianRpIjoiNzFmYjcyYjItMThmNy00OWE0LTkwYjgtYjVjMDY0NWZhMjZlIiwiZW50ZXJwcmlzZV9pZCI6IjQ1ODZkZmZkLTVmOTEtNGUxZi04OThhLWJmMjMzMjQ4MzBjMSIsInV1aWQiOiJhNzM4MGE0MC1iMmM5LTQ2ZDktOWY5My1jZTEwM2JjZGM0MjkifQ.XZyCX1ZrNy75e3RcqukMUPffIqxEBnWUZ_o52V4VGco';

// Initialize data
let specialProducts = [];
let apiError = null;
let stores = [];
let dutchieRetailerIds = [];

// Available lifestyle polaroid images
const lifestyleImages = [
  { img: "20251001_1034_Joyful Moment Together_simple_compose_01k6gdah5ef7n9mj7hyscbm439.png", title: "Share Joy", vibe: "Social" },
  { img: "20251001_1041_Serene Morning Ritual_simple_compose_01k6gdpzjeexe95stnx5nn3y9b.png", title: "Morning Zen", vibe: "Relaxation" },
  { img: "20251001_1106_Festival Sunset Vibes_simple_compose_01k6gf43hcednabq9xzx5rk5tj.png", title: "Festival Fun", vibe: "Adventure" },
  { img: "20251001_1118_Neon Night Stroll_simple_compose_01k6gftp4ae6r8g2b610xw1f4a.png", title: "Night Life", vibe: "Urban" },
  { img: "20251001_1124_Desert Highway Hangout_simple_compose_01k6gg6918ef5br5x494z7h7gy.png", title: "Desert Vibes", vibe: "Adventure" },
  { img: "20251001_1127_Morning Serenity Moment_simple_compose_01k6ggdyvcfhwtr97712pe392e.png", title: "Serenity", vibe: "Relaxation" },
  { img: "20251001_1130_Kitchen Gathering Joy_simple_compose_01k6ggh1vhe1gvqdd64sfj0web.png", title: "Kitchen Joy", vibe: "Social" },
  { img: "20251001_1138_Jazz Club Vibes_simple_compose_01k6ggzbdeeefb6t68pprex49z.png", title: "Jazz Club", vibe: "Urban" },
  { img: "20251001_1141_Sunny Park Gathering_simple_compose_01k6gh5v42fx4a4gkbdpe9rvsb.png", title: "Park Day", vibe: "Outdoor" },
  { img: "20251001_1149_Backyard BBQ Gathering_simple_compose_01k6ghjj7ff7prsem7192hhz5f.png", title: "BBQ Time", vibe: "Social" },
];

// Randomly select 2-6 polaroids for the hero
function shuffleArray(array: any[]) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Random count between 2 and 6
const polaroidCount = Math.floor(Math.random() * 5) + 2;
const selectedPolaroids = shuffleArray(lifestyleImages).slice(0, polaroidCount);

// Generate random positions spread across entire hero section
const polaroidsWithPositions = selectedPolaroids.map((polaroid, index) => {
  // Positions closer to center but avoiding text area
  const positions = [
    { top: '8%', left: '15%' },
    { top: '10%', right: '18%' },
    { top: '28%', left: '12%' },
    { top: '32%', right: '15%' },
    { top: '55%', left: '18%' },
    { top: '58%', right: '20%' },
    { bottom: '18%', left: '14%' },
    { bottom: '15%', right: '16%' },
    { top: '20%', left: '30%' },
    { top: '68%', right: '28%' },
  ];
  const position = positions[index % positions.length];
  const rotation = Math.random() * 20 - 10; // Random rotation between -10 and 10 degrees
  return { ...polaroid, ...position, rotation };
});

// GraphQL query to fetch products on special
const SPECIALS_QUERY = `
  query GetSpecialProducts($retailerId: ID!) {
    menu(retailerId: $retailerId) {
      products {
        id
        name
        brand {
          name
        }
        category
        subcategory
        image
        description
        potencyCbd {
          formatted
        }
        potencyThc {
          formatted
        }
        variants {
          id
          option
          priceRec
          specialPriceRec
          quantity
        }
      }
    }
  }
`;

// Category icon mapping
function getCategoryIcon(category) {
  const icons = {
    'FLOWER': 'üåø',
    'PRE_ROLLS': 'üö¨',
    'VAPORIZERS': 'üí®',
    'CONCENTRATES': 'üçØ',
    'EDIBLES': 'üç≠',
    'TOPICALS': 'üß¥',
    'CARTRIDGES': 'üñäÔ∏è',
    'TINCTURES': 'üíß',
    'ACCESSORIES': 'üîß',
    'CBD': 'üå±'
  };
  return icons[category] || 'üåø';
}

// Calculate discount percentage
function calculateDiscount(regular, special) {
  if (!regular || !special || special >= regular) return 0;
  return Math.round(((regular - special) / regular) * 100);
}

// Format price
function formatPrice(price) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2
  }).format(price / 100);
}

// First, fetch stores to get Dutchie retailer IDs
const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

try {
  console.log('üöÄ Fetching stores to get Dutchie retailer IDs');

  // Fetch stores from Railway API
  const storesResponse = await fetch(`${API_BASE}/stores?populate=*&pagination[pageSize]=100`);
  if (storesResponse.ok) {
    const storesData = await storesResponse.json();
    stores = storesData?.data || [];

    // Extract Dutchie retailer IDs from stores
    dutchieRetailerIds = stores
      .map(store => store.dutchie_retailer_id || store.dutchie_id || store.retailer_id)
      .filter(id => id); // Remove null/undefined values

    console.log('‚úÖ Stores loaded:', stores.length);
    console.log('üè™ Dutchie retailer IDs found:', dutchieRetailerIds.length);

    if (dutchieRetailerIds.length > 0) {
      console.log('üîç Available retailer IDs:', dutchieRetailerIds);
    } else {
      console.log('‚ö†Ô∏è No Dutchie retailer IDs found in stores, trying with enterprise ID');
      dutchieRetailerIds = ["4586dffd-5f91-4e1f-898a-bf23324830c1"]; // Fallback to enterprise ID
    }
  }
} catch (error) {
  console.error('‚ùå Error fetching stores:', error);
  dutchieRetailerIds = ["4586dffd-5f91-4e1f-898a-bf23324830c1"]; // Fallback to enterprise ID
}

try {
  console.log('üöÄ Fetching special products from Dutchie API');

  // Use the first available retailer ID
  const retailerId = dutchieRetailerIds[0] || "4586dffd-5f91-4e1f-898a-bf23324830c1";

  const requestBody = {
    query: SPECIALS_QUERY,
    variables: {
      retailerId: retailerId
    }
  };

  console.log('üîç Request body:', JSON.stringify(requestBody, null, 2));

  const response = await fetch(DUTCHIE_API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${DUTCHIE_API_KEY}`,
    },
    body: JSON.stringify(requestBody)
  });

  console.log('üì° Response status:', response.status);
  const responseText = await response.text();
  console.log('üì° Response body:', responseText);

  if (response.ok) {
    const data = JSON.parse(responseText);

    if (data.errors) {
      console.error('‚ùå GraphQL Errors:', data.errors);
      apiError = `GraphQL Error: ${data.errors.map(e => e.message).join(', ')}`;

      // Use fallback data when there are GraphQL errors
      console.log('üîÑ Using fallback data due to GraphQL errors');
      throw new Error('GraphQL Error: Using fallback data');
    } else if (data.data?.menu?.products) {
      // Filter products that have special prices
      specialProducts = data.data.menu.products.filter(product => {
        return product.variants?.some(v => v.specialPriceRec && v.specialPriceRec !== v.priceRec);
      });

      console.log(`‚úÖ ${specialProducts.length} special products loaded`);
    } else {
      console.log('‚ùå No products found in response');
      apiError = 'No products found in API response';
    }
  } else {
    console.error('‚ùå Dutchie API Error:', response.status, responseText);
    apiError = `API Error: ${response.status} - ${responseText}`;
  }
} catch (error) {
  console.error('‚ùå Error fetching special products:', error);
  apiError = error.message;

  // Fallback data for demonstration
  specialProducts = [
    {
      id: '1',
      name: 'Blue Dream',
      brand: { name: 'Mint Cannabis' },
      category: 'FLOWER',
      subcategory: 'Sativa',
      description: 'A classic sativa-dominant hybrid with a sweet berry aroma',
      image: 'https://images.dutchie.com/generic/flower.jpg',
      potencyThc: { formatted: '22.5%' },
      potencyCbd: { formatted: '0.1%' },
      variants: [
        {
          id: 'v1',
          option: '3.5g',
          priceRec: 5500,
          specialPriceRec: 4000,
          quantity: 3.5
        }
      ]
    },
    {
      id: '2',
      name: 'OG Kush',
      brand: { name: 'Mint Cannabis' },
      category: 'FLOWER',
      subcategory: 'Indica',
      description: 'A legendary indica with earthy pine and woody notes',
      image: 'https://images.dutchie.com/generic/flower.jpg',
      potencyThc: { formatted: '25.0%' },
      potencyCbd: { formatted: '0.2%' },
      variants: [
        {
          id: 'v2',
          option: '7g',
          priceRec: 10000,
          specialPriceRec: 7000,
          quantity: 7
        }
      ]
    },
    {
      id: '3',
      name: 'Sour Gummies',
      brand: { name: 'Mint Edibles' },
      category: 'EDIBLES',
      subcategory: 'Gummies',
      description: 'Delicious sour gummies with precise dosing',
      image: 'https://images.dutchie.com/generic/edibles.jpg',
      potencyThc: { formatted: '100mg' },
      potencyCbd: { formatted: '0mg' },
      variants: [
        {
          id: 'v3',
          option: '10 pack',
          priceRec: 3500,
          specialPriceRec: 2000,
          quantity: 10
        }
      ]
    }
  ];
}
---

<style>
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.4));
  }
  .hero-section {
    min-height: 7.5vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
  }

  .hero-section h1 {
    line-height: 1.2;
  }

  @media (min-width: 768px) {
    .hero-section {
      min-height: 30vh;
      padding: 1rem 0;
    }
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .discount-badge {
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
</style>

<Layout title="Special Deals - Mint Cannabis" description="Discover amazing deals and special offers on premium cannabis products at Mint Cannabis.">
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Hero Section -->
    <div class="text-white hero-section relative">
      <!-- Floating Polaroids with Mouse Tracking -->
      {polaroidsWithPositions.map((polaroid, index) => {
        const positionStyle = Object.entries(polaroid)
          .filter(([key]) => ['top', 'bottom', 'left', 'right'].includes(key))
          .map(([key, value]) => `${key}: ${value}`)
          .join('; ');

        return (
          <div
            class="hidden lg:block absolute polaroid-float"
            style={`${positionStyle}; width: 140px; z-index: 1;`}
            data-speed={0.02 + (index * 0.01)}
          >
            <div class="bg-white rounded-lg shadow-2xl p-1.5" style={`transform: rotate(${polaroid.rotation}deg);`}>
              <div class="relative w-full h-20 bg-gray-200 overflow-hidden rounded">
                <img src={`/assets/lifestyleimages/${polaroid.img}`} alt={polaroid.title} class="w-full h-full object-cover" />
              </div>
              <img src="/favicon.png" alt="Mint" class="absolute left-2 w-8 h-8 rounded-full shadow-lg" style="bottom: 18px; z-index: 20;" />
              <div class="relative mt-1.5 text-center pt-3">
                <p class="text-xs font-bold text-gray-800" style="font-family: 'Permanent Marker', cursive;">{polaroid.title}</p>
              </div>
            </div>
          </div>
        );
      })}

      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-[2080px] relative z-10">
        <div class="text-center">
          <h1 class="mb-4 text-4xl font-bold text-white md:text-6xl drop-shadow-2xl" style="text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8), 0 2px 4px rgba(0, 0, 0, 0.9);">
            üî• Special Deals
          </h1>
          <p class="max-w-2xl mx-auto mb-6 text-lg text-yellow-400 md:text-xl drop-shadow-lg">
            Limited time offers on premium cannabis products
          </p>
          <div class="flex flex-wrap justify-center gap-4">
            <a href="/" class="px-6 py-2.5 text-base font-semibold text-black transition-all transform rounded-lg shadow-lg bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 hover:scale-105">
              üè† Back to Home
            </a>
            <a href="/stores" class="px-6 py-2.5 text-base font-semibold text-white transition-all transform rounded-lg shadow-lg bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 hover:scale-105">
              üìç Find Stores
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats Bar -->
    <div class="bg-gradient-to-r from-green-800 via-green-900 to-green-800 py-2">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-[2080px]">
        <div class="grid grid-cols-2 gap-6 text-center md:grid-cols-4">
          <div class="text-white">
            <div class="text-xl font-bold text-yellow-400">{specialProducts.length}+</div>
            <div class="text-xs text-green-200">Products on Sale</div>
          </div>
          <div class="text-white">
            <div class="text-xl font-bold text-yellow-400">Up to 40%</div>
            <div class="text-xs text-green-200">Off Regular Price</div>
          </div>
          <div class="text-white">
            <div class="text-xl font-bold text-yellow-400">Daily</div>
            <div class="text-xs text-green-200">New Deals</div>
          </div>
          <div class="text-white">
            <div class="text-xl font-bold text-yellow-400">6+</div>
            <div class="text-xs text-green-200">Locations</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Special Products Section -->
    <div class="bg-black py-12">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-[2080px]">
        <!-- Section Header -->
        <div class="mb-8 text-center">
          <h2 class="text-3xl font-bold text-white md:text-4xl">
            Today's Special Offers
          </h2>
          <p class="mt-2 text-gray-400">
            {apiError ? 'Showing sample products' : 'Limited quantities available - Shop now!'}
          </p>
        </div>

        <!-- Products Grid -->
        {specialProducts.length === 0 ? (
          <div class="py-16 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4 bg-gray-800 rounded-full">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="mb-2 text-xl font-medium text-white">No Special Deals Available</h3>
            <p class="text-gray-400">
              {apiError ? `Error: ${apiError}` : 'Check back soon for amazing deals!'}
            </p>
          </div>
        ) : (
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {specialProducts.map(product => {
              const bestVariant = product.variants?.find(v => v.specialPriceRec) || product.variants?.[0];
              const discount = bestVariant ? calculateDiscount(bestVariant.priceRec, bestVariant.specialPriceRec) : 0;

              return (
                <div class="relative overflow-hidden transition-all transform bg-gray-900 border border-green-500 rounded-lg shadow-lg hover:scale-105 hover:shadow-2xl group">
                  {/* Discount Badge */}
                  {discount > 0 && (
                    <div class="absolute top-2 right-2 z-10 px-3 py-1 text-xs font-bold text-black bg-yellow-400 rounded-full discount-badge">
                      {discount}% OFF
                    </div>
                  )}

                  {/* Product Image */}
                  <div class="relative h-48 overflow-hidden bg-gray-800">
                    {product.image ? (
                      <img
                        src={product.image}
                        alt={product.name}
                        class="object-cover w-full h-full transition-transform group-hover:scale-110"
                      />
                    ) : (
                      <div class="flex items-center justify-center w-full h-full">
                        <span class="text-6xl">{getCategoryIcon(product.category)}</span>
                      </div>
                    )}
                  </div>

                  {/* Product Info */}
                  <div class="p-6">
                    {/* Brand & Category */}
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-green-400">
                        {product.brand?.name || 'Mint Cannabis'}
                      </span>
                      <span class="px-2 py-1 text-xs text-green-200 bg-green-900 rounded-full">
                        {product.subcategory || product.category}
                      </span>
                    </div>

                    {/* Product Name */}
                    <h3 class="mb-2 text-lg font-bold text-white">
                      {product.name}
                    </h3>

                    {/* Description */}
                    {product.description && (
                      <p class="mb-3 text-sm text-gray-400 line-clamp-2">
                        {product.description}
                      </p>
                    )}

                    {/* Potency */}
                    {(product.potencyThc || product.potencyCbd) && (
                      <div class="flex gap-3 mb-3">
                        {product.potencyThc && (
                          <span class="text-xs text-yellow-400">
                            THC: {product.potencyThc.formatted}
                          </span>
                        )}
                        {product.potencyCbd && (
                          <span class="text-xs text-green-400">
                            CBD: {product.potencyCbd.formatted}
                          </span>
                        )}
                      </div>
                    )}

                    {/* Variants & Pricing */}
                    {bestVariant && (
                      <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-sm text-gray-400">
                            {bestVariant.option}
                          </span>
                          <div class="flex items-center gap-2">
                            {bestVariant.specialPriceRec && bestVariant.priceRec > bestVariant.specialPriceRec && (
                              <span class="text-sm text-gray-500 line-through">
                                {formatPrice(bestVariant.priceRec)}
                              </span>
                            )}
                            <span class="text-lg font-bold text-green-400">
                              {formatPrice(bestVariant.specialPriceRec || bestVariant.priceRec)}
                            </span>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Action Buttons */}
                    <div class="flex gap-2">
                      <button class="flex-1 px-4 py-2 font-medium text-black transition-colors bg-yellow-500 rounded-lg hover:bg-yellow-600">
                        View Deal
                      </button>
                      <a href="/stores" class="px-4 py-2 font-medium text-white transition-colors bg-green-600 rounded-lg hover:bg-green-700">
                        Find Store
                      </a>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* Load More Button */}
        {specialProducts.length > 0 && (
          <div class="mt-12 text-center">
            <button class="px-8 py-3 font-semibold text-black transition-all transform bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg shadow-lg hover:from-yellow-500 hover:to-yellow-600 hover:scale-105">
              Load More Deals
            </button>
          </div>
        )}
      </div>
    </div>

    <!-- CTA Section -->
    <div class="bg-gradient-to-br from-green-900 via-black to-green-800 py-16">
      <div class="px-4 mx-auto text-center sm:px-6 lg:px-8 max-w-[2080px]">
        <h2 class="mb-4 text-3xl font-bold text-white md:text-4xl">
          Don't Miss Out on These Deals!
        </h2>
        <p class="max-w-2xl mx-auto mb-8 text-lg text-gray-300">
          Special offers are available for a limited time only. Visit your nearest Mint Cannabis location today.
        </p>
        <div class="flex flex-wrap justify-center gap-4">
          <a href="/stores" class="px-8 py-3 font-semibold text-black transition-all transform bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg shadow-lg hover:from-yellow-500 hover:to-yellow-600 hover:scale-105">
            üìç Find Your Store
          </a>
          <a href="/categories" class="px-8 py-3 font-semibold text-white transition-all transform bg-gradient-to-r from-green-600 to-green-700 rounded-lg shadow-lg hover:from-green-700 hover:to-green-800 hover:scale-105">
            üõçÔ∏è Browse All Products
          </a>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    // Mouse tracking for polaroid movement
    function initPolaroidMouseTracking() {
      const polaroids = document.querySelectorAll('.polaroid-float');

      if (polaroids.length === 0) {
        console.log('No polaroids found');
        return;
      }

      console.log(`Found ${polaroids.length} polaroids`);

      document.addEventListener('mousemove', (e) => {
        const mouseX = e.clientX / window.innerWidth;
        const mouseY = e.clientY / window.innerHeight;

        polaroids.forEach((polaroid) => {
          const speed = parseFloat(polaroid.getAttribute('data-speed') || '0.02');
          const x = (mouseX - 0.5) * 100 * speed;
          const y = (mouseY - 0.5) * 100 * speed;

          // Get the inner div with rotation
          const innerDiv = polaroid.querySelector('.bg-white');
          if (innerDiv) {
            const currentRotation = innerDiv.style.transform.match(/rotate\(([^)]+)\)/)?.[1] || '0deg';
            innerDiv.style.transform = `rotate(${currentRotation}) translate(${x}px, ${y}px)`;
          }
        });
      });
    }

    // Initialize on both initial load and page transitions
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPolaroidMouseTracking);
    } else {
      initPolaroidMouseTracking();
    }

    // Also handle Astro view transitions
    document.addEventListener('astro:page-load', initPolaroidMouseTracking);
  </script>
</Layout>