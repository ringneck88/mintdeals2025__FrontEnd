---
export const prerender = true;

import Layout from '../layouts/Layout.astro';

// Initialize data arrays
let stores = [];
let categories = [];
let regions = [];
let apiError = null;

// Category icon mapping
function getCategoryIcon(slug) {
  const icons = {
    'flower': 'üåø',
    'pre-rolls': 'üö¨',
    'vaporizers': 'üí®',
    'concentrates': 'üçØ',
    'edibles': 'üç≠',
    'topicals': 'üß¥',
    'cartridges': 'üñäÔ∏è',
    'tinctures': 'üíß',
    'accessories': 'üîß',
    'cbd': 'üå±'
  };
  return icons[slug] || 'üåø';
}

// Category color mapping for variety
function getCategoryColor(index) {
  const colors = [
    'from-green-500 to-green-600',
    'from-yellow-400 to-yellow-500',
    'from-green-600 to-green-700',
    'from-yellow-500 to-yellow-600',
    'from-green-400 to-green-500',
    'from-yellow-300 to-yellow-400'
  ];
  return colors[index % colors.length];
}

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

try {

  // Fetch stores, categories, and regions in parallel
  const [storesResponse, categoriesResponse, regionsResponse] = await Promise.allSettled([
    fetch(`${API_BASE}/stores?populate=*&pagination[pageSize]=50`),
    fetch(`${API_BASE}/categories?populate=*&pagination[pageSize]=25`),
    fetch(`${API_BASE}/regions?populate=*&pagination[pageSize]=50`)
  ]);

  // Process stores
  if (storesResponse.status === 'fulfilled' && storesResponse.value.ok) {
    const data = await storesResponse.value.json();
    const storesData = data?.data || [];

    stores = storesData.map(store => {
      // Extract coordinates from geo field (JSON object with lat/lng)
      let latitude = null;
      let longitude = null;

      if (store.geo) {
        if (typeof store.geo === 'object') {
          latitude = store.geo.lat || store.geo.latitude || null;
          longitude = store.geo.lng || store.geo.lon || store.geo.longitude || null;
        } else if (typeof store.geo === 'string') {
          try {
            const geoObj = JSON.parse(store.geo);
            latitude = geoObj.lat || geoObj.latitude || null;
            longitude = geoObj.lng || geoObj.lon || geoObj.longitude || null;
          } catch (e) {
            console.error('Failed to parse geo string for store:', store.name);
          }
        }
      }

      // Helper function to get image URL from various possible structures
      function getImageUrl(imageData) {
        if (!imageData || imageData === null) return null;

        // Case 1: Strapi v4 nested structure
        if (imageData?.data?.attributes?.url) {
          const url = imageData.data.attributes.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        // Case 2: Direct image object with formats (Cloudinary)
        if (typeof imageData === 'object' && imageData.formats) {
          if (imageData.formats.large?.url) return imageData.formats.large.url;
          if (imageData.formats.medium?.url) return imageData.formats.medium.url;
          if (imageData.formats.small?.url) return imageData.formats.small.url;
          if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
        }

        // Case 3: Direct image object with url
        if (typeof imageData === 'object' && imageData.url) {
          const url = imageData.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        // Case 4: String URL directly
        if (typeof imageData === 'string') {
          return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
        }

        return null;
      }

      // Get hero_media first, fallback to image
      const heroImage = getImageUrl(store.hero_media) || getImageUrl(store.image);

      return {
        id: store.id,
        documentId: store.documentId,
        name: store.name || 'Unnamed Store',
        slug: store.slug || store.documentId,
        address: {
          ...store.address,
          latitude: latitude,
          longitude: longitude
        },
        phone: store.phone,
        hours: store.hours,
        image: heroImage,
        isActive: store.is_active !== false
      };
    }).filter(store => store.isActive);
  }

  // Process categories
  if (categoriesResponse.status === 'fulfilled' && categoriesResponse.value.ok) {
    const data = await categoriesResponse.value.json();
    const categoriesData = data?.data || [];


    categories = categoriesData.map((category, index) => {
      // Check if it's Strapi v4 format (with attributes) or direct format
      const isV4 = !!category.attributes;
      const data = isV4 ? category.attributes : category;

      // Helper function to get image URL from various possible structures
      function getImageUrl(imageData) {
        if (!imageData || imageData === null) return null;

        // Case 1: Strapi v4 nested structure: image.data.attributes.url
        if (imageData?.data?.attributes?.url) {
          const url = imageData.data.attributes.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        // Case 2: Direct image object with formats (Cloudinary or Strapi uploaded images)
        if (typeof imageData === 'object' && imageData.formats) {
          // Prefer larger formats for better quality
          if (imageData.formats.large?.url) return imageData.formats.large.url;
          if (imageData.formats.medium?.url) return imageData.formats.medium.url;
          if (imageData.formats.small?.url) return imageData.formats.small.url;
          if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
        }

        // Case 3: Direct image object with url: image.url
        if (typeof imageData === 'object' && imageData.url) {
          const url = imageData.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        // Case 4: String URL directly
        if (typeof imageData === 'string') {
          return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
        }

        return null;
      }

      // Try multiple possible image field names (case-insensitive variations)
      const imageUrl = getImageUrl(data.image)
        || getImageUrl(data.Image)
        || getImageUrl(data.IMAGE)
        || getImageUrl(category.image)
        || getImageUrl(category.Image)
        || null;

      return {
        id: category.id,
        documentId: category.documentId,
        title: data.Name || data.name || '',
        description: data.Discription || data.description || '',
        slug: data.Slug || data.slug || category.documentId || category.id,
        icon: getCategoryIcon(data.Slug || data.slug),
        image: imageUrl,
        isActive: true,
        productCount: data.products?.data?.length || data.products?.length || 0,
        colorGradient: getCategoryColor(index)
      };
    });

    // Filter and sort categories client-side
    categories = categories
      .filter(category => category.title && category.isActive)
      .sort((a, b) => a.title.localeCompare(b.title));
  }

  // Process regions
  if (regionsResponse.status === 'fulfilled' && regionsResponse.value.ok) {
    const data = await regionsResponse.value.json();
    const regionsData = data?.data || [];

    regions = regionsData.map((region) => {
      const isV4 = !!region.attributes;
      const data = isV4 ? region.attributes : region;

      // Get region type
      const regionTypeData = data.region_type?.data || data.region_type;
      const regionType = regionTypeData?.attributes?.name || regionTypeData?.name || regionTypeData?.Name || '';

      // Helper function to get image URL
      function getImageUrl(imageData) {
        if (!imageData || imageData === null) return null;

        if (imageData?.data?.attributes?.url) {
          const url = imageData.data.attributes.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        if (typeof imageData === 'object' && imageData.formats) {
          if (imageData.formats.large?.url) return imageData.formats.large.url;
          if (imageData.formats.medium?.url) return imageData.formats.medium.url;
          if (imageData.formats.small?.url) return imageData.formats.small.url;
          if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
        }

        if (typeof imageData === 'object' && imageData.url) {
          const url = imageData.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        if (typeof imageData === 'string') {
          return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
        }

        return null;
      }

      const imageUrl = getImageUrl(data.image)
        || getImageUrl(data.Image)
        || getImageUrl(data.IMAGE)
        || getImageUrl(region.image)
        || getImageUrl(region.Image)
        || null;

      return {
        id: region.id,
        documentId: region.documentId,
        name: data.name || data.Name || '',
        slug: data.slug || data.Slug || region.documentId || region.id,
        description: data.description || data.Description || '',
        image: imageUrl,
        regionType
      };
    });

    // Filter for only states
    regions = regions.filter(region => {
      const isState = region.regionType &&
                     (region.regionType.toLowerCase() === 'state' ||
                      region.regionType.toLowerCase().includes('state'));
      return region.name && isState;
    });
  }

} catch (error) {
  apiError = error instanceof Error ? error.message : 'Unknown error';
}
---

<Layout title="Mint Deals - Cannabis Dispensaries & Products" description="Find cannabis dispensaries, products, and deals. Your trusted source for premium cannabis products and information.">
  <!-- Hero Section -->
  <section class="relative bg-black py-16 md:py-24 overflow-hidden">
    <!-- Video Background -->
    <div class="absolute inset-0 w-full h-full">
      <video
        autoplay
        loop
        muted
        playsinline
        class="w-full h-full object-cover"
      >
        <source src="/videos/Untitled design (2).mp4" type="video/mp4">
      </video>
      <!-- Dark overlay for better text visibility -->
      <div class="absolute inset-0 bg-black/50"></div>
    </div>

    <!-- Content -->
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <img
          src="/assets/Mint_Full_Logo.png"
          alt="Mint Deals Logo"
          class="w-full max-w-md md:max-w-xl mx-auto mb-8"
        />
        <div class="flex flex-col items-center gap-4 mt-8">
          <a
            href="/map"
            class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 text-lg rounded-full transition-all duration-300 hover:scale-105 shadow-lg"
          >
            Shop Local
          </a>
          <a
            href="https://apps.apple.com/"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-block bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-12 text-lg rounded-full transition-all duration-300 hover:scale-105 shadow-lg"
          >
            Get Our App
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Shop by State Carousel -->
  <section class="bg-black">
    <div class="w-full">
      {regions.length > 0 ? (
        <div class="relative">
          <!-- Carousel Container -->
          <div class="overflow-hidden">
            <div id="states-carousel" class="flex transition-transform duration-500 ease-out">
              {regions.map((region) => (
                <a
                  href={`/region/${region.slug}`}
                  class="flex-shrink-0 w-full md:w-1/2 lg:w-1/3 xl:w-1/4 group relative overflow-hidden border border-black"
                >
                  <div class="aspect-[16/9] relative overflow-hidden">
                    {region.image ? (
                      <img
                        src={region.image}
                        alt={region.name}
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500 border border-black"
                      />
                    ) : (
                      <div class="w-full h-full bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center">
                        <span class="text-6xl">üìç</span>
                      </div>
                    )}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                  </div>
                  <div class="absolute bottom-0 left-0 right-0 p-6">
                    <h3 class="text-2xl font-bold text-white mb-2">{region.name}</h3>
                    <p class="text-sm text-gray-300 line-clamp-2">
                      {region.description || `Explore dispensaries in ${region.name}`}
                    </p>
                  </div>
                </a>
              ))}
            </div>
          </div>

          <!-- Navigation Buttons -->
          <button
            id="states-prev"
            class="absolute left-4 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-10"
            aria-label="Previous states"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <button
            id="states-next"
            class="absolute right-4 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-10"
            aria-label="Next states"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="inline-block bg-gray-800 rounded-lg p-8">
            <div class="text-6xl mb-4">üìç</div>
            <h3 class="text-xl font-medium text-white mb-2">States Coming Soon</h3>
            <p class="text-gray-400">Check back soon for state information</p>
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- Store Locations Section -->
  <section class="relative py-16 bg-gray-900 bg-cover bg-center bg-no-repeat" style="background-image: url('/assets/Mint-Wallpaper-Smoke-3840x2400.jpg');">
    <div class="absolute inset-0" style="background: radial-gradient(circle, rgba(0, 0, 0, 0.9) 0%, rgba(17, 24, 39, 0.85) 50%, rgba(31, 41, 55, 0.8) 100%);"></div>
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-right mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-white mb-4 uppercase">
          Our Locations
        </h2>
      </div>

      {stores.length > 0 ? (
        <div id="stores-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {stores.slice(0, 8).map((store) => (
            <a
              href={`/location/${store.slug}`}
              class="store-card group relative bg-gray-800 rounded-lg overflow-hidden hover:transform hover:scale-105 transition-all duration-300"
              data-lat={store.latitude}
              data-lng={store.longitude}
              data-name={store.name}
            >
              <div class="aspect-[4/3] relative overflow-hidden">
                {store.image ? (
                  <img
                    src={store.image}
                    alt={store.name}
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500 border border-black"
                  />
                ) : (
                  <div class="w-full h-full bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center">
                    <span class="text-6xl">üè™</span>
                  </div>
                )}
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
              </div>
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <h3 class="text-xl font-bold text-white mb-1">{store.name}</h3>
                {store.address && (
                  <p class="text-sm text-gray-300">
                    {store.address.city}, {store.address.state}
                  </p>
                )}
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="inline-block bg-gray-800 rounded-lg p-8">
            <div class="text-6xl mb-4">üè™</div>
            <h3 class="text-xl font-medium text-white mb-2">Locations Coming Soon</h3>
            <p class="text-gray-400">Check back soon for store locations</p>
          </div>
        </div>
      )}

      <div class="text-center mt-12">
        <a href="/stores" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300">
          View All Locations
        </a>
      </div>
    </div>
  </section>

  <!-- Promotions Section -->
  <section class="bg-black py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-right mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-white mb-4 uppercase">
          Promotions
        </h2>
      </div>

      <div class="relative">
        <!-- Banner Carousel Container -->
        <div class="overflow-hidden rounded-lg">
          <div id="promotions-carousel" class="flex transition-transform duration-700 ease-in-out">
            <!-- Banner 1 -->
            <div class="w-full flex-shrink-0">
              <div class="relative aspect-[16/6] bg-gradient-to-r from-green-600 to-green-800 rounded-lg overflow-hidden">
                <div class="absolute inset-0 flex items-center justify-center p-8">
                  <div class="text-center">
                    <h3 class="text-4xl md:text-6xl font-bold text-white mb-4">Special Offer!</h3>
                    <p class="text-xl md:text-2xl text-white mb-6">Save 20% on all products this week</p>
                    <a href="/deals" class="inline-block bg-white text-green-600 font-bold py-3 px-8 rounded-full hover:bg-gray-100 transition-colors duration-300">
                      Shop Deals
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Banner 2 -->
            <div class="w-full flex-shrink-0">
              <div class="relative aspect-[16/6] bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg overflow-hidden">
                <div class="absolute inset-0 flex items-center justify-center p-8">
                  <div class="text-center">
                    <h3 class="text-4xl md:text-6xl font-bold text-white mb-4">New Products!</h3>
                    <p class="text-xl md:text-2xl text-white mb-6">Check out our latest arrivals</p>
                    <a href="/categories" class="inline-block bg-white text-yellow-600 font-bold py-3 px-8 rounded-full hover:bg-gray-100 transition-colors duration-300">
                      Explore Now
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Banner 3 -->
            <div class="w-full flex-shrink-0">
              <div class="relative aspect-[16/6] bg-gradient-to-r from-purple-600 to-purple-800 rounded-lg overflow-hidden">
                <div class="absolute inset-0 flex items-center justify-center p-8">
                  <div class="text-center">
                    <h3 class="text-4xl md:text-6xl font-bold text-white mb-4">Member Rewards!</h3>
                    <p class="text-xl md:text-2xl text-white mb-6">Join our loyalty program today</p>
                    <a href="/stores" class="inline-block bg-white text-purple-600 font-bold py-3 px-8 rounded-full hover:bg-gray-100 transition-colors duration-300">
                      Learn More
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Dots -->
        <div class="flex justify-center mt-6 gap-3">
          <button class="promo-dot w-3 h-3 rounded-full bg-white opacity-50 hover:opacity-75 transition-opacity" data-index="0"></button>
          <button class="promo-dot w-3 h-3 rounded-full bg-white opacity-50 hover:opacity-75 transition-opacity" data-index="1"></button>
          <button class="promo-dot w-3 h-3 rounded-full bg-white opacity-50 hover:opacity-75 transition-opacity" data-index="2"></button>
        </div>

        <!-- Navigation Arrows -->
        <button id="promo-prev" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg transition-all duration-300 z-10">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <button id="promo-next" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg transition-all duration-300 z-10">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>
  </section>

  <!-- Shop Categories Section -->
  <section class="bg-gray-900 py-16">
    <div class="w-full">
      {categories.length > 0 ? (
        <>
          <div class="relative">
            <!-- Carousel Container -->
            <div class="overflow-hidden">
              <div id="categories-carousel" class="flex transition-transform duration-500 ease-out">
                {categories.map((category) => (
                  <a
                    href={`/${category.slug}`}
                    class="flex-shrink-0 w-full md:w-1/2 lg:w-1/3 xl:w-1/4 group relative overflow-hidden border border-black"
                  >
                    <div class="aspect-[16/9] relative overflow-hidden bg-gray-800">
                      {category.image ? (
                        <img
                          src={category.image}
                          alt={category.title}
                          class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500 border border-black"
                        />
                      ) : (
                        <div class="w-full h-full bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center">
                          <span class="text-6xl">üåø</span>
                        </div>
                      )}
                      <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 p-6">
                      <h3 class="text-2xl font-bold text-white mb-2">{category.title}</h3>
                      <p class="text-sm text-gray-300 line-clamp-2">
                        {category.description || 'Learn More'}
                      </p>
                    </div>
                  </a>
                ))}
              </div>
            </div>

            <!-- Navigation Buttons -->
            <button
              id="categories-prev"
              class="absolute left-4 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-10"
              aria-label="Previous categories"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            <button
              id="categories-next"
              class="absolute right-4 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-10"
              aria-label="Next categories"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>

          <div class="text-right mt-12 px-4 sm:px-6 lg:px-8">
            <a href="/categories" class="text-yellow-400 hover:text-yellow-300 transition-colors underline text-lg">
              View All Categories ‚Üí
            </a>
          </div>
        </>
      ) : (
        <div class="text-center py-12">
          <div class="inline-block bg-gray-800 rounded-lg p-8">
            <div class="text-6xl mb-4">üåø</div>
            <h3 class="text-xl font-medium text-white mb-2">Categories Coming Soon</h3>
            <p class="text-gray-400">Check back soon for product categories</p>
          </div>
        </div>
      )}
    </div>
  </section>
</Layout>

<script>
  // States Carousel
  function initStatesCarousel() {
    const carousel = document.getElementById('states-carousel');
    const prevBtn = document.getElementById('states-prev');
    const nextBtn = document.getElementById('states-next');

    if (!carousel || !prevBtn || !nextBtn) return;

    let currentIndex = 0;
    const totalCards = carousel.children.length;

    function getVisibleCards() {
      const width = window.innerWidth;
      if (width >= 1280) return 4; // xl: 4 cards
      if (width >= 1024) return 3; // lg: 3 cards
      if (width >= 768) return 2;  // md: 2 cards
      return 1; // mobile: 1 card
    }

    function updateCarousel() {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);

      if (currentIndex > maxIndex) {
        currentIndex = maxIndex;
      }

      const percentage = -(currentIndex * (100 / visibleCards));
      carousel.style.transform = `translateX(${percentage}%)`;

      updateButtons();
    }

    function updateButtons() {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);

      prevBtn.disabled = currentIndex <= 0;
      nextBtn.disabled = currentIndex >= maxIndex;
      prevBtn.style.opacity = currentIndex <= 0 ? '0.5' : '1';
      nextBtn.style.opacity = currentIndex >= maxIndex ? '0.5' : '1';
    }

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateCarousel();
      }
    });

    nextBtn.addEventListener('click', () => {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateCarousel();
      }
    });

    updateCarousel();

    window.addEventListener('resize', () => {
      updateCarousel();
    });
  }

  document.addEventListener('DOMContentLoaded', initStatesCarousel);
  document.addEventListener('astro:page-load', initStatesCarousel);
</script>

<script>
  // Store Location Sorting by Distance
  function sortStoresByLocation() {
    const storesGrid = document.getElementById('stores-grid');
    if (!storesGrid) return;

    const storeCards = Array.from(storesGrid.querySelectorAll('.store-card'));

    // Haversine formula to calculate distance between two points
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3959; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Sort stores by distance from user location
    function sortByDistance(userLat, userLng) {
      const sortedCards = storeCards
        .map(card => {
          const lat = parseFloat(card.dataset.lat);
          const lng = parseFloat(card.dataset.lng);
          const distance = (lat && lng) ? calculateDistance(userLat, userLng, lat, lng) : Infinity;
          return { card, distance };
        })
        .sort((a, b) => a.distance - b.distance);

      // Re-append cards in sorted order
      sortedCards.forEach(({ card }) => storesGrid.appendChild(card));
    }

    // Default: Show Tempe location first
    function sortWithTempeFirst() {
      const sortedCards = storeCards.sort((a, b) => {
        const nameA = a.dataset.name || '';
        const nameB = b.dataset.name || '';

        // Prioritize Tempe
        if (nameA.toLowerCase().includes('tempe')) return -1;
        if (nameB.toLowerCase().includes('tempe')) return 1;

        return 0;
      });

      sortedCards.forEach(card => storesGrid.appendChild(card));
    }

    // Try to get user's geolocation
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          sortByDistance(position.coords.latitude, position.coords.longitude);
        },
        (error) => {
          // If location denied or error, show Tempe first
          console.log('Geolocation not available, showing Tempe first');
          sortWithTempeFirst();
        },
        { timeout: 5000 }
      );
    } else {
      // If geolocation not supported, show Tempe first
      sortWithTempeFirst();
    }
  }

  document.addEventListener('DOMContentLoaded', sortStoresByLocation);
  document.addEventListener('astro:page-load', sortStoresByLocation);
</script>

<script>
  // Promotions Carousel with Auto-rotation
  function initPromotionsCarousel() {
    const carousel = document.getElementById('promotions-carousel');
    const prevBtn = document.getElementById('promo-prev');
    const nextBtn = document.getElementById('promo-next');
    const dots = document.querySelectorAll('.promo-dot');

    if (!carousel || !prevBtn || !nextBtn) return;

    let currentIndex = 0;
    const totalBanners = carousel.children.length;
    let autoRotateInterval;

    function updateCarousel() {
      carousel.style.transform = `translateX(-${currentIndex * 100}%)`;

      // Update dots
      dots.forEach((dot, index) => {
        if (index === currentIndex) {
          dot.classList.remove('opacity-50');
          dot.classList.add('opacity-100');
        } else {
          dot.classList.remove('opacity-100');
          dot.classList.add('opacity-50');
        }
      });
    }

    function goToSlide(index) {
      currentIndex = index;
      if (currentIndex < 0) currentIndex = totalBanners - 1;
      if (currentIndex >= totalBanners) currentIndex = 0;
      updateCarousel();
      resetAutoRotate();
    }

    function nextSlide() {
      goToSlide(currentIndex + 1);
    }

    function prevSlide() {
      goToSlide(currentIndex - 1);
    }

    function startAutoRotate() {
      autoRotateInterval = setInterval(nextSlide, 5000); // Auto-rotate every 5 seconds
    }

    function stopAutoRotate() {
      if (autoRotateInterval) {
        clearInterval(autoRotateInterval);
      }
    }

    function resetAutoRotate() {
      stopAutoRotate();
      startAutoRotate();
    }

    // Event listeners
    prevBtn.addEventListener('click', prevSlide);
    nextBtn.addEventListener('click', nextSlide);

    dots.forEach(dot => {
      dot.addEventListener('click', () => {
        const index = parseInt(dot.dataset.index);
        goToSlide(index);
      });
    });

    // Pause auto-rotation on hover
    carousel.addEventListener('mouseenter', stopAutoRotate);
    carousel.addEventListener('mouseleave', startAutoRotate);

    // Initialize
    updateCarousel();
    startAutoRotate();
  }

  document.addEventListener('DOMContentLoaded', initPromotionsCarousel);
  document.addEventListener('astro:page-load', initPromotionsCarousel);
</script>

<script>
  // Categories Carousel
  function initCategoriesCarousel() {
    const carousel = document.getElementById('categories-carousel');
    const prevBtn = document.getElementById('categories-prev');
    const nextBtn = document.getElementById('categories-next');

    if (!carousel || !prevBtn || !nextBtn) return;

    let currentIndex = 0;
    const totalCards = carousel.children.length;

    function getVisibleCards() {
      const width = window.innerWidth;
      if (width >= 1280) return 4; // xl: 4 cards
      if (width >= 1024) return 3; // lg: 3 cards
      if (width >= 768) return 2;  // md: 2 cards
      return 1; // mobile: 1 card
    }

    function updateCarousel() {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);

      if (currentIndex > maxIndex) {
        currentIndex = maxIndex;
      }

      const percentage = -(currentIndex * (100 / visibleCards));
      carousel.style.transform = `translateX(${percentage}%)`;

      updateButtons();
    }

    function updateButtons() {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);

      prevBtn.disabled = currentIndex <= 0;
      nextBtn.disabled = currentIndex >= maxIndex;
      prevBtn.style.opacity = currentIndex <= 0 ? '0.5' : '1';
      nextBtn.style.opacity = currentIndex >= maxIndex ? '0.5' : '1';
    }

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateCarousel();
      }
    });

    nextBtn.addEventListener('click', () => {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateCarousel();
      }
    });

    updateCarousel();

    window.addEventListener('resize', () => {
      updateCarousel();
    });
  }

  document.addEventListener('DOMContentLoaded', initCategoriesCarousel);
  document.addEventListener('astro:page-load', initCategoriesCarousel);
</script>

<style>
  @keyframes blob {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    25% {
      transform: translate(20px, -50px) scale(1.1);
    }
    50% {
      transform: translate(-20px, 20px) scale(0.9);
    }
    75% {
      transform: translate(50px, 50px) scale(1.05);
    }
  }

  .animate-blob {
    animation: blob 7s infinite;
  }

  .animation-delay-2000 {
    animation-delay: 2s;
  }

  .animation-delay-4000 {
    animation-delay: 4s;
  }
</style>
