---
export const prerender = true;

import Layout from '../layouts/Layout.astro';

// Initialize data arrays
let stores = [];
let categories = [];
let regions = [];
let faqs = [];
let apiError = null;

// Category icon mapping
function getCategoryIcon(slug) {
  const icons = {
    'flower': 'üåø',
    'pre-rolls': 'üö¨',
    'vaporizers': 'üí®',
    'concentrates': 'üçØ',
    'edibles': 'üç≠',
    'topicals': 'üß¥',
    'cartridges': 'üñäÔ∏è',
    'tinctures': 'üíß',
    'accessories': 'üîß',
    'cbd': 'üå±'
  };
  return icons[slug] || 'üåø';
}

// Category color mapping for variety
function getCategoryColor(index) {
  const colors = [
    'from-green-500 to-green-600',
    'from-yellow-400 to-yellow-500',
    'from-green-600 to-green-700',
    'from-yellow-500 to-yellow-600',
    'from-green-400 to-green-500',
    'from-yellow-300 to-yellow-400'
  ];
  return colors[index % colors.length];
}

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

try {

  // Fetch stores, categories, regions, and FAQs in parallel
  const [storesResponse, categoriesResponse, regionsResponse, faqsResponse] = await Promise.allSettled([
    fetch(`${API_BASE}/stores?populate=*&pagination[pageSize]=50`),
    fetch(`${API_BASE}/categories?populate=*&pagination[pageSize]=25`),
    fetch(`${API_BASE}/regions?populate=*&pagination[pageSize]=50`),
    fetch(`${API_BASE}/faqqas?filters[is_global][$eq]=true&pagination[pageSize]=100`)
  ]);

  // Process stores
  if (storesResponse.status === 'fulfilled' && storesResponse.value.ok) {
    const data = await storesResponse.value.json();
    const storesData = data?.data || [];

    stores = storesData.map(store => {
      // Extract coordinates from geo field (JSON object with lat/lng)
      let latitude = null;
      let longitude = null;

      if (store.geo) {
        if (typeof store.geo === 'object') {
          latitude = store.geo.lat || store.geo.latitude || null;
          longitude = store.geo.lng || store.geo.lon || store.geo.longitude || null;
        } else if (typeof store.geo === 'string') {
          try {
            const geoObj = JSON.parse(store.geo);
            latitude = geoObj.lat || geoObj.latitude || null;
            longitude = geoObj.lng || geoObj.lon || geoObj.longitude || null;
          } catch (e) {
            console.error('Failed to parse geo string for store:', store.name);
          }
        }
      }

      // Helper function to get image URL from various possible structures
      function getImageUrl(imageData) {
        if (!imageData || imageData === null) return null;

        // Case 1: Strapi v4 nested structure
        if (imageData?.data?.attributes?.url) {
          const url = imageData.data.attributes.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        // Case 2: Direct image object with formats (Cloudinary)
        if (typeof imageData === 'object' && imageData.formats) {
          if (imageData.formats.large?.url) return imageData.formats.large.url;
          if (imageData.formats.medium?.url) return imageData.formats.medium.url;
          if (imageData.formats.small?.url) return imageData.formats.small.url;
          if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
        }

        // Case 3: Direct image object with url
        if (typeof imageData === 'object' && imageData.url) {
          const url = imageData.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        // Case 4: String URL directly
        if (typeof imageData === 'string') {
          return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
        }

        return null;
      }

      // Get hero_media first, fallback to image
      const heroImage = getImageUrl(store.hero_media) || getImageUrl(store.image);

      return {
        id: store.id,
        documentId: store.documentId,
        name: store.name || 'Unnamed Store',
        slug: store.slug || store.documentId,
        address: {
          ...store.address,
          latitude: latitude,
          longitude: longitude
        },
        phone: store.phone,
        hours: store.hours,
        image: heroImage,
        isActive: store.is_active !== false
      };
    }).filter(store => store.isActive);
  }

  // Process categories
  if (categoriesResponse.status === 'fulfilled' && categoriesResponse.value.ok) {
    const data = await categoriesResponse.value.json();
    const categoriesData = data?.data || [];


    categories = categoriesData.map((category, index) => {
      // Check if it's Strapi v4 format (with attributes) or direct format
      const isV4 = !!category.attributes;
      const data = isV4 ? category.attributes : category;

      // Helper function to get image URL from various possible structures
      function getImageUrl(imageData) {
        if (!imageData || imageData === null) return null;

        // Case 1: Strapi v4 nested structure: image.data.attributes.url
        if (imageData?.data?.attributes?.url) {
          const url = imageData.data.attributes.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        // Case 2: Direct image object with formats (Cloudinary or Strapi uploaded images)
        if (typeof imageData === 'object' && imageData.formats) {
          // Prefer larger formats for better quality
          if (imageData.formats.large?.url) return imageData.formats.large.url;
          if (imageData.formats.medium?.url) return imageData.formats.medium.url;
          if (imageData.formats.small?.url) return imageData.formats.small.url;
          if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
        }

        // Case 3: Direct image object with url: image.url
        if (typeof imageData === 'object' && imageData.url) {
          const url = imageData.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        // Case 4: String URL directly
        if (typeof imageData === 'string') {
          return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
        }

        return null;
      }

      // Try multiple possible image field names (case-insensitive variations)
      const imageUrl = getImageUrl(data.image)
        || getImageUrl(data.Image)
        || getImageUrl(data.IMAGE)
        || getImageUrl(category.image)
        || getImageUrl(category.Image)
        || null;

      return {
        id: category.id,
        documentId: category.documentId,
        title: data.Name || data.name || '',
        description: data.Discription || data.description || '',
        slug: data.Slug || data.slug || category.documentId || category.id,
        icon: getCategoryIcon(data.Slug || data.slug),
        image: imageUrl,
        isActive: true,
        productCount: data.products?.data?.length || data.products?.length || 0,
        colorGradient: getCategoryColor(index)
      };
    });

    // Filter and sort categories client-side
    categories = categories
      .filter(category => category.title && category.isActive)
      .sort((a, b) => a.title.localeCompare(b.title));
  }

  // Process regions
  if (regionsResponse.status === 'fulfilled' && regionsResponse.value.ok) {
    const data = await regionsResponse.value.json();
    const regionsData = data?.data || [];

    regions = regionsData.map((region) => {
      const isV4 = !!region.attributes;
      const data = isV4 ? region.attributes : region;

      // Get region type
      const regionTypeData = data.region_type?.data || data.region_type;
      const regionType = regionTypeData?.attributes?.name || regionTypeData?.name || regionTypeData?.Name || '';

      // Helper function to get image URL
      function getImageUrl(imageData) {
        if (!imageData || imageData === null) return null;

        if (imageData?.data?.attributes?.url) {
          const url = imageData.data.attributes.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        if (typeof imageData === 'object' && imageData.formats) {
          if (imageData.formats.large?.url) return imageData.formats.large.url;
          if (imageData.formats.medium?.url) return imageData.formats.medium.url;
          if (imageData.formats.small?.url) return imageData.formats.small.url;
          if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
        }

        if (typeof imageData === 'object' && imageData.url) {
          const url = imageData.url;
          return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
        }

        if (typeof imageData === 'string') {
          return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
        }

        return null;
      }

      const imageUrl = getImageUrl(data.image)
        || getImageUrl(data.Image)
        || getImageUrl(data.IMAGE)
        || getImageUrl(region.image)
        || getImageUrl(region.Image)
        || null;

      return {
        id: region.id,
        documentId: region.documentId,
        name: data.name || data.Name || '',
        slug: data.slug || data.Slug || region.documentId || region.id,
        description: data.description || data.Description || '',
        image: imageUrl,
        regionType
      };
    });

    // Filter for only states
    regions = regions.filter(region => {
      const isState = region.regionType &&
                     (region.regionType.toLowerCase() === 'state' ||
                      region.regionType.toLowerCase().includes('state'));
      return region.name && isState;
    });
  }

  // Process FAQs
  if (faqsResponse.status === 'fulfilled' && faqsResponse.value.ok) {
    const data = await faqsResponse.value.json();
    const faqsData = data?.data || [];

    faqs = faqsData.map((faq) => {
      return {
        id: faq.id,
        documentId: faq.documentId,
        question: faq.question || '',
        answer: faq.answer || '',
        isGlobal: faq.is_global || false,
        order: faq.order || 0
      };
    }).filter(faq => faq.question && faq.answer);

    // Sort by order field if available
    faqs.sort((a, b) => a.order - b.order);
  }

  // Temporary sample FAQs for demonstration (remove when Strapi FAQs are ready)
  if (faqs.length === 0) {
    faqs = [
      {
        id: 1,
        question: "What are your store hours?",
        answer: "Our store hours vary by location. Most locations are open 7 days a week from 8:00 AM to 9:30 PM. Please check your specific location's hours on their individual page.",
        order: 1
      },
      {
        id: 2,
        question: "Do I need a medical card to shop?",
        answer: "Requirements vary by state. In recreational states like Arizona and Nevada, you can shop with just a valid government-issued ID showing you're 21+. In medical-only states, you'll need a valid medical marijuana card.",
        order: 2
      },
      {
        id: 3,
        question: "What payment methods do you accept?",
        answer: "We accept cash, debit cards, and CanPay at most locations. Some locations may have ATMs on-site for your convenience. Credit cards are not currently accepted due to federal banking regulations.",
        order: 3
      },
      {
        id: 4,
        question: "Do you offer online ordering?",
        answer: "Yes! Most of our locations offer online ordering for pickup. Simply browse our menu, add items to your cart, and choose a pickup time. You'll receive a notification when your order is ready.",
        order: 4
      },
      {
        id: 5,
        question: "What's your return policy?",
        answer: "Due to the nature of cannabis products, we cannot accept returns once you leave the store. However, if there's an issue with your product, please contact us immediately and we'll work to resolve it.",
        order: 5
      }
    ];
  }

} catch (error) {
  apiError = error instanceof Error ? error.message : 'Unknown error';
}
---

<Layout title="Mint Deals - Cannabis Dispensaries & Products" description="Find cannabis dispensaries, products, and deals. Your trusted source for premium cannabis products and information.">
  <!-- Hero Section -->
  <section class="relative bg-black py-16 md:py-24 overflow-hidden">
    <!-- Video Background -->
    <div class="absolute inset-0 w-full h-full">
      <video
        autoplay
        loop
        muted
        playsinline
        class="w-full h-full object-cover"
      >
        <source src="/videos/Untitled design (2).mp4" type="video/mp4">
      </video>
      <!-- Dark overlay for better text visibility -->
      <div class="absolute inset-0 bg-black/50"></div>
    </div>

    <!-- Content -->
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <img
          src="/assets/Mint_Full_Logo.png"
          alt="Mint Deals Logo"
          class="w-full max-w-md md:max-w-xl mx-auto mb-8"
        />
        <div class="flex flex-col items-center gap-4 mt-8">
          <a
            href="/map"
            class="inline-flex items-center gap-3 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 text-lg rounded-full transition-all duration-300 hover:scale-105 shadow-lg"
            style="filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.5)) drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            Shop Local
          </a>
          <a
            href="https://apps.apple.com/"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-3 bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-12 text-lg rounded-full transition-all duration-300 hover:scale-105 shadow-lg"
            style="filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.5)) drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            Get Our App
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Shop by State Carousel -->
  <section class="bg-black">
    <div class="w-full">
      {regions.length > 0 ? (
        <div class="relative">
          <!-- Carousel Container -->
          <div class="overflow-hidden">
            <div id="states-carousel" class="flex transition-transform duration-500 ease-out">
              {regions.map((region) => (
                <a
                  href={`/region/${region.slug}`}
                  class="flex-shrink-0 w-full md:w-1/2 lg:w-1/3 xl:w-1/4 group relative overflow-hidden border-x border-y-2 border-black"
                >
                  <div class="aspect-[16/9] relative overflow-hidden">
                    {region.image ? (
                      <img
                        src={region.image}
                        alt={region.name}
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                      />
                    ) : (
                      <div class="w-full h-full bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center">
                        <span class="text-6xl">üìç</span>
                      </div>
                    )}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                  </div>
                  <div class="absolute bottom-0 left-0 right-0 p-6">
                    <h3 class="text-2xl font-bold text-white mb-2">{region.name}</h3>
                    <p class="text-sm text-gray-300 line-clamp-2">
                      {region.description || `Explore dispensaries in ${region.name}`}
                    </p>
                  </div>
                </a>
              ))}
            </div>
          </div>

          <!-- Navigation Buttons -->
          <button
            id="states-prev"
            class="absolute left-4 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-10"
            aria-label="Previous states"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <button
            id="states-next"
            class="absolute right-4 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-10"
            aria-label="Next states"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="inline-block bg-gray-800 rounded-lg p-8">
            <div class="text-6xl mb-4">üìç</div>
            <h3 class="text-xl font-medium text-white mb-2">States Coming Soon</h3>
            <p class="text-gray-400">Check back soon for state information</p>
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- Store Locations Section -->
  <section class="relative py-16 bg-gray-900 bg-cover bg-center bg-no-repeat" style="background-image: url('/assets/Mint-Wallpaper-Smoke-3840x2400.jpg');">
    <div class="absolute inset-0" style="background: radial-gradient(circle, rgba(0, 0, 0, 0.9) 0%, rgba(17, 24, 39, 0.85) 50%, rgba(31, 41, 55, 0.8) 100%);"></div>
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-right mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-white mb-4 uppercase">
          Featured Locations
        </h2>
      </div>

      {stores.length > 0 ? (
        <div id="stores-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {stores.slice(0, 9).map((store) => (
            <a
              href={`/location/${store.slug}`}
              class="store-card group relative bg-gray-800 rounded-lg overflow-hidden hover:transform hover:scale-105 transition-all duration-300"
              data-lat={store.address?.latitude}
              data-lng={store.address?.longitude}
              data-name={store.name}
            >
              <div class="aspect-[4/3] relative overflow-hidden">
                {store.image ? (
                  <img
                    src={store.image}
                    alt={store.name}
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500 border border-black"
                  />
                ) : (
                  <div class="w-full h-full bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center">
                    <span class="text-6xl">üè™</span>
                  </div>
                )}
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
              </div>
              <div class="absolute top-4 right-4">
                <span class="distance-badge hidden bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-full"></span>
              </div>
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <h3 class="text-xl font-bold text-white mb-1">{store.name}</h3>
                {store.address && (
                  <p class="text-sm text-gray-300">
                    {store.address.city}, {store.address.state}
                  </p>
                )}
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="inline-block bg-gray-800 rounded-lg p-8">
            <div class="text-6xl mb-4">üè™</div>
            <h3 class="text-xl font-medium text-white mb-2">Locations Coming Soon</h3>
            <p class="text-gray-400">Check back soon for store locations</p>
          </div>
        </div>
      )}

      <div class="text-center mt-12">
        <a href="/stores" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300">
          View All Locations
        </a>
      </div>
    </div>
  </section>

  <!-- Google Reviews Section -->
  <section class="relative py-16 bg-gray-900">
    <div class="absolute inset-0 bg-gradient-to-b from-gray-900 via-black to-gray-900 opacity-90"></div>
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-white mb-4 uppercase">
          What Our Customers Say
        </h2>
        <div class="flex items-center justify-center gap-2 mb-2">
          <div class="flex text-yellow-400">
            {[...Array(5)].map(() => (
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
            ))}
          </div>
          <span class="text-gray-300 text-lg">4.8 out of 5</span>
        </div>
        <p class="text-gray-400">Based on 500+ Google reviews</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Review Card 1 -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow duration-300">
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
              S
            </div>
            <div class="ml-4">
              <h4 class="text-white font-semibold">Sarah M.</h4>
              <div class="flex text-yellow-400">
                {[...Array(5)].map(() => (
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                ))}
              </div>
            </div>
          </div>
          <p class="text-gray-300 leading-relaxed">
            "Amazing selection and great prices! The staff is always knowledgeable and friendly. Best dispensary experience I've had."
          </p>
          <div class="mt-4 flex items-center text-gray-500 text-sm">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 488 512">
              <path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path>
            </svg>
            Google Review
          </div>
        </div>

        <!-- Review Card 2 -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow duration-300">
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
              M
            </div>
            <div class="ml-4">
              <h4 class="text-white font-semibold">Mike T.</h4>
              <div class="flex text-yellow-400">
                {[...Array(5)].map(() => (
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                ))}
              </div>
            </div>
          </div>
          <p class="text-gray-300 leading-relaxed">
            "The deals are unbeatable! I saved so much money on quality products. The app makes it super easy to find what I need."
          </p>
          <div class="mt-4 flex items-center text-gray-500 text-sm">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 488 512">
              <path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path>
            </svg>
            Google Review
          </div>
        </div>

        <!-- Review Card 3 -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow duration-300">
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
              J
            </div>
            <div class="ml-4">
              <h4 class="text-white font-semibold">Jessica L.</h4>
              <div class="flex text-yellow-400">
                {[...Array(5)].map(() => (
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                ))}
              </div>
            </div>
          </div>
          <p class="text-gray-300 leading-relaxed">
            "Love the convenience of finding nearby dispensaries and comparing prices. This platform has become my go-to resource!"
          </p>
          <div class="mt-4 flex items-center text-gray-500 text-sm">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 488 512">
              <path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path>
            </svg>
            Google Review
          </div>
        </div>
      </div>

      <div class="text-center mt-10">
        <a
          href="https://www.google.com/search?q=mint+deals"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 bg-white hover:bg-gray-100 text-gray-900 font-bold py-3 px-8 rounded-lg transition-colors duration-300"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 488 512">
            <path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"></path>
          </svg>
          Read All Reviews on Google
        </a>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  {faqs.length > 0 && (
    <section class="relative py-16 bg-black">
      <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold text-white mb-4 uppercase">
            Frequently Asked Questions
          </h2>
          <p class="text-gray-400">Hover over a question to see the answer</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {faqs.map((faq, index) => (
            <div class="faq-card group bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-green-500 transition-all duration-300 hover:shadow-lg hover:shadow-green-500/20">
              <h3 class="text-lg font-semibold text-white group-hover:text-green-500 transition-colors duration-300 mb-3">
                {faq.question}
              </h3>
              <div class="faq-answer overflow-hidden max-h-0 opacity-0 group-hover:max-h-96 group-hover:opacity-100 transition-all duration-500 ease-in-out">
                <p class="text-gray-300 leading-relaxed">
                  {faq.answer}
                </p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

</Layout>

<script>
  // States Carousel
  function initStatesCarousel() {
    const carousel = document.getElementById('states-carousel');
    const prevBtn = document.getElementById('states-prev');
    const nextBtn = document.getElementById('states-next');

    if (!carousel || !prevBtn || !nextBtn) return;

    let currentIndex = 0;
    const totalCards = carousel.children.length;

    function getVisibleCards() {
      const width = window.innerWidth;
      if (width >= 1280) return 4; // xl: 4 cards
      if (width >= 1024) return 3; // lg: 3 cards
      if (width >= 768) return 2;  // md: 2 cards
      return 1; // mobile: 1 card
    }

    function updateCarousel() {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);

      if (currentIndex > maxIndex) {
        currentIndex = maxIndex;
      }

      const percentage = -(currentIndex * (100 / visibleCards));
      carousel.style.transform = `translateX(${percentage}%)`;

      updateButtons();
    }

    function updateButtons() {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);

      prevBtn.disabled = currentIndex <= 0;
      nextBtn.disabled = currentIndex >= maxIndex;
      prevBtn.style.opacity = currentIndex <= 0 ? '0.5' : '1';
      nextBtn.style.opacity = currentIndex >= maxIndex ? '0.5' : '1';
    }

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateCarousel();
      }
    });

    nextBtn.addEventListener('click', () => {
      const visibleCards = getVisibleCards();
      const maxIndex = Math.max(0, totalCards - visibleCards);
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateCarousel();
      }
    });

    updateCarousel();

    window.addEventListener('resize', () => {
      updateCarousel();
    });
  }

  document.addEventListener('DOMContentLoaded', initStatesCarousel);
  document.addEventListener('astro:page-load', initStatesCarousel);
</script>

<script>
  // Store Location Sorting by Distance with Visual Indicators
  function sortStoresByLocation() {
    console.log('üîÑ Starting store sorting function...');

    const storesGrid = document.getElementById('stores-grid');
    if (!storesGrid) {
      console.error('‚ùå stores-grid element not found');
      return;
    }

    const storeCards = Array.from(storesGrid.querySelectorAll('.store-card'));
    console.log(`üìç Found ${storeCards.length} store cards`);

    if (storeCards.length === 0) {
      console.error('‚ùå No store cards found');
      return;
    }

    // Tempe, AZ coordinates (default fallback location)
    const TEMPE_LAT = 33.4255;
    const TEMPE_LNG = -111.9400;

    // Haversine formula to calculate distance between two points
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3959; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Format distance for display
    function formatDistance(miles) {
      if (miles < 1) {
        return `${(miles * 5280).toFixed(0)} ft`;
      } else if (miles < 10) {
        return `${miles.toFixed(1)} mi`;
      } else {
        return `${Math.round(miles)} mi`;
      }
    }

    // Sort stores by distance and show distance badges
    function sortByDistance(userLat, userLng, isUserLocation = false) {
      console.log('Sorting stores from location:', userLat, userLng);

      const sortedCards = storeCards
        .map(card => {
          const lat = parseFloat(card.dataset.lat);
          const lng = parseFloat(card.dataset.lng);
          const storeName = card.dataset.name;
          const distance = (lat && lng && !isNaN(lat) && !isNaN(lng)) ? calculateDistance(userLat, userLng, lat, lng) : Infinity;

          if (distance === Infinity) {
            console.warn(`‚ö†Ô∏è Store: ${storeName} - Missing or invalid coordinates (Lat: ${lat}, Lng: ${lng})`);
          } else {
            console.log(`‚úì Store: ${storeName}, Distance: ${distance.toFixed(2)} mi`);
          }

          // Update distance badge
          const badge = card.querySelector('.distance-badge');
          if (badge && distance !== Infinity) {
            badge.textContent = formatDistance(distance);
            badge.classList.remove('hidden');

            // Color code based on distance
            if (distance < 5) {
              badge.className = 'distance-badge bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg';
            } else if (distance < 20) {
              badge.className = 'distance-badge bg-yellow-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg';
            } else {
              badge.className = 'distance-badge bg-gray-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg';
            }
          }

          return { card, distance, storeName };
        })
        .sort((a, b) => a.distance - b.distance);

      console.log('Sorted order:', sortedCards.map(s => `${s.storeName}: ${s.distance.toFixed(2)} mi`));

      // Create a document fragment for better performance
      const fragment = document.createDocumentFragment();
      sortedCards.forEach(({ card }) => {
        fragment.appendChild(card);
      });

      // Clear the grid and append all sorted cards at once
      storesGrid.innerHTML = '';
      storesGrid.appendChild(fragment);

      console.log('‚úÖ DOM updated with sorted cards');

      // Verify final DOM order
      setTimeout(() => {
        const finalOrder = Array.from(storesGrid.querySelectorAll('.store-card')).map(card => card.dataset.name);
        console.log('üîç Final DOM order after sort:', finalOrder);
      }, 100);

      // Log for debugging
      if (isUserLocation) {
        console.log('‚úÖ Sorted stores by your location');
      } else {
        console.log('‚úÖ Sorted stores by distance from Tempe, AZ');
      }
    }

    // Try to get user's geolocation
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // Use user's current location
          sortByDistance(position.coords.latitude, position.coords.longitude, true);
        },
        (error) => {
          // If location denied or error, sort by distance from Tempe
          console.log('Geolocation not available, sorting by distance from Tempe, AZ');
          sortByDistance(TEMPE_LAT, TEMPE_LNG, false);
        },
        {
          timeout: 5000,
          enableHighAccuracy: true
        }
      );
    } else {
      // If geolocation not supported, sort by distance from Tempe
      console.log('Geolocation not supported, sorting by distance from Tempe, AZ');
      sortByDistance(TEMPE_LAT, TEMPE_LNG, false);
    }
  }

  document.addEventListener('DOMContentLoaded', sortStoresByLocation);
  document.addEventListener('astro:page-load', sortStoresByLocation);
</script>


<style>
  @keyframes blob {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    25% {
      transform: translate(20px, -50px) scale(1.1);
    }
    50% {
      transform: translate(-20px, 20px) scale(0.9);
    }
    75% {
      transform: translate(50px, 50px) scale(1.05);
    }
  }

  .animate-blob {
    animation: blob 7s infinite;
  }

  .animation-delay-2000 {
    animation-delay: 2s;
  }

  .animation-delay-4000 {
    animation-delay: 4s;
  }
</style>
