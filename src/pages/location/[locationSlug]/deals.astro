---
import Layout from '../../../layouts/Layout.astro';
import { getDiscountedProducts, type ProductWithDiscount } from '../../../lib/redis-api';

export async function getStaticPaths() {
  try {
    const response = await fetch('https://mintdealsbackend-production.up.railway.app/api/stores?pagination[pageSize]=100');
    const data = await response.json();

    return data.data.map((store: any) => ({
      params: { locationSlug: store.slug }
    }));
  } catch (error) {
    console.error('Error fetching stores for static paths:', error);
    return [];
  }
}

const { locationSlug } = Astro.params;

// API Configuration
const STRAPI_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

// Fetch the location/store details
let store: any = null;
let error: string | null = null;

try {
  const storesResponse = await fetch(`${STRAPI_BASE}/stores?filters[slug][$eq]=${locationSlug}&populate=*`);
  if (storesResponse.ok) {
    const data = await storesResponse.json();
    const storeData = data?.data?.[0];
    if (storeData) {
      store = {
        id: storeData.id,
        documentId: storeData.documentId,
        name: storeData.name || 'Store',
        slug: storeData.slug || locationSlug,
        dutchieStoreId: storeData.DutchieStoreID || storeData.dutchieStoreId,
        region: storeData.region?.name || storeData.region?.Name || '',
      };
    }
  }
} catch (err: any) {
  error = `Error fetching store: ${err.message}`;
  console.error(error);
}

// Fetch discounted products from Redis cache API
let productDiscounts: ProductWithDiscount[] = [];

if (store?.dutchieStoreId) {
  try {
    const allDiscountedProducts = await getDiscountedProducts(store.dutchieStoreId);

    // Date filtering
    const now = new Date();
    const threeDaysAgo = new Date(now.getTime() - (3 * 24 * 60 * 60 * 1000));
    const sevenDaysFromNow = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));

    // Filter discounts
    productDiscounts = allDiscountedProducts.filter(discount => {
      const category = (discount.category || '').toLowerCase();
      const isCannabis = discount.is_cannabis === true;
      const productName = (discount.product_name || '').toLowerCase();

      // Check category and cannabis filter
      if (!isCannabis || category === 'accessory' || category === 'accessories') {
        return false;
      }

      // Filter out samples
      if (productName.includes('sample')) {
        return false;
      }

      // Check valid_from: should not be more than 3 days in the past
      if (discount.discount_valid_from) {
        const validFrom = new Date(discount.discount_valid_from);
        if (validFrom < threeDaysAgo) {
          return false;
        }
      }

      // Check valid_until: should not be more than 7 days in the future
      if (discount.discount_valid_until) {
        const validUntil = new Date(discount.discount_valid_until);
        if (validUntil > sevenDaysFromNow) {
          return false;
        }
      }

      return true;
    });

    console.log(`[Redis API] Fetched ${productDiscounts.length} deals for ${store.name}`);
  } catch (err: any) {
    error = `Error fetching data: ${err.message}`;
    console.error(error);
  }
}

// Helper function to format price
function formatPrice(price) {
  if (!price && price !== 0) return null;
  return typeof price === 'number' ? price.toFixed(2) : parseFloat(price).toFixed(2);
}

// Helper function to generate Dutchie product slug
function generateDutchieSlug(deal: ProductWithDiscount) {
  const parts = [];
  if (deal.brand_name) parts.push(deal.brand_name);
  if (deal.product_name) parts.push(deal.product_name);

  return parts.join(' ')
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
    .replace(/\s+/g, '-') // Replace spaces with hyphens
    .replace(/-+/g, '-') // Replace multiple hyphens with single
    .trim();
}

// Helper function to calculate discounted price
function calculateDiscountedPrice(deal: ProductWithDiscount) {
  const inventoryPrice = parseFloat(String(deal.unit_price || deal.rec_unit_price || deal.price || 0));
  const discountAmount = deal.discount_amount || 0;
  const discountType = deal.discount_type || '';

  let discountedPrice: number | null = deal.discounted_price || null;

  // If no pre-calculated discounted price, calculate it
  if (!discountedPrice) {
    if (discountType.toLowerCase().includes('percent')) {
      discountedPrice = inventoryPrice * (1 - discountAmount);
    } else if (discountType.toLowerCase().includes('price to amount')) {
      discountedPrice = discountAmount;
    }
  }

  return {
    originalPrice: inventoryPrice,
    discountedPrice: discountedPrice,
    savings: discountedPrice ? inventoryPrice - discountedPrice : 0,
    percentOff: inventoryPrice > 0 && discountedPrice ? Math.round(((inventoryPrice - discountedPrice) / inventoryPrice) * 100) : 0
  };
}
---

<style>
  .logo-bg {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 150vw;
    height: auto;
    object-fit: contain;
    opacity: 0.15;
    z-index: 0;
    pointer-events: none;
  }

  .hero-logo-bg {
    position: absolute;
    top: 40%;
    left: 65%;
    transform: translate(-50%, -50%);
    width: 600px;
    height: auto;
    object-fit: contain;
    opacity: 0.08;
    z-index: 5;
    pointer-events: none;
  }

  .deal-card {
    transition: all 0.3s ease;
  }
  .deal-card:hover {
    transform: translateY(-4px);
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<Layout title={`Deals at ${store?.name || 'Location'} | Mint Cannabis`} description={`Browse all current deals at ${store?.name || 'this location'}.`}>
  <!-- Static Logo Background -->
  <img src="/assets/MintCannabis_CoinLogo_GreyScale_Grey%204.png" alt="" class="logo-bg" aria-hidden="true" />

  <div class="min-h-screen bg-black">
    <!-- Hero Section -->
    <div class="text-white py-12 md:py-16 relative">
      <!-- Hero Logo Background -->
      <img src="/assets/MintCannabis_CoinLogo_GreyScale_Grey%204.png" alt="" class="hero-logo-bg" aria-hidden="true" />

      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-1">
        <!-- Breadcrumbs -->
        <nav class="mb-6 text-sm">
          <div class="flex items-center justify-center space-x-2">
            <a href="/" class="text-yellow-400 hover:text-yellow-300">Home</a>
            <span class="text-green-300">/</span>
            <a href="/deals-db" class="text-yellow-400 hover:text-yellow-300">Deals</a>
            <span class="text-green-300">/</span>
            <span class="text-white">{store?.name || 'Location'}</span>
          </div>
        </nav>

        <div class="text-center">
          <h1 class="text-4xl md:text-6xl font-bold mb-4 uppercase" style="text-shadow: 0 4px 8px rgba(0,0,0,0.8);">
            Deals at {store?.name || 'Location'}
          </h1>
          {store?.region && (
            <p class="text-lg text-gray-300 mb-2">{store.region}</p>
          )}
          <p class="text-lg md:text-xl text-yellow-400 max-w-2xl mx-auto">
            {productDiscounts.length} deals available!
          </p>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    {error && (
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-red-900/80 border border-red-600 rounded-lg p-6 text-white">
          <h2 class="text-xl font-bold mb-2">‚ö†Ô∏è Error</h2>
          <p class="text-sm">{error}</p>
        </div>
      </div>
    )}

    <!-- Deals Grid -->
    <div class="py-8 pb-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {productDiscounts.length === 0 && !error ? (
          <div class="text-center py-16">
            <div class="max-w-md mx-auto p-8 bg-black/80 rounded-lg">
              <div class="text-6xl mb-4">üè∑Ô∏è</div>
              <p class="text-white text-xl font-bold">No deals available</p>
              <p class="text-gray-300 mt-2">Check back soon for new deals!</p>
            </div>
          </div>
        ) : (
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {productDiscounts.map((deal) => {
              const pricing = calculateDiscountedPrice(deal);
              const productSlug = generateDutchieSlug(deal);
              const productUrl = `/location/${store?.slug || locationSlug}?dtche[product]=${productSlug}`;

              return (
                <a href={productUrl} class="deal-card bg-black/80 rounded-lg overflow-hidden shadow-lg relative block cursor-pointer">
                  {/* Discount Name Banner (for non-percent discounts) */}
                  {deal.discount_type && !deal.discount_type.toLowerCase().includes('percent') && deal.discount_name && (
                    <div class="absolute top-0 left-0 right-0 z-10 bg-gradient-to-r from-purple-600 to-purple-700 text-white text-xs font-bold px-4 py-2 text-center">
                      {deal.discount_name}
                    </div>
                  )}

                  {/* BOGO Badge */}
                  {deal.discount_name && deal.discount_name.toLowerCase().includes('bogo') && (
                    <div class="absolute top-2 left-2 z-10 bg-purple-600 text-white text-sm font-bold px-3 py-2 rounded-lg shadow-lg">
                      BOGO
                    </div>
                  )}

                  {/* Percent Off Badge */}
                  {!deal.discount_name?.toLowerCase().includes('bogo') && deal.discount_type && deal.discount_type.toLowerCase().includes('percent') && (
                    <div class="absolute top-2 left-2 z-10 bg-red-600 text-white text-sm font-bold px-3 py-2 rounded-lg shadow-lg">
                      {Math.round(parseFloat(deal.discount_amount || 0) * 100)}% OFF
                    </div>
                  )}

                  {/* Low Stock Badge */}
                  {deal.quantity_available && deal.quantity_available < 10 && (
                    <div class="absolute bottom-2 right-2 z-10 bg-orange-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg animate-pulse">
                      ‚è∞ Going Quick!
                    </div>
                  )}

                  {/* Product Image */}
                  {deal.image_url && (
                    <div class="w-full h-48 bg-white flex items-center justify-center overflow-hidden">
                      <img
                        src={deal.image_url}
                        alt={deal.product_name || 'Product'}
                        class="w-full h-full object-contain"
                        loading="lazy"
                      />
                    </div>
                  )}

                  {/* Product Name */}
                  <div class="text-white text-sm font-bold px-4 py-3 text-center uppercase tracking-wide line-clamp-2">
                    {deal.product_name || deal.productName || 'Product Deal'}
                  </div>

                  {/* Brand Name */}
                  {deal.brand_name && (
                    <div class="text-green-400 text-xs font-semibold px-4 pb-1 text-center uppercase tracking-wider">
                      {deal.brand_name}
                    </div>
                  )}

                  {/* Strain */}
                  {deal.strain && deal.strain !== 'No Strain' && (
                    <div class="text-purple-400 text-xs px-4 pb-2 text-center italic">
                      {deal.strain}
                    </div>
                  )}

                  {/* Discount/Promotion Name */}
                  {deal.discount_name && deal.discount_name !== deal.product_name && (
                    <div class="text-yellow-400 text-xs font-semibold px-3 py-2 text-center">
                      üéâ {deal.discount_name}
                    </div>
                  )}

                  {/* Deal Info */}
                  <div class="p-4">
                    {/* Price Display */}
                    {pricing.discountedPrice && (
                      <div class="text-center mb-4">
                        {/* Original Price - Crossed Out (only for percent discounts) */}
                        {pricing.originalPrice > 0 && deal.discount_type?.toLowerCase().includes('percent') && (
                          <div class="text-gray-400 text-lg line-through mb-1">
                            ${formatPrice(pricing.originalPrice)}
                          </div>
                        )}

                        {/* Discounted Price */}
                        <div class="text-3xl font-bold text-green-400">
                          ${formatPrice(pricing.discountedPrice)}
                        </div>

                        {/* Savings Amount (only for percent discounts) */}
                        {pricing.savings > 0 && deal.discount_type?.toLowerCase().includes('percent') && (
                          <div class="text-yellow-400 text-xs mt-2">
                            Save ${formatPrice(pricing.savings)}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Product Details */}
                    <div class="text-sm space-y-2">
                      {deal.potency_thc_formatted && (
                        <div class="text-gray-300">
                          <span class="text-yellow-400">THC: </span>{deal.potency_thc_formatted}
                        </div>
                      )}
                      {deal.potency_cbd_formatted && (
                        <div class="text-gray-300">
                          <span class="text-blue-400">CBD: </span>{deal.potency_cbd_formatted}
                        </div>
                      )}
                    </div>

                    {/* Valid Dates */}
                    {(deal.discount_valid_from || deal.discount_valid_until) && (
                      <div class="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
                        {deal.discount_valid_from && <div>From: {new Date(deal.discount_valid_from).toLocaleDateString()}</div>}
                        {deal.discount_valid_until && <div>Until: {new Date(deal.discount_valid_until).toLocaleDateString()}</div>}
                      </div>
                    )}
                  </div>
                </a>
              );
            })}
          </div>
        )}

        <!-- CTA -->
        <div class="mt-16 bg-black/90 rounded-lg p-8 text-center">
          <h2 class="text-2xl font-bold mb-4 text-white uppercase">
            Visit This Location
          </h2>
          <p class="text-green-300 mb-6 max-w-2xl mx-auto">
            Stop by {store?.name || 'this location'} to shop these deals in person!
          </p>
          <a href={`/location/${store?.slug || locationSlug}`} class="inline-block px-6 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition-colors">
            View Location Details
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>
