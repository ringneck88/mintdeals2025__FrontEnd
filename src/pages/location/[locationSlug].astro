---
import Layout from '../../layouts/Layout.astro';
import DutchieEmbed from '../../components/DutchieEmbed.astro';
import DutchieCarousel from '../../components/DutchieCarousel.astro';

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';
const { locationSlug } = Astro.params;

// Fetch store data dynamically based on slug
let store = null;
try {
  const response = await fetch(`${API_BASE}/stores?filters[slug][$eq]=${locationSlug}&populate=*`);
  const data = await response.json();

  if (data?.data && data.data.length > 0) {
    store = data.data[0];
  } else {
    // Store not found, return 404
    return Astro.redirect('/404');
  }
} catch (error) {
  // API error, return 404
  return Astro.redirect('/404');
}

// Helper function to safely extract string values
const getStringValue = (value, fallback = '') => {
  return typeof value === 'string' ? value : fallback;
};

const storeName = store?.name || 'Store Location';
const storeCity = getStringValue(store?.address?.city) || getStringValue(store?.city) || '';
const storeState = getStringValue(store?.address?.state) || getStringValue(store?.state) || '';
const storeAddress = getStringValue(store?.address?.street) || getStringValue(store?.street) || '';
const storeZip = getStringValue(store?.address?.zipCode) || getStringValue(store?.zip_code) || '';
const storePhone = getStringValue(store?.phone) || '';
const storeEmail = getStringValue(store?.email) || '';
const googlePlaceId = store?.google_place_id || '';

// Build Google Maps URL - prefer coordinates from geo field, fallback to address
let mapsUrl = '';
if (store?.geo?.lat && store?.geo?.lng) {
  mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${store.geo.lat},${store.geo.lng}`;
} else if (storeAddress || storeCity || storeState) {
  // Use address as fallback
  const addressParts = [storeAddress, storeCity, storeState, storeZip].filter(part => part).join(', ');
  const encodedAddress = encodeURIComponent(addressParts);
  mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
}
const storeShortDescription = getStringValue(store?.short_description) || 'Premium cannabis products and expert guidance for your wellness journey.';
const storeLongDescription = getStringValue(store?.description) || getStringValue(store?.long_description) || 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.';

// Helper function to get image URL
function getImageUrl(imageData: any) {
  if (!imageData || imageData === null) return null;

  // Case 1: Strapi v4 nested structure
  if (imageData?.data?.attributes?.url) {
    const url = imageData.data.attributes.url;
    return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
  }

  // Case 2: Direct image object with formats (Cloudinary)
  if (typeof imageData === 'object' && imageData.formats) {
    if (imageData.formats.large?.url) return imageData.formats.large.url;
    if (imageData.formats.medium?.url) return imageData.formats.medium.url;
    if (imageData.formats.small?.url) return imageData.formats.small.url;
    if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
  }

  // Case 3: Direct image object with url
  if (typeof imageData === 'object' && imageData.url) {
    const url = imageData.url;
    return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
  }

  // Case 4: String URL
  if (typeof imageData === 'string') {
    return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
  }

  return null;
}

// Get store image - prioritize hero_media, fallback to StoreImage, then image
const storeImage = getImageUrl(store?.hero_media) || getImageUrl(store?.StoreImage) || getImageUrl(store?.image);

// Get Dutchie Store ID - extract from menu_url field
let dutchieStoreId = '';
const menuUrl = getStringValue(store?.menu_url) || getStringValue(store?.online_ordering_url) || '';

if (menuUrl) {
  // Extract the ID from the script URL in menu_url
  const match = menuUrl.match(/embedded-menu\/([^.]+)\.js/);
  if (match) {
    dutchieStoreId = match[1];
  }
}

// Get carousel IDs from carousel_url if available
let carouselRetailerId = '';
let carouselId = '';
const carouselUrl = getStringValue(store?.carousel_url) || '';

if (carouselUrl) {
  // Extract retailer ID and carousel ID from v3 carousel script
  // Format: embedded-menu/{retailerId}/carousels/{carouselId}.js
  const carouselMatch = carouselUrl.match(/embedded-menu\/([^\/]+)\/carousels\/([^.]+)\.js/);
  if (carouselMatch) {
    carouselRetailerId = carouselMatch[1];
    carouselId = carouselMatch[2];
  }
}

// Build the route root URL
const baseUrl = 'https://mintdeals2025.pages.dev';
const routeRoot = `${baseUrl}/location/${locationSlug}/menu`;

// Fetch products for this store
let products: any[] = [];
try {
  const response = await fetch(`${API_BASE}/products?filters[stores][id][$eq]=${store?.id}&populate=*&pagination[pageSize]=50`);
  if (response.ok) {
    const data = await response.json();
    products = data?.data || [];
  }
} catch (error) {
  // Silent error
}

// Fetch banners from store-banners collection
let banners: any[] = [];
try {
  const storeDocId = store?.documentId || store?.id;
  const today = new Date();

  // Fetch all banners and filter client-side
  const bannersResponse = await fetch(`${API_BASE}/store-banners?populate=*&pagination[pageSize]=100`);

  if (bannersResponse.ok) {
    const bannersData = await bannersResponse.json();
    const allBanners = bannersData?.data || [];

    const activeBanners = allBanners.filter((bannerItem: any) => {
      // Check if banner is assigned to this store
      const assignedStores = bannerItem.stores || [];
      const isForThisStore = assignedStores.some((s: any) =>
        s.documentId === storeDocId || s.id === store?.id
      );

      if (!isForThisStore) return false;

      // Check if banner is within date range
      const startDate = bannerItem.startDate ? new Date(bannerItem.startDate) : null;
      const endDate = bannerItem.endDate ? new Date(bannerItem.endDate) : null;

      if (startDate && today < startDate) return false;
      if (endDate && today > endDate) return false;

      return true;
    });

    // Map to banner data structure
    banners = activeBanners.map((bannerItem: any) => {
      const imageUrl = getImageUrl(bannerItem.banner);
      return {
        image: imageUrl,
        link: bannerItem.link || null,
        title: bannerItem.Name || null
      };
    }).filter((b: any) => b.image);
  }
} catch (error) {
  console.error('Error fetching banners:', error);
}
---

<style>
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  .video-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(to top,  rgba(41, 163, 41, 0.35), rgba(51, 204, 51, 0.3), rgba(92, 214, 92, 0.25), rgba(133, 224, 133, 0.2), rgba(194, 240, 194, 0.15), rgba(235, 250, 235, 0.1), rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
    mix-blend-mode: color;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
  }

  /* Banner Carousel Styles */
  .banner-carousel {
    position: relative;
    overflow: hidden;
    max-width: 100%;
  }
  .banner-slides {
    display: flex;
    transition: transform 0.5s ease-in-out;
  }
  .banner-slide {
    min-width: 100%;
    flex-shrink: 0;
  }
  .banner-slide img {
    width: 100%;
    height: auto;
    display: block;
    max-height: 400px;
    object-fit: contain;
    background: black;
  }
  @media (max-width: 768px) {
    .banner-slide img {
      max-height: 200px;
    }
  }
  .banner-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    padding: 1rem;
    cursor: pointer;
    z-index: 10;
    transition: background 0.3s;
  }
  .banner-nav:hover {
    background: rgba(0, 0, 0, 0.8);
  }
  .banner-nav.prev {
    left: 0;
  }
  .banner-nav.next {
    right: 0;
  }
  .banner-dots {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
    z-index: 10;
  }
  .banner-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    border: none;
    cursor: pointer;
    transition: background 0.3s;
  }
  .banner-dot.active {
    background: rgba(255, 255, 255, 1);
  }
</style>

<Layout title={`${storeName} - ${storeCity}, ${storeState}`} description={`Visit ${storeName} in ${storeCity}, ${storeState} for premium cannabis products`}>

  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">

  <!-- Hero Section -->
  <section class="relative text-white">
    <!-- Breadcrumb - Top Left -->
    <nav class="absolute top-4 left-4 z-20 text-sm">
      <div class="flex items-center space-x-2 bg-black/50 px-3 py-2 rounded">
        <a href="/" class="text-yellow-400 hover:text-yellow-300">Home</a>
        <span class="text-mint-green">/</span>
        <a href="/regions" class="text-yellow-400 hover:text-yellow-300">Locations</a>
        <span class="text-mint-green">/</span>
        <span class="text-white">{storeName}</span>
      </div>
    </nav>

    <!-- Full Width Hero Image -->
    <div class="relative w-full h-64 md:h-96 overflow-hidden">
      {storeImage ? (
        <img
          src={storeImage}
          alt={storeName}
          class="w-full h-full object-cover"
        />
      ) : (
        <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(to bottom right, #006633, #009247);">
          <span class="text-9xl">üè™</span>
        </div>
      )}
      <div class="absolute inset-0 bg-black/40"></div>

      <!-- Title Overlay -->
      <div class="absolute inset-0 flex flex-col items-center justify-center gap-2">
        <h1 class="text-4xl md:text-6xl font-bold text-white uppercase text-center px-4" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">
          {storeName}
        </h1>
        {googlePlaceId && (
          <div
            class="store-rating"
            data-place-id={googlePlaceId}
          >
            <div class="flex items-center gap-1 text-sm">
              <span class="loading-text text-gray-300" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">Loading rating...</span>
            </div>
          </div>
        )}
      </div>
    </div>
  </section>

  <!-- Banner Carousel -->
  {banners.length > 0 && (
    <section class="bg-black py-4">
      <div class="max-w-7xl mx-auto px-4">
        <div class="banner-carousel">
          <div class="banner-slides" id="bannerSlides">
            {banners.map((banner, index) => (
              <div class="banner-slide">
                {banner.link ? (
                  <a href={banner.link} target="_blank" rel="noopener noreferrer">
                    <img
                      src={banner.image}
                      alt={banner.title || `Banner ${index + 1}`}
                      loading="lazy"
                    />
                  </a>
                ) : (
                  <img
                    src={banner.image}
                    alt={banner.title || `Banner ${index + 1}`}
                    loading="lazy"
                  />
                )}
              </div>
            ))}
          </div>

          {banners.length > 1 && (
            <>
              <button class="banner-nav prev" id="bannerPrev" aria-label="Previous banner">
                ‚Äπ
              </button>
              <button class="banner-nav next" id="bannerNext" aria-label="Next banner">
                ‚Ä∫
              </button>

              <div class="banner-dots" id="bannerDots">
                {banners.map((_, index) => (
                  <button
                    class={`banner-dot ${index === 0 ? 'active' : ''}`}
                    data-index={index}
                    aria-label={`Go to banner ${index + 1}`}
                  />
                ))}
              </div>
            </>
          )}
        </div>
      </div>
    </section>
  )}

  <!-- Main Content -->
  <div class="bg-black py-16">
    <div class="w-full">

      <!-- Products Section - Full Width -->
      {(carouselRetailerId && carouselId) || dutchieStoreId ? (
        <div class="mb-8 bg-white">
          <!-- Dutchie Carousel Embed -->
          {(carouselRetailerId && carouselId) ? (
            <DutchieCarousel retailerId={carouselRetailerId} carouselId={carouselId} routeRoot={routeRoot} />
          ) : (
            <DutchieEmbed storeId={dutchieStoreId} />
          )}
        </div>
      ) : null}

      <style is:global>
        /* Full width iframe styles */
        #dutchie-carousel-container,
        #dutchie-carousel-embed,
        #dutchie-embed-container {
          width: 100% !important;
          max-width: 100% !important;
        }

        #dutchie-carousel-container iframe,
        #dutchie-embed-container iframe {
          width: 100% !important;
          max-width: 100% !important;
          min-height: 500px !important;
          background: white !important;
        }

        /* Make content appear wider using CSS zoom */
        #dutchie-carousel-container,
        #dutchie-embed-container {
          zoom: 1.3;
          -moz-transform: scale(1.3);
          -moz-transform-origin: 0 0;
        }
      </style>

      <!-- About This Location Section - Full Width with 2-Column Layout -->
      <div style="background-color: rgba(42, 63, 79, 0.4);" class="shadow-xl p-6 md:p-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">

          <!-- Left Column: Rotating Gallery Photos -->
          <div class="relative h-96 overflow-hidden rounded-lg">
            <div id="about-gallery" class="w-full h-full relative">
              <img src="/assets/lifestyleimages/20251001_1034_Joyful Moment Together_simple_compose_01k6gdah5ef7n9mj7hyscbm439.png" alt="Gallery 1" class="gallery-image absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 opacity-100" />
              <img src="/assets/lifestyleimages/20251001_1020_Energy Unleashed_simple_compose_01k6gd9xt3hptdtzh6tc8dbb3n.png" alt="Gallery 2" class="gallery-image absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 opacity-0" />
              <img src="/assets/lifestyleimages/20251001_1031_Nature's Bliss_simple_compose_01k6gda67t89fmnkr40g5jq9t9.png" alt="Gallery 3" class="gallery-image absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 opacity-0" />
              <img src="/assets/lifestyleimages/20251001_1029_Natural Radiance_simple_compose_01k6gda2sdndmbgm0jhb0ajjqf.png" alt="Gallery 4" class="gallery-image absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 opacity-0" />
            </div>
          </div>

          <!-- Right Column: About Text (Right Aligned) -->
          <div class="text-right">
            <h3 class="text-xl font-bold mb-4 text-white uppercase">
              About {storeName}
            </h3>
            <p class="text-base leading-relaxed" style="color: #d4f4e1;">
              {storeLongDescription}
            </p>
          </div>

        </div>
      </div>

      <script>
        // Gallery rotation script
        document.addEventListener('DOMContentLoaded', () => {
          const images = document.querySelectorAll('#about-gallery .gallery-image');
          let currentIndex = 0;

          function rotateGallery() {
            // Hide current image
            images[currentIndex].style.opacity = '0';

            // Move to next image
            currentIndex = (currentIndex + 1) % images.length;

            // Show next image
            images[currentIndex].style.opacity = '1';
          }

          // Rotate every 3 seconds
          setInterval(rotateGallery, 3000);
        });
      </script>

      <!-- Store Information Section - Above Footer -->
      <div style="background-color: rgba(42, 63, 79, 0.6);" class="shadow-xl p-6 md:p-10 mt-8">
        <div class="max-w-5xl mx-auto">
          <h2 class="text-3xl font-bold mb-8 text-white uppercase text-center">Visit Us</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

            <!-- Left Column: Contact & Location -->
            <div class="space-y-6">

              <!-- Address -->
              {(storeAddress || storeCity || storeState) && (
                <div class="bg-black/30 p-4 rounded-lg">
                  <h3 class="text-lg font-semibold text-yellow-400 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Address
                  </h3>
                  <p class="text-white mb-2">
                    {storeAddress && <span>{storeAddress}<br /></span>}
                    {storeCity && <span>{storeCity}, </span>}
                    {storeState && <span>{storeState} </span>}
                    {storeZip && <span>{storeZip}</span>}
                  </p>
                  {mapsUrl && (
                    <a
                      href={mapsUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center text-white hover:text-yellow-400 font-semibold"
                    >
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                      </svg>
                      Get Driving Directions ‚Üí
                    </a>
                  )}
                </div>
              )}

              <!-- Phone -->
              {storePhone && (
                <div class="bg-black/30 p-4 rounded-lg">
                  <h3 class="text-lg font-semibold text-yellow-400 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    Phone
                  </h3>
                  <a href={`tel:${storePhone}`} class="text-white hover:text-yellow-400 text-lg">
                    {storePhone}
                  </a>
                </div>
              )}

              <!-- Email -->
              {storeEmail && (
                <div class="bg-black/30 p-4 rounded-lg">
                  <h3 class="text-lg font-semibold text-yellow-400 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Email
                  </h3>
                  <a href={`mailto:${storeEmail}`} class="text-white hover:text-yellow-400">
                    {storeEmail}
                  </a>
                </div>
              )}

            </div>

            <!-- Right Column: Store Hours -->
            <div class="bg-black/30 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-yellow-400 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Store Hours
              </h3>

              <!-- Countdown Timer -->
              <div id="countdown-timer" class="mb-4 text-center py-2 bg-black/40 rounded"></div>

              <!-- Hours List -->
              <div class="space-y-2">
                {store?.hours && store.hours.length > 0 ? (
                  store.hours.map((hourEntry: any) => {
                    const dayName = hourEntry.dayOfWeek || '';
                    const isClosed = hourEntry.isClosed || false;
                    const is24Hour = hourEntry.is_24hour || false;
                    const openTime = hourEntry.openTime || '';
                    const closeTime = hourEntry.closeTime || '';

                    return (
                      <div
                        class="hour-row flex justify-between items-center py-2 px-3 rounded transition-all duration-200"
                        data-day={dayName}
                      >
                        <span class="day-name text-mint-green font-medium">
                          {dayName}
                          <span class="today-label hidden ml-2 text-xs"></span>
                        </span>
                        <span class="time-display text-white">
                          {isClosed ? (
                            <span class="text-red-400">Closed</span>
                          ) : is24Hour ? (
                            <span class="text-green-400">Open 24 Hours</span>
                          ) : (
                            <span>{openTime} - {closeTime}</span>
                          )}
                        </span>
                      </div>
                    );
                  })
                ) : (
                  <p class="text-white text-center py-4">Hours not available</p>
                )}
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Back Link -->
      <div class="mt-12 text-center px-4 md:px-0">
        <a
          href="/regions"
          class="text-yellow-400 hover:text-yellow-300 underline"
        >
          ‚Üê Back to All Locations
        </a>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ storeHours: store?.hours || [] }}>
    // Highlight today's hours
    function highlightTodaysHours() {
      const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      const now = new Date();
      const today = dayNames[now.getDay()];

      // Find all hour rows
      const hourRows = document.querySelectorAll('.hour-row');

      hourRows.forEach(row => {
        const dayAttr = row.getAttribute('data-day');
        if (dayAttr && dayAttr.toLowerCase() === today) {
          // Highlight today's row
          row.classList.add('bg-yellow-400/20', 'border-l-4', 'border-yellow-400');

          // Update day name styling
          const dayNameEl = row.querySelector('.day-name');
          if (dayNameEl) {
            dayNameEl.classList.remove('text-mint-green');
            dayNameEl.classList.add('text-yellow-400', 'font-bold');

            // Show "Today" label
            const todayLabel = dayNameEl.querySelector('.today-label');
            if (todayLabel) {
              todayLabel.textContent = '(Today)';
              todayLabel.classList.remove('hidden');
            }
          }

          // Update time display styling
          const timeDisplayEl = row.querySelector('.time-display');
          if (timeDisplayEl) {
            timeDisplayEl.style.color = '#6b7280';
            timeDisplayEl.classList.add('text-yellow-300');
          }
        }
      });
    }

    function updateCountdown() {
      const countdownEl = document.getElementById('countdown-timer');
      if (!countdownEl || !storeHours || storeHours.length === 0) return;

      const now = new Date();
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const currentDay = dayNames[now.getDay()];

      // Find today's hours
      const todayHours = storeHours.find(h => h.dayOfWeek?.toLowerCase() === currentDay.toLowerCase());

      if (!todayHours) {
        countdownEl.textContent = 'Hours not available';
        return;
      }

      if (todayHours.isClosed) {
        countdownEl.innerHTML = '<span class="text-red-400">‚≠ï Closed Today</span>';
        return;
      }

      if (todayHours.is_24hour) {
        countdownEl.innerHTML = '<span class="text-green-400">‚úÖ Open 24 Hours</span>';
        return;
      }

      // Parse closing time
      const closeTime = todayHours.closeTime;
      if (!closeTime) {
        countdownEl.textContent = '';
        return;
      }

      // Parse time (assuming format like "9:00 PM" or "21:00")
      const timeParts = closeTime.match(/(\d+):(\d+)\s*(AM|PM)?/i);
      if (!timeParts) {
        countdownEl.textContent = '';
        return;
      }

      let hours = parseInt(timeParts[1]);
      const minutes = parseInt(timeParts[2]);
      const period = timeParts[3]?.toUpperCase();

      // Convert to 24-hour format
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;

      const closeDate = new Date();
      closeDate.setHours(hours, minutes, 0, 0);

      // If close time is before current time, assume it's tomorrow
      if (closeDate < now) {
        closeDate.setDate(closeDate.getDate() + 1);
      }

      const diff = closeDate - now;

      if (diff < 0) {
        countdownEl.innerHTML = '<span class="text-red-400">‚≠ï Closed</span>';
        return;
      }

      const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
      const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secondsLeft = Math.floor((diff % (1000 * 60)) / 1000);

      if (diff < 3600000) { // Less than 1 hour
        countdownEl.innerHTML = `<span class="text-yellow-400 font-semibold">‚ö†Ô∏è Closing soon: ${minutesLeft}m ${secondsLeft}s</span>`;
      } else if (diff < 7200000) { // Less than 2 hours
        countdownEl.innerHTML = `<span class="text-yellow-400">‚è∞ Closes in: ${hoursLeft}h ${minutesLeft}m</span>`;
      } else {
        countdownEl.innerHTML = `<span class="text-green-400">‚úÖ Open - Closes in: ${hoursLeft}h ${minutesLeft}m</span>`;
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      highlightTodaysHours();
      updateCountdown();
      setInterval(updateCountdown, 1000);
    });

    // Also run immediately in case DOMContentLoaded already fired
    if (document.readyState === 'loading') {
      // DOMContentLoaded has not fired yet
    } else {
      // DOMContentLoaded has already fired
      highlightTodaysHours();
      updateCountdown();
      setInterval(updateCountdown, 1000);
    }
  </script>

  <!-- Banner Carousel Script -->
  <script is:inline define:vars={{ bannerCount: banners.length }}>
    if (bannerCount > 1) {
      let currentSlide = 0;
      const slides = document.getElementById('bannerSlides');
      const prevBtn = document.getElementById('bannerPrev');
      const nextBtn = document.getElementById('bannerNext');
      const dots = document.querySelectorAll('.banner-dot');

      function updateCarousel() {
        if (slides) {
          slides.style.transform = `translateX(-${currentSlide * 100}%)`;
        }

        // Update dots
        dots.forEach((dot, index) => {
          if (index === currentSlide) {
            dot.classList.add('active');
          } else {
            dot.classList.remove('active');
          }
        });
      }

      function nextSlide() {
        currentSlide = (currentSlide + 1) % bannerCount;
        updateCarousel();
      }

      function prevSlide() {
        currentSlide = (currentSlide - 1 + bannerCount) % bannerCount;
        updateCarousel();
      }

      function goToSlide(index) {
        currentSlide = index;
        updateCarousel();
      }

      // Event listeners
      if (nextBtn) {
        nextBtn.addEventListener('click', nextSlide);
      }
      if (prevBtn) {
        prevBtn.addEventListener('click', prevSlide);
      }

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => goToSlide(index));
      });

      // Auto-advance carousel every 5 seconds
      setInterval(nextSlide, 5000);
    }
  </script>

  <!-- Google Maps API for fetching ratings -->
  <script is:inline>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
      key: "AIzaSyDl5xx_mgt89hCcjRgbfM_qLfJrCDJUdJw",
      v: "weekly"
    });
  </script>

  <!-- Google Ratings Script -->
  <script is:inline>
    async function loadGoogleRatings() {
      try {
        if (typeof google === 'undefined') return;

        const { Place } = await google.maps.importLibrary("places");
        const ratingElements = document.querySelectorAll('.store-rating');

        for (let i = 0; i < ratingElements.length; i++) {
          const element = ratingElements[i];
          const placeId = element.getAttribute('data-place-id');

          if (!placeId) continue;

          try {
            const place = new Place({ id: placeId });
            await place.fetchFields({ fields: ['rating', 'userRatingCount'] });

            if (place.rating) {
              const rating = place.rating;
              const totalReviews = place.userRatingCount || 0;

              element.innerHTML = `
                <a href="https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${placeId}"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="flex items-center gap-1 text-yellow-400 hover:text-yellow-300 transition-colors font-semibold text-lg"
                   title="View on Google Maps"
                   style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">
                  <span>‚≠ê ${rating}</span>
                  <span class="text-sm text-gray-200">(${totalReviews})</span>
                </a>
              `;
            } else {
              element.innerHTML = '';
            }
          } catch (error) {
            console.error('Error fetching rating:', error);
            element.innerHTML = '';
          }
        }
      } catch (error) {
        console.error('Error loading Google ratings:', error);
        document.querySelectorAll('.store-rating .loading-text').forEach(el => {
          el.style.display = 'none';
        });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadGoogleRatings);
    } else {
      loadGoogleRatings();
    }

    document.addEventListener('astro:page-load', loadGoogleRatings);
  </script>

  </div> <!-- Close content-wrapper -->

</Layout>
