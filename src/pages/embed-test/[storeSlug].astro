---
import Layout from '../../layouts/Layout.astro';

export const prerender = true;

export async function getStaticPaths() {
  const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

  try {
    const response = await fetch(`${API_BASE}/stores?populate=*&pagination[pageSize]=100`);
    const data = await response.json();

    if (data?.data && Array.isArray(data.data)) {
      return data.data.map((store: any) => {
        // The API returns a flat structure, not nested under attributes
        const slug = store.slug || store.Slug || store.documentId;
        const name = store.name || store.Name || 'Store';
        const dutchieStoreId = store.DutchieStoreID || store.dutchieStoreId || store.dutchie_store_id;

        console.log(`ðŸ“ Building path for ${name}: DutchieID = ${dutchieStoreId || 'NOT FOUND'}`);

        return {
          params: { storeSlug: slug },
          props: {
            storeName: name,
            dutchieStoreId: dutchieStoreId,
            slug: slug,
            storeId: store.documentId || store.id
          }
        };
      });
    }
  } catch (error) {
    console.error('Error fetching stores:', error);
  }

  return [];
}

const { storeName, dutchieStoreId, slug, storeId } = Astro.props;

// Debug: Log what props we received
console.log(`ðŸŽ¯ Page Props for ${storeName}:`);
console.log(`   - dutchieStoreId: ${dutchieStoreId}`);
console.log(`   - slug: ${slug}`);
console.log(`   - storeId: ${storeId}`);

// If no Dutchie store ID is available, show an error
const hasValidDutchieId = dutchieStoreId && dutchieStoreId !== '';
console.log(`   - hasValidDutchieId: ${hasValidDutchieId}`);

// Fetch carousels for this store
let carousels = [];
if (hasValidDutchieId && storeId) {
  try {
    const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';
    const carouselsResponse = await fetch(`${API_BASE}/store-carousels?filters[store][documentId][$eq]=${storeId}&filters[is_active][$eq]=true&sort=order:asc&populate=*`);
    const carouselsData = await carouselsResponse.json();

    if (carouselsData?.data && Array.isArray(carouselsData.data)) {
      carousels = carouselsData.data.map((carousel: any) => ({
        name: carousel.name || carousel.Name || 'Carousel',
        dutchie_carousel_id: carousel.dutchie_carousel_id || carousel.dutchieCarouselId,
        full_embed_script: carousel.full_embed_script || carousel.fullEmbedScript,
        order: carousel.order || 0
      })).filter(c => c.dutchie_carousel_id || c.full_embed_script); // Include if has either ID or full script

      console.log(`ðŸŽ  Found ${carousels.length} active carousels for ${storeName}`);
    }
  } catch (error) {
    console.error('Error fetching carousels:', error);
  }
}
---

<Layout
  title={`${storeName} - Dutchie Embed Test - Mint Deals`}
  description={`Testing multiple Dutchie carousel embeds for ${storeName}`}
>
  <div class="min-h-screen bg-black">
    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-gray-900 to-black py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 uppercase">
            {storeName}
          </h1>
          <p class="text-xl text-gray-300 mb-4">
            Dutchie Embed Test
          </p>
          {hasValidDutchieId ? (
            <p class="text-sm text-green-400">
              Store ID: {dutchieStoreId}
            </p>
          ) : (
            <p class="text-sm text-red-400">
              No Dutchie Store ID configured
            </p>
          )}
        </div>
      </div>
    </section>

    {hasValidDutchieId ? (
      <>
        {carousels.length > 0 ? (
          carousels.map((carousel, index) => (
            <>
              <!-- Carousel Section -->
              <section class="py-16 bg-gray-900">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <h2 class="text-3xl font-bold text-white mb-8 uppercase text-center">
                    {carousel.name}
                  </h2>
                  <div class="bg-black rounded-lg p-4">
                    <div
                      id={`dutchie-carousel-container-${carousel.dutchie_carousel_id || index}`}
                      data-store-id={dutchieStoreId}
                      data-carousel-id={carousel.dutchie_carousel_id}
                      data-slug={slug}
                      data-full-script={carousel.full_embed_script || ''}
                    ></div>
                  </div>
                </div>
              </section>

              <!-- Banner Section (shown between carousels, but not after the last one) -->
              {index < carousels.length - 1 && (
                <section class="py-16 bg-black">
                  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class={`relative overflow-hidden rounded-lg bg-gradient-to-r ${index % 2 === 0 ? 'from-green-600 to-green-800' : 'from-yellow-500 to-yellow-600'} p-12 text-center`}>
                      <div class="relative z-10">
                        <h3 class="text-4xl font-bold text-white mb-4">
                          {index % 2 === 0 ? 'Special Offers Available' : 'New Arrivals'}
                        </h3>
                        <p class="text-xl text-white mb-6">
                          {index % 2 === 0 ? 'Check out our latest deals and promotions' : 'Discover our latest premium products'}
                        </p>
                        <a
                          href={index % 2 === 0 ? '/deals' : '/categories'}
                          class={`inline-block bg-white ${index % 2 === 0 ? 'text-green-600' : 'text-yellow-600'} font-bold py-3 px-8 rounded-full hover:bg-gray-100 transition-colors duration-300`}
                        >
                          {index % 2 === 0 ? 'View Deals' : 'Browse Categories'}
                        </a>
                      </div>
                    </div>
                  </div>
                </section>
              )}
            </>
          ))
        ) : (
          <!-- No Carousels Configured -->
          <section class="py-16 bg-gray-900">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
              <div class="bg-yellow-900/40 rounded-lg p-8 text-center">
                <svg class="w-16 h-16 mx-auto mb-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-2xl font-bold text-white mb-4">No Carousels Configured</h3>
                <p class="text-yellow-200 mb-6">
                  This store has a Dutchie Store ID but no carousels have been added yet. Add carousels in the Strapi admin panel to display product showcases here.
                </p>
                <a href="/stores" class="inline-block bg-white text-yellow-600 font-bold py-3 px-8 rounded-lg hover:bg-gray-100 transition-colors duration-300">
                  View All Stores
                </a>
              </div>
            </div>
          </section>
        )}
      </>
    ) : (
      <section class="py-16 bg-gray-900">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="bg-red-900/40 rounded-lg p-8 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="text-2xl font-bold text-white mb-4">No Dutchie Store ID</h3>
            <p class="text-red-200 mb-6">
              This store does not have a Dutchie Store ID configured. Please add the DutchieStoreID field to the store in the CMS.
            </p>
            <a href="/stores" class="inline-block bg-white text-red-600 font-bold py-3 px-8 rounded-lg hover:bg-gray-100 transition-colors duration-300">
              View All Stores
            </a>
          </div>
        </div>
      </section>
    )}

    <!-- Footer CTA -->
    <section class="py-16 bg-black">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h3 class="text-3xl font-bold text-white mb-4">Ready to Shop?</h3>
        <p class="text-xl text-gray-300 mb-8">Visit one of our locations or browse online</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href={`/location/${slug}`} class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300">
            View Store Page
          </a>
          <a href="/stores" class="inline-block bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300">
            All Stores
          </a>
          <a href="/" class="inline-block bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300">
            Back to Home
          </a>
        </div>
      </div>
    </section>
  </div>
</Layout>

<script is:inline>
  // Dynamically load Dutchie carousel scripts
  document.addEventListener('DOMContentLoaded', () => {
    const containers = document.querySelectorAll('[id^="dutchie-carousel-container-"]');
    console.log(`Found ${containers.length} carousel containers to load`);

    containers.forEach((container, index) => {
      const fullScript = container.getAttribute('data-full-script');

      // Check if we have a full embed script
      if (fullScript && fullScript.trim() !== '') {
        console.log(`Using full embed script for carousel ${index + 1}`);

        // Parse the full script to extract the script tag
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = fullScript;
        const scriptTag = tempDiv.querySelector('script');

        if (scriptTag) {
          // Create a new script element with the same attributes
          const script = document.createElement('script');
          script.async = scriptTag.async;
          script.id = scriptTag.id;
          script.src = scriptTag.src;

          // Add script to container
          container.appendChild(script);
          console.log(`Full embed script loaded: ${scriptTag.src}`);
        } else {
          console.error(`Could not parse script from full_embed_script for carousel ${index + 1}`);
        }
      } else {
        // Fallback to constructing script from individual fields
        const storeId = container.getAttribute('data-store-id');
        const carouselId = container.getAttribute('data-carousel-id');
        const slug = container.getAttribute('data-slug');

        if (storeId && carouselId) {
          console.log(`Constructing carousel script ${index + 1}: ${carouselId} for store ${storeId}`);

          // Create script element
          const script = document.createElement('script');
          script.async = true;
          script.id = `dutchie--carousel-embed-${carouselId}__script`;
          script.src = `https://dutchie.com/api/v3/embedded-menu/${storeId}/carousels/${carouselId}.js?routeRoot=https%3A%2F%2Fmintdeals.com%2Fembed-test%2F${slug}%2F`;

          // Add script to container
          container.appendChild(script);

          console.log(`Script added for carousel ${carouselId}`);
        } else {
          console.error(`Missing data attributes for container ${index + 1}`);
        }
      }
    });

    // Check if widgets loaded after 3 seconds
    setTimeout(() => {
      const widgets = document.querySelectorAll('[id^="dutchie--carousel-embed"]');
      console.log(`Dutchie widgets rendered: ${widgets.length}`);
    }, 3000);
  });
</script>
