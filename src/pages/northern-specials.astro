---
export const prerender = true;

import Layout from '../layouts/Layout.astro';

// Dutchie API configuration
const DUTCHIE_API_URL = 'https://plus.dutchie.com/plus/2021-07/graphql';
const DUTCHIE_API_KEY = 'public-eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJBUEktQ0xJRU5UIiwiZXhwIjozMzI4NzcyNTY2OCwiaWF0IjoxNzMwODE2ODY4LCJpc3MiOiJodHRwczovL2R1dGNoaWUuY29tIiwianRpIjoiNzFmYjcyYjItMThmNy00OWE0LTkwYjgtYjVjMDY0NWZhMjZlIiwiZW50ZXJwcmlzZV9pZCI6IjQ1ODZkZmZkLTVmOTEtNGUxZi04OThhLWJmMjMzMjQ4MzBjMSIsInV1aWQiOiJhNzM4MGE0MC1iMmM5LTQ2ZDktOWY5My1jZTEwM2JjZGM0MjkifQ.XZyCX1ZrNy75e3RcqukMUPffIqxEBnWUZ_o52V4VGco';

// Initialize data
let specialProducts = [];
let apiError = null;
let stores = [];
let northernStoreId = null;

// GraphQL query to fetch products on special
const SPECIALS_QUERY = `
  query GetSpecialProducts($retailerId: ID!) {
    menu(retailerId: $retailerId) {
      products {
        id
        name
        brand {
          name
        }
        category
        subcategory
        image
        description
        potencyCbd {
          formatted
        }
        potencyThc {
          formatted
        }
        variants {
          id
          option
          priceRec
          specialPriceRec
          quantity
        }
      }
    }
  }
`;

// Category icon mapping
function getCategoryIcon(category) {
  const icons = {
    'FLOWER': 'üåø',
    'PRE_ROLLS': 'üö¨',
    'VAPORIZERS': 'üí®',
    'CONCENTRATES': 'üçØ',
    'EDIBLES': 'üç≠',
    'TOPICALS': 'üß¥',
    'CARTRIDGES': 'üñäÔ∏è',
    'TINCTURES': 'üíß',
    'ACCESSORIES': 'üîß',
    'CBD': 'üå±'
  };
  return icons[category] || 'üåø';
}

// Calculate discount percentage
function calculateDiscount(regular, special) {
  if (!regular || !special || special >= regular) return 0;
  return Math.round(((regular - special) / regular) * 100);
}

// Format price
function formatPrice(price) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2
  }).format(price / 100);
}

// Fetch stores to find the northern store's Dutchie ID
const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

try {
  console.log('üöÄ Fetching stores to find Northern store Dutchie ID');

  // Fetch stores from Railway API
  const storesResponse = await fetch(`${API_BASE}/stores?populate=*&pagination[pageSize]=100`);
  if (storesResponse.ok) {
    const storesData = await storesResponse.json();
    stores = storesData?.data || [];

    // Find the northern store by checking for "northern" in the name
    const northernStore = stores.find(store =>
      store.name?.toLowerCase().includes('northern') ||
      store.Name?.toLowerCase().includes('northern') ||
      store.slug?.toLowerCase().includes('northern')
    );

    if (northernStore) {
      // Look for various possible field names for the Dutchie store ID
      northernStoreId = northernStore.dutchiestoreid ||
                       northernStore.dutchie_store_id ||
                       northernStore.dutchie_retailer_id ||
                       northernStore.dutchie_id ||
                       northernStore.retailer_id;

      console.log('üè™ Found Northern store:', northernStore.name || northernStore.Name);
      console.log('üîç Northern store Dutchie ID:', northernStoreId);
      console.log('üóÇÔ∏è Northern store fields:', Object.keys(northernStore));
    } else {
      console.log('‚ö†Ô∏è Northern store not found in API response');
      console.log('üè™ Available stores:', stores.map(s => s.name || s.Name));
    }

    console.log('‚úÖ Stores loaded:', stores.length);
  }
} catch (error) {
  console.error('‚ùå Error fetching stores:', error);
  apiError = `Store fetch error: ${error.message}`;
}

// Fetch special products from Dutchie API
if (northernStoreId) {
  try {
    console.log('üöÄ Fetching special products from Dutchie API for Northern store');

    const requestBody = {
      query: SPECIALS_QUERY,
      variables: {
        retailerId: northernStoreId
      }
    };

    console.log('üîç Request body:', JSON.stringify(requestBody, null, 2));

    const response = await fetch(DUTCHIE_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${DUTCHIE_API_KEY}`,
      },
      body: JSON.stringify(requestBody)
    });

    console.log('üì° Response status:', response.status);
    const responseText = await response.text();
    console.log('üì° Response body:', responseText.substring(0, 500) + '...');

    if (response.ok) {
      const data = JSON.parse(responseText);

      if (data.errors) {
        console.error('‚ùå GraphQL Errors:', data.errors);
        apiError = `GraphQL Error: ${data.errors.map(e => e.message).join(', ')}`;
        throw new Error('GraphQL Error: Using fallback data');
      } else if (data.data?.menu?.products) {
        // Filter products that have special prices
        specialProducts = data.data.menu.products.filter(product => {
          return product.variants?.some(v => v.specialPriceRec && v.specialPriceRec !== v.priceRec);
        });

        console.log(`‚úÖ ${specialProducts.length} special products loaded from Northern store`);
      } else {
        console.log('‚ùå No products found in response');
        apiError = 'No products found in API response';
      }
    } else {
      console.error('‚ùå Dutchie API Error:', response.status, responseText);
      apiError = `API Error: ${response.status} - ${responseText}`;
    }
  } catch (error) {
    console.error('‚ùå Error fetching special products:', error);
    apiError = error.message;
  }
} else {
  apiError = 'Northern store Dutchie ID not found';
  console.log('‚ùå No Northern store Dutchie ID found, using fallback data');
}

// Fallback data if API fails or no Northern store ID
if (specialProducts.length === 0) {
  specialProducts = [
    {
      id: '1',
      name: 'Blue Dream',
      brand: { name: 'Mint Cannabis Northern' },
      category: 'FLOWER',
      subcategory: 'Sativa',
      description: 'A classic sativa-dominant hybrid with a sweet berry aroma - Northern Ave exclusive',
      image: 'https://images.dutchie.com/generic/flower.jpg',
      potencyThc: { formatted: '22.5%' },
      potencyCbd: { formatted: '0.1%' },
      variants: [
        {
          id: 'v1',
          option: '3.5g',
          priceRec: 5500,
          specialPriceRec: 4000,
          quantity: 3.5
        }
      ]
    },
    {
      id: '2',
      name: 'Northern Lights',
      brand: { name: 'Mint Cannabis Northern' },
      category: 'FLOWER',
      subcategory: 'Indica',
      description: 'Classic indica strain perfect for relaxation - Exclusive to Northern Ave location',
      image: 'https://images.dutchie.com/generic/flower.jpg',
      potencyThc: { formatted: '25.0%' },
      potencyCbd: { formatted: '0.2%' },
      variants: [
        {
          id: 'v2',
          option: '7g',
          priceRec: 10000,
          specialPriceRec: 7000,
          quantity: 7
        }
      ]
    },
    {
      id: '3',
      name: 'Northern Berry Gummies',
      brand: { name: 'Mint Edibles Northern' },
      category: 'EDIBLES',
      subcategory: 'Gummies',
      description: 'Delicious berry gummies with precise dosing - Northern Ave special',
      image: 'https://images.dutchie.com/generic/edibles.jpg',
      potencyThc: { formatted: '100mg' },
      potencyCbd: { formatted: '0mg' },
      variants: [
        {
          id: 'v3',
          option: '10 pack',
          priceRec: 3500,
          specialPriceRec: 2000,
          quantity: 10
        }
      ]
    }
  ];

  if (!apiError) {
    apiError = 'Using sample Northern store products';
  }
}
---

<style>
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.4));
  }
  .hero-section {
    min-height: 7.5vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
  }

  @media (min-width: 768px) {
    .hero-section {
      min-height: 30vh;
      padding: 1rem 0;
    }
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .discount-badge {
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
</style>

<Layout title="Northern Ave Special Deals - Mint Cannabis" description="Discover amazing deals and special offers on premium cannabis products at Mint Cannabis Northern Avenue location.">
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Hero Section -->
    <div class="text-white hero-section">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-[2080px]">
        <div class="text-center">
          <h1 class="mb-4 text-4xl font-bold text-white md:text-6xl drop-shadow-2xl">
            üî• Northern Ave Specials
          </h1>
          <p class="max-w-2xl mx-auto mb-2 text-lg text-yellow-400 md:text-xl drop-shadow-lg">
            Exclusive deals from our Northern Avenue location
          </p>
          <p class="max-w-2xl mx-auto mb-6 text-sm text-green-300 drop-shadow-lg">
            2444 W Northern Ave, Phoenix, AZ
          </p>
          <div class="flex flex-wrap justify-center gap-4">
            <a href="/" class="px-6 py-2.5 text-base font-semibold text-black transition-all transform rounded-lg shadow-lg bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 hover:scale-105">
              üè† Back to Home
            </a>
            <a href="/stores" class="px-6 py-2.5 text-base font-semibold text-white transition-all transform rounded-lg shadow-lg bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 hover:scale-105">
              üìç All Locations
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats Bar -->
    <div class="bg-gradient-to-r from-blue-800 via-blue-900 to-blue-800 py-2">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-[2080px]">
        <div class="grid grid-cols-2 gap-6 text-center md:grid-cols-4">
          <div class="text-white">
            <div class="text-xl font-bold text-yellow-400">{specialProducts.length}+</div>
            <div class="text-xs text-blue-200">Northern Specials</div>
          </div>
          <div class="text-white">
            <div class="text-xl font-bold text-yellow-400">Up to 40%</div>
            <div class="text-xs text-blue-200">Off Regular Price</div>
          </div>
          <div class="text-white">
            <div class="text-xl font-bold text-yellow-400">Daily</div>
            <div class="text-xs text-blue-200">Fresh Updates</div>
          </div>
          <div class="text-white">
            <div class="text-xl font-bold text-yellow-400">Northern</div>
            <div class="text-xs text-blue-200">Avenue Exclusive</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Info (visible in development) -->
    {apiError && (
      <div class="bg-blue-900/50 border border-blue-500 text-blue-200 px-6 py-4 mx-4 mt-4 rounded-xl">
        <h3 class="font-semibold mb-2">üîß Development Info:</h3>
        <p class="text-sm mb-2"><strong>Status:</strong> {apiError}</p>
        <p class="text-sm mb-2"><strong>Northern Store ID:</strong> {northernStoreId || 'Not found'}</p>
        <p class="text-sm mb-2"><strong>Stores Found:</strong> {stores.length}</p>
        {northernStoreId ? (
          <p class="text-sm text-green-300">‚úÖ Using Northern store Dutchie ID: {northernStoreId}</p>
        ) : (
          <p class="text-sm text-yellow-300">‚ö†Ô∏è Add 'dutchiestoreid' field to Northern store in backend</p>
        )}
      </div>
    )}

    <!-- Special Products Section -->
    <div class="bg-black py-12">
      <div class="px-4 mx-auto sm:px-6 lg:px-8 max-w-[2080px]">
        <!-- Section Header -->
        <div class="mb-8 text-center">
          <h2 class="text-3xl font-bold text-white md:text-4xl">
            Today's Northern Ave Specials
          </h2>
          <p class="mt-2 text-gray-400">
            {northernStoreId ? 'Live deals from our Northern Avenue location' : 'Sample products - add Dutchie ID to see live deals'}
          </p>
        </div>

        <!-- Products Grid -->
        {specialProducts.length === 0 ? (
          <div class="py-16 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4 bg-gray-800 rounded-full">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="mb-2 text-xl font-medium text-white">No Special Deals Available</h3>
            <p class="text-gray-400">
              {apiError ? `Error: ${apiError}` : 'Check back soon for amazing deals from Northern Ave!'}
            </p>
          </div>
        ) : (
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            {specialProducts.map(product => {
              const bestVariant = product.variants?.find(v => v.specialPriceRec) || product.variants?.[0];
              const discount = bestVariant ? calculateDiscount(bestVariant.priceRec, bestVariant.specialPriceRec) : 0;

              return (
                <div class="relative overflow-hidden transition-all transform bg-gray-900 border border-blue-500 rounded-lg shadow-lg hover:scale-105 hover:shadow-2xl group">
                  {/* Discount Badge */}
                  {discount > 0 && (
                    <div class="absolute top-2 right-2 z-10 px-3 py-1 text-xs font-bold text-black bg-yellow-400 rounded-full discount-badge">
                      {discount}% OFF
                    </div>
                  )}

                  {/* Northern Exclusive Badge */}
                  <div class="absolute top-2 left-2 z-10 px-2 py-1 text-xs font-bold text-white bg-blue-600 rounded-full">
                    Northern Ave
                  </div>

                  {/* Product Image */}
                  <div class="relative h-48 overflow-hidden bg-gray-800">
                    {product.image ? (
                      <img
                        src={product.image}
                        alt={product.name}
                        class="object-cover w-full h-full transition-transform group-hover:scale-110"
                      />
                    ) : (
                      <div class="flex items-center justify-center w-full h-full">
                        <span class="text-6xl">{getCategoryIcon(product.category)}</span>
                      </div>
                    )}
                  </div>

                  {/* Product Info */}
                  <div class="p-6">
                    {/* Brand & Category */}
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-blue-400">
                        {product.brand?.name || 'Mint Cannabis Northern'}
                      </span>
                      <span class="px-2 py-1 text-xs text-blue-200 bg-blue-900 rounded-full">
                        {product.subcategory || product.category}
                      </span>
                    </div>

                    {/* Product Name */}
                    <h3 class="mb-2 text-lg font-bold text-white">
                      {product.name}
                    </h3>

                    {/* Description */}
                    {product.description && (
                      <p class="mb-3 text-sm text-gray-400 line-clamp-2">
                        {product.description}
                      </p>
                    )}

                    {/* Potency */}
                    {(product.potencyThc || product.potencyCbd) && (
                      <div class="flex gap-3 mb-3">
                        {product.potencyThc && (
                          <span class="text-xs text-yellow-400">
                            THC: {product.potencyThc.formatted}
                          </span>
                        )}
                        {product.potencyCbd && (
                          <span class="text-xs text-blue-400">
                            CBD: {product.potencyCbd.formatted}
                          </span>
                        )}
                      </div>
                    )}

                    {/* Variants & Pricing */}
                    {bestVariant && (
                      <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-sm text-gray-400">
                            {bestVariant.option}
                          </span>
                          <div class="flex items-center gap-2">
                            {bestVariant.specialPriceRec && bestVariant.priceRec > bestVariant.specialPriceRec && (
                              <span class="text-sm text-gray-500 line-through">
                                {formatPrice(bestVariant.priceRec)}
                              </span>
                            )}
                            <span class="text-lg font-bold text-blue-400">
                              {formatPrice(bestVariant.specialPriceRec || bestVariant.priceRec)}
                            </span>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Action Buttons */}
                    <div class="flex gap-2">
                      <button class="flex-1 px-4 py-2 font-medium text-black transition-colors bg-yellow-500 rounded-lg hover:bg-yellow-600">
                        View Deal
                      </button>
                      <a href="/location/mint-cannabis-northern-ave" class="px-4 py-2 font-medium text-white transition-colors bg-blue-600 rounded-lg hover:bg-blue-700">
                        Visit Store
                      </a>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* Load More Button */}
        {specialProducts.length > 0 && (
          <div class="mt-12 text-center">
            <button class="px-8 py-3 font-semibold text-black transition-all transform bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg shadow-lg hover:from-yellow-500 hover:to-yellow-600 hover:scale-105">
              Load More Northern Deals
            </button>
          </div>
        )}
      </div>
    </div>

    <!-- Location Info Section -->
    <div class="bg-gradient-to-br from-blue-900 via-black to-blue-800 py-16">
      <div class="px-4 mx-auto text-center sm:px-6 lg:px-8 max-w-[2080px]">
        <h2 class="mb-4 text-3xl font-bold text-white md:text-4xl">
          üè™ Northern Avenue Location
        </h2>
        <p class="max-w-2xl mx-auto mb-6 text-lg text-gray-300">
          Visit our Northern Avenue dispensary for these exclusive deals and premium cannabis products.
        </p>
        <div class="bg-gray-900/50 rounded-2xl p-8 max-w-md mx-auto mb-8">
          <h3 class="text-xl font-bold text-white mb-4">Store Details</h3>
          <div class="text-left space-y-3">
            <div class="flex items-center text-gray-300">
              <svg class="w-5 h-5 mr-3 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
              </svg>
              <div>
                <div class="font-medium">2444 W Northern Ave</div>
                <div class="text-sm text-gray-400">Phoenix, AZ</div>
              </div>
            </div>
            <div class="flex items-center text-gray-300">
              <svg class="w-5 h-5 mr-3 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
              </svg>
              <a href="mailto:northern@mintdeals.com" class="hover:text-blue-400 transition-colors">
                northern@mintdeals.com
              </a>
            </div>
          </div>
        </div>
        <div class="flex flex-wrap justify-center gap-4">
          <a href="/location/mint-cannabis-northern-ave" class="px-8 py-3 font-semibold text-black transition-all transform bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-lg shadow-lg hover:from-yellow-500 hover:to-yellow-600 hover:scale-105">
            üè™ Store Details
          </a>
          <a href="/location/mint-cannabis-northern-ave/menu" class="px-8 py-3 font-semibold text-white transition-all transform bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg shadow-lg hover:from-blue-700 hover:to-blue-800 hover:scale-105">
            üçÉ Full Menu
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>