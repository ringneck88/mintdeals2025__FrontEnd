---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';
const { slug } = Astro.params;

// Helper function to safely extract string values
const getStringValue = (value, fallback = '') => {
  return typeof value === 'string' ? value : fallback;
};

// Fetch region data with stores
let region: any = null;
let stores: any[] = [];

try {
  // First, try to find region by slug with simple populate (complex syntax causes 400 errors)
  const regionResponse = await fetch(`${API_BASE}/regions?filters[slug][$eq]=${slug}&populate=*&pagination[pageSize]=100`);
  let regionData = await regionResponse.json();

  // If no region found by slug, try by name
  if (!regionData?.data || regionData.data.length === 0) {
    const nameToSearch = slug.replace(/-/g, ' ');
    const regionByNameResponse = await fetch(`${API_BASE}/regions?filters[name][$eqi]=${encodeURIComponent(nameToSearch)}&populate=*&pagination[pageSize]=100`);
    regionData = await regionByNameResponse.json();
  }

  if (regionData?.data && regionData.data.length > 0) {
    region = regionData.data[0];
    const basicStores = region.stores || [];

    console.log(`‚úÖ Region ${region.name}: ${basicStores.length} stores found`);

    // Fetch full region details individually to get Image field
    const regionId = region.documentId || region.id;
    const regionDetailResponse = await fetch(`${API_BASE}/regions/${regionId}?populate=*`);
    if (regionDetailResponse.ok) {
      const regionDetail = await regionDetailResponse.json();
      region = regionDetail.data;
      console.log(`üñºÔ∏è Image:`, region.Image ? 'exists' : 'missing');
    }

    // Fetch all stores with full details (including addresses)
    const storesResponse = await fetch(`${API_BASE}/stores?populate=*&pagination[pageSize]=200`);
    const storesData = await storesResponse.json();
    const storesMap = {};

    (storesData?.data || []).forEach(store => {
      storesMap[store.documentId || store.id] = store;
    });

    // Merge basic store data with full store details
    stores = basicStores.map(store => {
      const fullStore = storesMap[store.documentId || store.id];
      return fullStore || store;
    });

    console.log(`üì¶ Stores with address data: ${stores.filter(s => s.address).length}/${stores.length}`);
  }
} catch (error) {
  console.error('Error fetching region data:', error);
}

const regionName = region?.name || region?.Name || slug.replace(/-/g, ' ').replace(/\b\w/g, (l: string) => l.toUpperCase());
const regionDescription = region?.description || region?.Description || 'Discover premium cannabis dispensaries and products in the ' + regionName + ' area. Our trusted retail partners offer a carefully curated selection of high-quality cannabis products, expert guidance, and exceptional customer service. Whether you\'re a seasoned enthusiast or new to cannabis, you\'ll find knowledgeable staff ready to help you find the perfect products for your needs. Explore our locations to experience the best cannabis retail has to offer in ' + regionName + '.';

// Helper function to get image URL (same as used on home page)
function getImageUrl(imageData: any) {
  if (!imageData || imageData === null) return null;

  // Case 1: Strapi v4 nested structure: image.data.attributes.url
  if (imageData?.data?.attributes?.url) {
    const url = imageData.data.attributes.url;
    return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
  }

  // Case 2: Direct image object with formats (Cloudinary or Strapi uploaded images)
  if (typeof imageData === 'object' && imageData.formats) {
    // Prefer larger formats for better quality
    if (imageData.formats.large?.url) return imageData.formats.large.url;
    if (imageData.formats.medium?.url) return imageData.formats.medium.url;
    if (imageData.formats.small?.url) return imageData.formats.small.url;
    if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
  }

  // Case 3: Direct image object with url: image.url
  if (typeof imageData === 'object' && imageData.url) {
    const url = imageData.url;
    return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
  }

  // Case 4: String URL directly
  if (typeof imageData === 'string') {
    return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
  }

  return null;
}

// Try multiple possible image field names (matching home page logic)
const regionImageUrl = getImageUrl(region?.image)
  || getImageUrl(region?.Image)
  || getImageUrl(region?.IMAGE)
  || null;

// Fetch carousels for all stores in this region
let storeCarousels = new Map();
if (stores.length > 0) {
  try {
    const carouselsResponse = await fetch(`${API_BASE}/store-carousels?filters[is_active][$eq]=true&sort=order:asc&populate=store`);
    const carouselsData = await carouselsResponse.json();

    if (carouselsData?.data && Array.isArray(carouselsData.data)) {
      stores.forEach(store => {
        const storeDocId = store.documentId;
        const storeId = store.id;
        const dutchieStoreId = store.DutchieStoreID || store.dutchieStoreId || '';

        const storeCarouselList = carouselsData.data
          .filter((carousel: any) => {
            const carouselStore = carousel.store;
            if (!carouselStore) return false;
            return carouselStore.documentId === storeDocId || carouselStore.id === storeId;
          })
          .map((carousel: any) => ({
            name: carousel.name || carousel.Name || 'Carousel',
            dutchie_carousel_id: carousel.dutchie_carousel_id || carousel.dutchieCarouselId,
            full_embed_script: carousel.full_embed_script || carousel.fullEmbedScript,
            order: carousel.order || 0
          }))
          .filter(c => c.dutchie_carousel_id || c.full_embed_script);

        if (storeCarouselList.length > 0 && dutchieStoreId) {
          storeCarousels.set(store.slug, {
            carousel: storeCarouselList[0], // Only take the first carousel
            dutchieStoreId: dutchieStoreId,
            storeName: store.Name || store.name,
            city: getStringValue(store.address?.city) || getStringValue(store.City) || '',
            phone: getStringValue(store.Phone) || getStringValue(store.phone) || ''
          });
        }
      });

      console.log(`üé† Found carousels for ${storeCarousels.size} stores in ${regionName}`);
    }
  } catch (error) {
    console.error('Error fetching carousels:', error);
  }
}
---

<style>
  html {
    scroll-behavior: smooth;
  }
  body {
    margin: 0;
    padding: 0;
  }
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  .video-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(to top,  rgba(41, 163, 41, 0.35), rgba(51, 204, 51, 0.3), rgba(92, 214, 92, 0.25), rgba(133, 224, 133, 0.2), rgba(194, 240, 194, 0.15), rgba(235, 250, 235, 0.1), rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
    mix-blend-mode: color;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.4));
  }
  .hero-section {
    min-height: 7.5vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
  }

  .hero-section h1 {
    line-height: 1.2;
  }

  @media (min-width: 768px) {
    .hero-section {
      min-height: 30vh;
      padding: 1rem 0;
    }
  }

  /* Dutchie Carousel Styles */
  .dutchie-carousel-wrapper,
  [id^="dutchie-carousel-container-"],
  [id^="dutchie--carousel-embed"] {
    width: 100%;
    min-height: 500px;
  }
</style>

<Layout title={`${regionName} - Store Locations`} description={`Find Mint Cannabis dispensaries in ${regionName}`}>
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Hero Section -->
    <section class="relative py-8 text-white">
      <div class="absolute inset-0 bg-black opacity-40"></div>
      <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumb -->
        <nav class="mb-4 text-sm">
          <div class="flex items-center space-x-2">
            <a href="/" class="text-yellow-400 hover:text-yellow-300">Home</a>
            <span class="text-green-300">/</span>
            <a href="/regions" class="text-yellow-400 hover:text-yellow-300">Regions</a>
            <span class="text-green-300">/</span>
            <span class="text-white">{regionName}</span>
          </div>
        </nav>

        <!-- Region Info -->
        <div class="mb-4">
          <h1 class="text-3xl md:text-4xl font-bold mb-2 text-white uppercase">
            {regionName}
          </h1>
        </div>

        <!-- Store Images Carousel - Full Width -->
        <div class="w-full">
          {stores.length > 0 ? (
            <div class="relative w-full h-48 lg:h-[250px] rounded-lg overflow-hidden shadow-xl border border-black">
              <div id="region-hero-carousel" class="w-full h-full">
                {stores.map((store: any, index: number) => {
                  const storeImage = getImageUrl(store.hero_media) || getImageUrl(store.StoreImage) || getImageUrl(store.Image) || getImageUrl(store.image);
                  return (
                    <div
                      class={`carousel-slide absolute inset-0 transition-opacity duration-500 ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
                      data-index={index}
                    >
                      {storeImage ? (
                        <img
                          src={storeImage}
                          alt={store.Name || store.name}
                          class="w-full h-full object-cover"
                        />
                      ) : (
                        <div class="w-full h-full bg-gradient-to-br from-green-900 to-green-800 flex items-center justify-center">
                          <span class="text-8xl text-white">üè™</span>
                        </div>
                      )}
                      <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-6">
                        <p class="text-white font-bold text-xl">{store.Name || store.name}</p>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Navigation dots */}
              {stores.length > 1 && (
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-10">
                  {stores.map((_: any, index: number) => (
                    <button
                      class={`carousel-dot w-3 h-3 rounded-full transition-all ${index === 0 ? 'bg-yellow-400 w-8' : 'bg-white/50'}`}
                      data-index={index}
                      aria-label={`Go to slide ${index + 1}`}
                    ></button>
                  ))}
                </div>
              )}
            </div>
          ) : (
            <div class="w-full h-48 lg:h-[250px] bg-gradient-to-br from-green-900 to-green-800 rounded-lg shadow-xl border border-black flex items-center justify-center">
              <span class="text-6xl text-white">üìç</span>
            </div>
          )}
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <div class="bg-black py-16">
      <div class="w-full">

        <!-- Stores Section with Carousels -->
        {stores.length > 0 ? (
          <div id="stores-section">
            {stores.map((store: any) => {
              const storeSlug = store.slug;
              const storeData = storeCarousels.get(storeSlug);
              const storeName = store.Name || store.name;
              const storeAddress = getStringValue(store.address?.street) || getStringValue(store.Street) || '';
              const storeCity = getStringValue(store.address?.city) || getStringValue(store.City) || '';
              const storeState = getStringValue(store.address?.state) || getStringValue(store.State) || '';
              const storeZip = getStringValue(store.address?.zipCode) || getStringValue(store.Zip) || '';
              const storePhone = getStringValue(store.Phone) || getStringValue(store.phone) || '';
              const googlePlaceId = store.google_place_id || '';

              // Build Google Maps directions URL
              let directionsUrl = '';
              if (store.geo?.lat && store.geo?.lng) {
                directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${store.geo.lat},${store.geo.lng}`;
              } else if (storeAddress || storeCity) {
                const addressParts = [storeAddress, storeCity, storeState, storeZip].filter(part => part).join(', ');
                directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addressParts)}`;
              }

              return (
                <div class="mb-12 bg-gradient-to-br from-gray-900 to-black">
                  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <div class="flex flex-col gap-4">
                      <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                          <div class="flex items-center gap-3 mb-3">
                            <h3 class="text-2xl font-bold text-white uppercase">{storeName}</h3>
                            {googlePlaceId && (
                              <div
                                class="store-rating"
                                data-place-id={googlePlaceId}
                                data-store-slug={storeSlug}
                              >
                                <div class="flex items-center gap-1 text-sm">
                                  <span class="loading-text text-gray-400">Loading rating...</span>
                                </div>
                              </div>
                            )}
                          </div>
                          <div class="flex flex-col gap-3">
                            {(storeAddress || storeCity) && (
                              <p class="flex items-start text-white">
                                <svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span>
                                  {storeAddress && <>{storeAddress}<br /></>}
                                  {storeCity && storeState && storeZip && <>{storeCity}, {storeState}{' '}{storeZip}</>}
                                  {storeCity && !storeState && <>{storeCity}</>}
                                </span>
                              </p>
                            )}
                            {storePhone && (
                              <a href={`tel:${storePhone}`} class="flex items-center text-white hover:text-yellow-400">
                                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                {storePhone}
                              </a>
                            )}
                            {directionsUrl && (
                              <a href={directionsUrl} target="_blank" rel="noopener noreferrer" class="flex items-center text-white hover:text-yellow-400">
                                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                </svg>
                                Get Driving Directions
                              </a>
                            )}
                          </div>
                        </div>

                        <div class="flex-shrink-0">
                          <a
                            href={`/location/${storeSlug}`}
                            class="inline-flex items-center px-6 py-2 bg-green-500 text-white font-bold rounded-full hover:bg-green-600 transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 whitespace-nowrap"
                          >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Shop Full Menu
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>

                  {storeData && storeData.carousel && (
                    <>
                      <div class="carousel-loading-spinner bg-white py-16" data-carousel-spinner={storeSlug}>
                        <div class="flex flex-col items-center justify-center gap-4">
                          <div class="spinner-border animate-spin inline-block w-12 h-12 border-4 border-yellow-400 border-t-transparent rounded-full" role="status">
                            <span class="sr-only">Loading...</span>
                          </div>
                          <p class="text-gray-600 font-semibold">Loading products...</p>
                        </div>
                      </div>
                      <div class="bg-white carousel-container-wrapper" style="display: none;" data-carousel-index={storeSlug}>
                        <div class="p-6">
                          <div
                            id={`dutchie-carousel-container-${storeSlug}-${storeData.carousel.dutchie_carousel_id || 0}`}
                            data-store-id={storeData.dutchieStoreId}
                            data-carousel-id={storeData.carousel.dutchie_carousel_id}
                            data-slug={storeSlug}
                            data-full-script={storeData.carousel.full_embed_script || ''}
                            class="dutchie-carousel-wrapper"
                          ></div>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              );
            })}
          </div>
        ) : (
          <div class="py-12 text-center">
            <div class="max-w-md p-8 mx-auto bg-black rounded-lg">
              <h3 class="mb-2 text-lg font-medium text-white uppercase">No Locations Found</h3>
              <p class="text-green-300">No stores found in this region yet.</p>
            </div>
          </div>
        )}

        <!-- About This Region Section -->
        {regionDescription && (
          <div class="mt-12 mb-12 bg-gray-800 p-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              <h2 class="text-3xl font-bold mb-6 flex items-center text-white uppercase">
                <svg class="w-8 h-8 mr-3 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                About {regionName}
              </h2>
              <p class="text-white text-lg leading-relaxed">
                {regionDescription}
              </p>
            </div>
          </div>
        )}

        <!-- Back Button -->
        <div class="mt-12 mb-12 text-center">
          <a href="/regions" class="text-yellow-400 font-semibold hover:text-yellow-300 transition-colors">
            ‚Üê Back to All Regions
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<!-- Google Maps API for fetching ratings -->
<script is:inline>
  (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
    key: "AIzaSyDl5xx_mgt89hCcjRgbfM_qLfJrCDJUdJw",
    v: "weekly"
  });
</script>

<script>
  // Region Hero Carousel
  function initRegionHeroCarousel() {
    const carousel = document.getElementById('region-hero-carousel');
    if (!carousel) return;

    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = document.querySelectorAll('.carousel-dot');

    if (slides.length === 0) return;

    let currentIndex = 0;
    let autoplayInterval: number | null = null;

    function showSlide(index: number) {
      // Hide all slides
      slides.forEach((slide) => {
        slide.classList.remove('opacity-100');
        slide.classList.add('opacity-0');
      });

      // Update all dots
      dots.forEach((dot, i) => {
        if (i === index) {
          dot.classList.remove('bg-white/50', 'w-3');
          dot.classList.add('bg-yellow-400', 'w-8');
        } else {
          dot.classList.remove('bg-yellow-400', 'w-8');
          dot.classList.add('bg-white/50', 'w-3');
        }
      });

      // Show current slide
      slides[index].classList.remove('opacity-0');
      slides[index].classList.add('opacity-100');

      currentIndex = index;
    }

    function nextSlide() {
      const next = (currentIndex + 1) % slides.length;
      showSlide(next);
    }

    // Add click handlers to dots
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        showSlide(index);
        // Reset autoplay timer when manually navigating
        if (autoplayInterval) {
          clearInterval(autoplayInterval);
          autoplayInterval = setInterval(nextSlide, 4000);
        }
      });
    });

    // Start autoplay if there are multiple slides
    if (slides.length > 1) {
      autoplayInterval = setInterval(nextSlide, 4000);
    }

    // Pause on hover
    carousel.addEventListener('mouseenter', () => {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
        autoplayInterval = null;
      }
    });

    // Resume on mouse leave
    carousel.addEventListener('mouseleave', () => {
      if (slides.length > 1 && !autoplayInterval) {
        autoplayInterval = setInterval(nextSlide, 4000);
      }
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initRegionHeroCarousel);
  document.addEventListener('astro:page-load', initRegionHeroCarousel);
</script>

<!-- Google Ratings Script -->
<script is:inline>
  // Simple function to load Google ratings
  async function loadGoogleRatings() {
    console.log('Loading Google ratings...');
    try {
      if (typeof google === 'undefined') {
        console.log('Google not loaded yet');
        return;
      }

      console.log('Importing Places library...');
      // Use new Places API
      const { Place } = await google.maps.importLibrary("places");
      console.log('Places library loaded');

      // Find all rating elements
      const ratingElements = document.querySelectorAll('.store-rating');
      console.log(`Found ${ratingElements.length} rating elements`);

      // Fetch ratings for each store
      for (let i = 0; i < ratingElements.length; i++) {
        const element = ratingElements[i];
        const placeId = element.getAttribute('data-place-id');

        if (!placeId) continue;

        // Add small delay to avoid rate limiting
        if (i > 0) await new Promise(resolve => setTimeout(resolve, 100));

        try {
          console.log(`Fetching rating for place ID: ${placeId}`);
          const place = new Place({ id: placeId });
          await place.fetchFields({ fields: ['rating', 'userRatingCount'] });

          console.log(`Rating:`, place.rating, `Reviews:`, place.userRatingCount);

          if (place.rating) {
            const rating = place.rating;
            const totalReviews = place.userRatingCount || 0;

            // Display simple star rating
            element.innerHTML = `
              <a href="https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${placeId}"
                 target="_blank"
                 rel="noopener noreferrer"
                 class="flex items-center gap-1 text-yellow-400 hover:text-yellow-300 transition-colors font-semibold"
                 title="View on Google Maps">
                <span>‚≠ê ${rating}</span>
                <span class="text-xs text-gray-300">(${totalReviews})</span>
              </a>
            `;
          } else {
            element.innerHTML = '';
          }
        } catch (error) {
          console.error('Error fetching rating for place:', placeId, error);
          element.innerHTML = '';
        }
      }
    } catch (error) {
      console.error('Error loading Google ratings:', error);
      document.querySelectorAll('.store-rating .loading-text').forEach(el => {
        el.style.display = 'none';
      });
    }
  }

  // Load ratings when page is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGoogleRatings);
  } else {
    loadGoogleRatings();
  }

  // Also run on Astro page navigation
  document.addEventListener('astro:page-load', loadGoogleRatings);
</script>

<!-- Dutchie Carousel Script Injection -->
<script is:inline>
  // Dynamically load Dutchie carousel scripts
  document.addEventListener('DOMContentLoaded', () => {
    const containers = document.querySelectorAll('[id^="dutchie-carousel-container-"]');
    console.log(`üé† Found ${containers.length} carousel containers to load on region page`);

    containers.forEach((container, index) => {
      const fullScript = container.getAttribute('data-full-script');
      console.log(`üîç Container ${index + 1}:`, {
        id: container.id,
        hasFullScript: !!fullScript,
        fullScriptLength: fullScript ? fullScript.length : 0
      });

      // Check if we have a full embed script
      if (fullScript && fullScript.trim() !== '') {
        console.log(`üìú Using full embed script for carousel ${index + 1}`);

        // Parse the full script to extract the script tag
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = fullScript;
        const scriptTag = tempDiv.querySelector('script');

        if (scriptTag) {
          console.log(`‚úÖ Found script tag in full_embed_script`);
          // Create a new script element with the same attributes
          const script = document.createElement('script');
          script.async = scriptTag.async;
          script.id = scriptTag.id;
          script.src = scriptTag.src;

          // Add script to container
          container.appendChild(script);
          console.log(`‚úÖ Full embed script loaded:`, scriptTag.src);
        } else {
          console.error(`‚ùå Could not parse script from full_embed_script for carousel ${index + 1}`);
        }
      } else {
        // Fallback to constructing script from individual fields
        const storeId = container.getAttribute('data-store-id');
        const carouselId = container.getAttribute('data-carousel-id');
        const slug = container.getAttribute('data-slug');

        console.log(`üîß No full script, attempting to construct from data attributes:`, {
          storeId,
          carouselId,
          slug
        });

        if (storeId && carouselId) {
          console.log(`üèóÔ∏è Constructing carousel script ${index + 1}: ${carouselId} for store ${storeId}`);

          // Create script element
          const script = document.createElement('script');
          script.async = true;
          script.id = `dutchie--carousel-embed-${carouselId}__script`;
          script.src = `https://dutchie.com/api/v3/embedded-menu/${storeId}/carousels/${carouselId}.js?routeRoot=https%3A%2F%2Fmintdeals2025.pages.dev%2Flocation%2F${slug}%2F`;

          // Add script to container
          container.appendChild(script);

          console.log(`‚úÖ Script added for carousel ${carouselId}`);
        } else {
          console.error(`‚ùå Missing data attributes for container ${index + 1}`);
        }
      }
    });

    // Check if widgets loaded and show their containers
    let checkCount = 0;
    const checkWidgets = setInterval(() => {
      checkCount++;
      const widgets = document.querySelectorAll('[id^="dutchie--carousel-embed"]');
      const allContainers = document.querySelectorAll('.carousel-container-wrapper');

      console.log(`üé® Check #${checkCount}: Found ${widgets.length} widgets out of ${allContainers.length} containers`);

      // Show containers for successfully loaded widgets and hide spinners
      widgets.forEach((widget) => {
        const container = widget.closest('.carousel-container-wrapper');
        if (container && container.style.display === 'none') {
          const index = container.getAttribute('data-carousel-index');

          // Hide the spinner
          const spinner = document.querySelector(`[data-carousel-spinner="${index}"]`);
          if (spinner) {
            spinner.style.display = 'none';
          }

          // Show the carousel
          container.style.display = 'block';
          console.log(`‚úÖ Showing carousel container #${index} - widget loaded`);
        }
      });

      // After 5 seconds, start showing containers even if widgets haven't loaded yet
      if (checkCount >= 10) {
        allContainers.forEach((container, index) => {
          if (container.style.display === 'none') {
            const carouselIndex = container.getAttribute('data-carousel-index');

            // Hide the spinner
            const spinner = document.querySelector(`[data-carousel-spinner="${carouselIndex}"]`);
            if (spinner) {
              spinner.style.display = 'none';
            }

            container.style.display = 'block';
            console.log(`‚è∞ Force-showing carousel container #${index} after 5 seconds`);
          }
        });
      }
    }, 500);

    // Stop checking after 15 seconds
    setTimeout(() => {
      clearInterval(checkWidgets);
      const widgets = document.querySelectorAll('[id^="dutchie--carousel-embed"]');
      const allContainers = document.querySelectorAll('.carousel-container-wrapper');

      console.log(`üé® Final status: ${widgets.length} widgets loaded out of ${allContainers.length} containers`);

      // Make sure all containers are visible and spinners are hidden
      allContainers.forEach((container, index) => {
        if (container.style.display === 'none') {
          const carouselIndex = container.getAttribute('data-carousel-index');

          // Hide the spinner
          const spinner = document.querySelector(`[data-carousel-spinner="${carouselIndex}"]`);
          if (spinner) {
            spinner.style.display = 'none';
          }

          container.style.display = 'block';
          console.log(`üîß Final show of container #${index}`);
        }
      });

      if (widgets.length === 0) {
        console.warn(`‚ö†Ô∏è No Dutchie widgets found after 15 seconds!`);
      }
    }, 15000);
  });
</script>
