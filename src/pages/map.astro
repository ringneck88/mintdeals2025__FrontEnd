---
export const prerender = true;

import Layout from '../layouts/Layout.astro';

// Calculate map center (approximate center of USA)
const mapCenter = {
  lat: 39.8283,
  lng: -98.5795
};

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';
const GOOGLE_MAPS_API_KEY = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY;
---

<style>
  body {
    margin: 0;
    padding: 0;
  }
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  .video-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(to top,  rgba(41, 163, 41, 0.35), rgba(51, 204, 51, 0.3), rgba(92, 214, 92, 0.25), rgba(133, 224, 133, 0.2), rgba(194, 240, 194, 0.15), rgba(235, 250, 235, 0.1), rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
    mix-blend-mode: color;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.4));
    min-height: 100vh;
  }
  .hero-section {
    min-height: 10vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem 0;
  }

  #map {
    width: 100%;
    height: 70vh;
    border-radius: 0.5rem;
    border: 1px solid black;
    z-index: 1;
  }

  .map-container {
    position: relative;
  }

  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: 0.5rem;
  }

  .loading-spinner {
    border: 4px solid rgba(251, 191, 36, 0.3);
    border-top: 4px solid rgb(251, 191, 36);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Google Maps Info Window Custom Styling */
  .gm-style .gm-style-iw-c {
    padding: 0;
    border-radius: 8px;
    max-width: 320px !important;
  }

  .gm-style .gm-style-iw-d {
    overflow: auto !important;
  }

  .store-info-window {
    padding: 16px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: white;
  }

  .store-info-window h3 {
    margin: 0 0 8px 0;
    color: #16a34a !important;
    font-size: 18px;
    font-weight: bold;
  }

  .store-info-window .badge-24hour {
    display: inline-block;
    background: rgb(34, 197, 94);
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    margin-bottom: 10px;
    font-weight: bold;
  }

  .store-info-window .rating {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    color: #333 !important;
    font-size: 14px;
  }

  .store-info-window .rating .stars {
    color: #FFA500;
    font-size: 16px;
  }

  .store-info-window .address {
    margin-bottom: 12px;
    color: #1f2937 !important;
    font-size: 14px;
    line-height: 1.4;
  }

  .store-info-window .address div {
    color: #1f2937 !important;
  }

  .store-info-window .buttons {
    display: flex;
    gap: 8px;
  }

  .store-info-window .btn {
    flex: 1;
    text-align: center;
    padding: 10px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    font-size: 13px;
    color: white;
    transition: transform 0.2s;
  }

  .store-info-window .btn:hover {
    transform: scale(1.05);
  }

  .store-info-window .btn-view {
    background: linear-gradient(to right, rgb(251, 191, 36), rgb(249, 115, 22));
  }

  .store-info-window .btn-directions {
    background: rgb(34, 197, 94);
  }

  .store-info-window .btn-profile {
    background: rgb(59, 130, 246);
  }
</style>

<Layout title="Store Locations Map - Mint Cannabis" description="Interactive map showing all Mint Cannabis dispensary locations across the USA">
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Hero Section -->
    <div class="text-white hero-section">
      <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[90%]">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm">
          <div class="flex items-center justify-center space-x-2">
            <a href="/" class="text-yellow-400 hover:text-yellow-300">Home</a>
            <span class="text-green-300">/</span>
            <span class="text-white">Store Map</span>
          </div>
        </nav>

        <div class="text-center">
          <h1 class="mb-4 text-4xl font-bold text-white uppercase md:text-6xl drop-shadow-2xl" style="text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8), 0 2px 4px rgba(0, 0, 0, 0.9);">
            LOCATIONS NEAR YOU
          </h1>
          <p class="max-w-2xl mx-auto mb-6 text-lg text-green-500 md:text-xl drop-shadow-lg" id="storeCount">
            Loading store locations...
          </p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="py-8 bg-gray-800">
      <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[95%]">
        <!-- Map Container -->
        <div class="map-container">
          <div id="map"></div>
          <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
          </div>
        </div>

        <!-- Store List by State -->
        <div class="mt-12" id="storeList">
          <div id="storeListContent" class="space-y-6">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Maps JavaScript API -->
  <script async defer src={`https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,marker&callback=initMap`}></script>

  <!-- Map initialization script -->
  <script is:inline define:vars={{ center: mapCenter, apiBase: API_BASE, googleApiKey: GOOGLE_MAPS_API_KEY }}>
    let map;
    let stores = [];
    let markers = [];
    let placesService;

    // Initialize map - called by Google Maps callback
    window.initMap = async function() {
      console.log('üó∫Ô∏è Initializing Google Maps...');

      // Create map centered on USA
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: center.lat, lng: center.lng },
        zoom: 4,
        mapId: 'mint-cannabis-map', // For advanced markers
        styles: [
          {
            "featureType": "all",
            "elementType": "geometry",
            "stylers": [{ "color": "#242f3e" }]
          },
          {
            "featureType": "all",
            "elementType": "labels.text.stroke",
            "stylers": [{ "lightness": -80 }]
          },
          {
            "featureType": "administrative",
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#746855" }]
          },
          {
            "featureType": "poi",
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#d59563" }]
          },
          {
            "featureType": "road",
            "elementType": "geometry.fill",
            "stylers": [{ "color": "#2b3544" }]
          },
          {
            "featureType": "road",
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#9ca5b3" }]
          },
          {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [{ "color": "#17263c" }]
          }
        ]
      });

      // Initialize Places Service for fetching business details
      placesService = new google.maps.places.PlacesService(map);

      // Fetch and display stores
      await fetchStores();
    };

    async function fetchStores() {
      try {
        console.log('üìç Fetching stores from API...');
        const response = await fetch(`${apiBase}/stores?populate=*&pagination[pageSize]=500`);

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        const rawStores = data?.data || [];
        console.log(`‚úÖ Fetched ${rawStores.length} stores`);

        stores = rawStores.map(store => {
          const locationSlug = store.slug || store.location_slug ||
                              (store.name ? store.name.toLowerCase().replace(/[^a-z0-9]+/g, '-') : '');

          const address = store.address || {};
          const street = address.street || store.street || '';
          const city = address.city || store.city || '';
          const state = address.state || store.state || '';
          const zip = address.zip || store.zip || '';

          let latitude = null;
          let longitude = null;

          if (store.geo) {
            if (typeof store.geo === 'object') {
              latitude = store.geo.lat || store.geo.latitude || null;
              longitude = store.geo.lng || store.geo.lon || store.geo.longitude || null;
            } else if (typeof store.geo === 'string') {
              try {
                const geoObj = JSON.parse(store.geo);
                latitude = geoObj.lat || geoObj.latitude || null;
                longitude = geoObj.lng || geoObj.lon || geoObj.longitude || null;
              } catch (e) {
                console.error('Failed to parse geo string for store:', store.name);
              }
            }
          }

          const is24Hour = store.hours && Array.isArray(store.hours)
            ? store.hours.some(day => day.is24hours === true || day.is_24hour === true)
            : false;

          return {
            id: store.id || store.documentId,
            name: store.name || 'Mint Cannabis',
            slug: locationSlug,
            street,
            city,
            state,
            zip,
            latitude,
            longitude,
            is24Hour,
            phone: store.phone || '',
            region: store.region?.name || '',
            googlePlaceId: store.google_place_id || null
          };
        }).filter(store => store.latitude && store.longitude);

        console.log(`‚úÖ ${stores.length} stores have coordinates`);
        console.log(`üìç ${stores.filter(s => s.googlePlaceId).length} stores have Google Place IDs`);

        // Assign marker numbers to stores
        stores.forEach((store, index) => {
          store.markerNumber = index + 1;
        });

        // Update store count text
        document.getElementById('storeCount').textContent = `Explore all ${stores.length} Mint Cannabis dispensaries across the USA`;

        // Add markers to map first
        addMarkers();

        // Fetch place details for stores with Place IDs (for ratings/reviews)
        await fetchAllPlaceDetails();

        // Populate store list by state AFTER ratings are fetched
        populateStoreList();

        // Loading overlay will be hidden by map 'idle' event
      } catch (error) {
        console.error('‚ùå Error fetching stores:', error);
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.innerHTML = `
            <div style="text-align: center; color: white;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
              <div style="font-size: 1.2rem; font-weight: bold;">Error Loading Stores</div>
              <div style="margin-top: 0.5rem;">${error.message}</div>
            </div>
          `;
        }
      }
    }

    // Fetch place details for all stores with Place IDs
    async function fetchAllPlaceDetails() {
      console.log('‚≠ê Fetching Google Place details for ratings...');
      const storesWithPlaceIds = stores.filter(s => s.googlePlaceId);

      for (let i = 0; i < storesWithPlaceIds.length; i++) {
        const store = storesWithPlaceIds[i];

        // Add delay to avoid rate limiting
        if (i > 0) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        await new Promise((resolve) => {
          const request = {
            placeId: store.googlePlaceId,
            fields: ['rating', 'user_ratings_total']
          };

          placesService.getDetails(request, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              store.rating = place.rating || null;
              store.userRatingsTotal = place.user_ratings_total || 0;
              console.log(`‚úÖ ${store.name}: ${store.rating}‚≠ê (${store.userRatingsTotal} reviews)`);
            } else {
              console.warn(`‚ö†Ô∏è Could not load rating for ${store.name}: ${status}`);
            }
            resolve();
          });
        });
      }

      console.log(`‚úÖ Loaded ratings for ${storesWithPlaceIds.length} stores`);
    }

    // Create highlighted marker icon (larger)
    function createHighlightedMarkerIcon(number) {
      return {
        url: '/favicon.png',
        scaledSize: new google.maps.Size(35, 35), // Larger size when highlighted
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(17.5, 17.5)
      };
    }

    // Create normal marker icon
    function createNormalMarkerIcon(number) {
      return {
        url: '/favicon.png',
        scaledSize: new google.maps.Size(25, 25),
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(12.5, 12.5)
      };
    }

    function addMarkers() {
      const bounds = new google.maps.LatLngBounds();

      stores.forEach((store, index) => {
        const position = { lat: store.latitude, lng: store.longitude };
        const markerNumber = store.markerNumber; // Already assigned in fetchStores()

        // Create custom marker icon using Mint coin logo
        const markerIcon = createNormalMarkerIcon(markerNumber);

        // Create marker
        const marker = new google.maps.Marker({
          position: position,
          map: map,
          title: `${markerNumber}. ${store.name}`,
          icon: markerIcon,
          animation: google.maps.Animation.DROP,
          optimized: true,
          label: {
            text: markerNumber.toString(),
            color: 'rgba(255, 255, 255, 0.7)',
            fontSize: '9px',
            fontWeight: 'bold'
          }
        });

        // Store reference to marker in the store object
        store.marker = marker;

        markers.push(marker);
        bounds.extend(position);

        // Create info window with enhanced content
        const infoWindow = new google.maps.InfoWindow();

        // Add click listener
        marker.addListener('click', async () => {
          // If store has Google Place ID, fetch additional details
          if (store.googlePlaceId) {
            await fetchPlaceDetails(store, infoWindow);
          } else {
            // Show basic info window
            infoWindow.setContent(createBasicInfoWindow(store));
          }
          infoWindow.open(map, marker);
        });
      });

      // Fit map to show all markers
      if (stores.length > 0) {
        map.fitBounds(bounds);

        // Ensure zoom level doesn't get too close and hide loading overlay when map is ready
        const listener = google.maps.event.addListener(map, 'idle', function() {
          if (map.getZoom() > 12) {
            map.setZoom(12);
          }
          // Hide loading overlay when map is fully loaded
          const overlay = document.getElementById('loadingOverlay');
          if (overlay) {
            overlay.style.display = 'none';
          }
          google.maps.event.removeListener(listener);
        });
      } else {
        // If no stores, still hide the overlay
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      }
    }

    function createBasicInfoWindow(store) {
      return `
        <div class="store-info-window" style="background: rgba(31, 41, 55, 0.95); padding: 16px; min-width: 280px; border-radius: 8px;">
          <h3 style="color: white; margin: 0 0 12px 0; font-size: 18px; font-weight: bold; text-transform: uppercase;">${store.name}</h3>
          ${store.rating && store.googlePlaceId ? `
            <div style="margin-bottom: 4px;">
              <a href="https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${store.googlePlaceId}"
                 target="_blank"
                 rel="noopener noreferrer"
                 style="color: #fbbf24; text-decoration: none; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                <span>‚≠ê ${store.rating}</span>
              </a>
            </div>
            <div style="color: #d1d5db; font-size: 12px; margin-bottom: 12px;">(${store.userRatingsTotal || 0})</div>
          ` : '<div style="margin-bottom: 12px;"></div>'}
          <div class="address" style="margin-bottom: 12px; color: white; font-size: 14px; line-height: 1.6;">
            <div>${store.street}</div>
            <div>${store.city}, ${store.state} ${store.zip}</div>
          </div>
          ${store.phone ? `
            <div style="margin-bottom: 12px;">
              <a href="tel:${store.phone}" style="color: white; text-decoration: none; font-size: 14px; display: block; margin-bottom: 8px;">
                ${store.phone}
              </a>
            </div>
          ` : ''}
          <div style="margin-top: 12px;">
            <a href="${store.googlePlaceId ? `https://www.google.com/maps/dir/?api=1&destination=&destination_place_id=${store.googlePlaceId}` : `https://www.google.com/maps/dir/?api=1&destination=${store.latitude},${store.longitude}`}"
               target="_blank"
               rel="noopener noreferrer"
               style="color: white; text-decoration: none; font-size: 14px; display: block; margin-bottom: 10px;">
              Get Driving Directions
            </a>
            <a href="/location/${store.slug}"
               style="display: inline-block; background: #22c55e; color: white; padding: 8px 20px; border-radius: 9999px; text-decoration: none; font-weight: bold; font-size: 14px; transition: background 0.3s;">
              Shop Now
            </a>
          </div>
        </div>
      `;
    }

    async function fetchPlaceDetails(store, infoWindow) {
      return new Promise((resolve) => {
        const request = {
          placeId: store.googlePlaceId,
          fields: ['name', 'rating', 'user_ratings_total', 'photos', 'url', 'opening_hours']
        };

        placesService.getDetails(request, (place, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            console.log(`‚úÖ Loaded Place details for ${store.name}`, place);

            // Get photo URL if available
            let photoUrl = '';
            if (place.photos && place.photos.length > 0) {
              photoUrl = place.photos[0].getUrl({ maxWidth: 300, maxHeight: 200 });
            }

            // Build enhanced info window with business profile data
            const content = `
              <div class="store-info-window" style="background: rgba(31, 41, 55, 0.95); padding: 16px; min-width: 280px; border-radius: 8px;">
                <h3 style="color: white; margin: 0 0 12px 0; font-size: 18px; font-weight: bold; text-transform: uppercase;">${store.name}</h3>
                ${place.rating ? `
                  <div style="margin-bottom: 4px;">
                    <a href="https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${store.googlePlaceId}"
                       target="_blank"
                       rel="noopener noreferrer"
                       style="color: #fbbf24; text-decoration: none; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                      <span>‚≠ê ${place.rating}</span>
                    </a>
                  </div>
                  <div style="color: #d1d5db; font-size: 12px; margin-bottom: 12px;">(${place.user_ratings_total || 0})</div>
                ` : '<div style="margin-bottom: 12px;"></div>'}
                <div class="address" style="margin-bottom: 12px; color: white; font-size: 14px; line-height: 1.6;">
                  <div>${store.street}</div>
                  <div>${store.city}, ${store.state} ${store.zip}</div>
                </div>
                ${store.phone ? `
                  <div style="margin-bottom: 12px;">
                    <a href="tel:${store.phone}" style="color: white; text-decoration: none; font-size: 14px; display: block; margin-bottom: 8px;">
                      ${store.phone}
                    </a>
                  </div>
                ` : ''}
                <div style="margin-top: 12px;">
                  <a href="${store.googlePlaceId ? `https://www.google.com/maps/dir/?api=1&destination=&destination_place_id=${store.googlePlaceId}` : `https://www.google.com/maps/dir/?api=1&destination=${store.latitude},${store.longitude}`}"
                     target="_blank"
                     rel="noopener noreferrer"
                     style="color: white; text-decoration: none; font-size: 14px; display: block; margin-bottom: 10px;">
                    Get Driving Directions
                  </a>
                  <a href="/location/${store.slug}"
                     style="display: inline-block; background: #22c55e; color: white; padding: 8px 20px; border-radius: 9999px; text-decoration: none; font-weight: bold; font-size: 14px; transition: background 0.3s;">
                    Shop Now
                  </a>
                </div>
              </div>
            `;

            infoWindow.setContent(content);
            resolve(place);
          } else {
            console.warn(`‚ö†Ô∏è Could not load Place details for ${store.name}: ${status}`);
            // Fallback to basic info window
            infoWindow.setContent(createBasicInfoWindow(store));
            resolve(null);
          }
        });
      });
    }

    function populateStoreList() {
      // Group stores by state
      const storesByState = {};
      stores.forEach(store => {
        if (!storesByState[store.state]) {
          storesByState[store.state] = [];
        }
        storesByState[store.state].push(store);
      });

      // Sort states alphabetically
      const sortedStates = Object.keys(storesByState).sort();

      // Build HTML
      let html = '';
      sortedStates.forEach(state => {
        const stateStores = storesByState[state];

        html += `
          <div class="py-8 px-4" style="background-color: #374151; margin-left: calc(-50vw + 50%); margin-right: calc(-50vw + 50%); width: 100vw;">
            <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[95%]">
              <h3 class="mb-4 text-xl font-bold text-white uppercase">${state}</h3>
              <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
              ${stateStores.map(store => `
                <div class="store-card p-4 transition-all duration-300 rounded-lg hover:bg-green-900/30 hover:shadow-xl hover:scale-105"
                     style="background-color: #000000; position: relative; cursor: pointer;"
                     data-marker-number="${store.markerNumber}">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex flex-col items-start gap-2">
                      <span class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-yellow-400 text-black font-bold rounded-full text-xs">${store.markerNumber}</span>
                      <h4 class="font-bold text-white uppercase">${store.name}</h4>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                      ${store.rating && store.googlePlaceId ? `
                        <a href="https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${store.googlePlaceId}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="flex items-center gap-1 text-yellow-400 hover:text-yellow-300 transition-colors text-sm font-semibold"
                           onclick="event.stopPropagation()">
                          <span>‚≠ê ${store.rating}</span>
                          <span class="text-xs text-gray-300">(${store.userRatingsTotal})</span>
                        </a>
                      ` : ''}
                      ${store.is24Hour ? '<span class="px-2 py-1 text-xs font-bold text-white bg-green-500 rounded">24H</span>' : ''}
                    </div>
                  </div>
                  <div class="flex items-start text-white mb-3">
                    <svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <div class="text-sm">
                      <p class="mb-0">${store.street}</p>
                      <p class="mb-0">${store.city}, ${store.state} ${store.zip}</p>
                    </div>
                  </div>
                  ${store.phone ? `
                    <a href="tel:${store.phone}" class="flex items-center text-white hover:text-yellow-400 mb-3">
                      <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                      </svg>
                      ${store.phone}
                    </a>
                  ` : ''}
                  <div class="space-y-2">
                    <div class="flex justify-start">
                      <a href="${store.googlePlaceId ? `https://www.google.com/maps/dir/?api=1&destination=&destination_place_id=${store.googlePlaceId}` : `https://www.google.com/maps/dir/?api=1&destination=${store.latitude},${store.longitude}`}"
                         target="_blank"
                         rel="noopener noreferrer"
                         class="flex items-center text-sm text-white hover:text-yellow-400 transition-colors">
                        <svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        Get Driving Directions
                      </a>
                    </div>
                    <div class="flex justify-end">
                      <a href="/location/${store.slug}" class="inline-flex items-center px-4 py-2 bg-green-500 text-white font-bold rounded-full text-sm hover:bg-green-600 transition-colors">
                        Shop Now ‚Üí
                      </a>
                    </div>
                  </div>
                </div>
              `).join('')}
              </div>
            </div>
          </div>
        `;
      });

      document.getElementById('storeListContent').innerHTML = html;

      // Add hover event listeners to store cards
      setTimeout(() => {
        const storeCards = document.querySelectorAll('.store-card');
        storeCards.forEach(card => {
          const markerNumber = parseInt(card.getAttribute('data-marker-number'));
          const store = stores.find(s => s.markerNumber === markerNumber);

          if (store && store.marker) {
            card.addEventListener('mouseenter', () => {
              // Highlight marker - make it larger and bounce
              const highlightedIcon = createHighlightedMarkerIcon(markerNumber);
              store.marker.setIcon(highlightedIcon);
              store.marker.setAnimation(google.maps.Animation.BOUNCE);

              // Update label for highlighted state
              store.marker.setLabel({
                text: markerNumber.toString(),
                color: 'rgba(255, 255, 255, 0.9)',
                fontSize: '11px',
                fontWeight: 'bold'
              });

              // Pan map to show the marker
              map.panTo(store.marker.getPosition());
            });

            card.addEventListener('mouseleave', () => {
              // Reset marker to normal size
              const normalIcon = createNormalMarkerIcon(markerNumber);
              store.marker.setIcon(normalIcon);
              store.marker.setAnimation(null);

              // Reset label
              store.marker.setLabel({
                text: markerNumber.toString(),
                color: 'rgba(255, 255, 255, 0.7)',
                fontSize: '9px',
                fontWeight: 'bold'
              });
            });
          }
        });
      }, 100);
    }
  </script>
</Layout>
