---
export const prerender = true;

import Layout from '../layouts/Layout.astro';

// Fetch categories from Railway Strapi API
let categoriesData = [];
let apiError = null;

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

// Category icon mapping
function getCategoryIcon(slug) {
  const icons = {
    'flower': '',
    'pre-rolls': '',
    'vaporizers': '',
    'concentrates': '',
    'edibles': '',
    'topicals': '',
    'cartridges': '',
    'tinctures': '',
    'accessories': '',
    'cbd': ''
  };
  return icons[slug] || '';
}

// Category color mapping for variety
function getCategoryColor(index) {
  const colors = [
    'from-green-500 to-green-600',
    'from-yellow-400 to-yellow-500',
    'from-green-600 to-green-700',
    'from-yellow-500 to-yellow-600',
    'from-green-400 to-green-500',
    'from-yellow-300 to-yellow-400'
  ];
  return colors[index % colors.length];
}

try {
  console.log('ðŸš€ Fetching product categories from Railway API');

  const response = await fetch(`${API_BASE}/categories?populate=*&pagination[pageSize]=100`);

  if (response.ok) {
    const data = await response.json();
    categoriesData = data?.data || [];
    console.log('âœ… Categories loaded:', categoriesData.length);
  } else {
    const errorData = await response.json();
    console.error('âŒ Categories API Error:', errorData);
    apiError = errorData.error?.message || 'Failed to fetch categories';
  }
} catch (error) {
  console.error('âŒ Error fetching categories:', error);
  apiError = error.message;
}

// Helper function to get image URL from various possible structures
function getImageUrl(imageData) {
  if (!imageData || imageData === null) return null;

  // Case 1: Strapi v4 nested structure: image.data.attributes.url
  if (imageData?.data?.attributes?.url) {
    const url = imageData.data.attributes.url;
    return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
  }

  // Case 2: Direct image object with formats (Cloudinary or Strapi uploaded images)
  if (typeof imageData === 'object' && imageData.formats) {
    // Prefer larger formats for better quality
    if (imageData.formats.large?.url) return imageData.formats.large.url;
    if (imageData.formats.medium?.url) return imageData.formats.medium.url;
    if (imageData.formats.small?.url) return imageData.formats.small.url;
    if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
  }

  // Case 3: Direct image object with url: image.url
  if (typeof imageData === 'object' && imageData.url) {
    const url = imageData.url;
    return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
  }

  // Case 4: String URL directly
  if (typeof imageData === 'string') {
    return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
  }

  return null;
}

// Process categories for display
const categories = categoriesData.map((category, index) => {
  // Check if it's Strapi v4 format (with attributes) or direct format
  const isV4 = !!category.attributes;
  const data = isV4 ? category.attributes : category;

  // Try multiple possible image field names (case-insensitive variations)
  const imageUrl = getImageUrl(data.image)
    || getImageUrl(data.Image)
    || getImageUrl(data.IMAGE)
    || getImageUrl(category.image)
    || getImageUrl(category.Image)
    || null;

  console.log(`Category: ${data.Name || data.name}, Image URL: ${imageUrl}`);

  return {
    id: category.id,
    documentId: category.documentId,
    name: data.Name || data.name || 'Unnamed Category',
    description: data.Discription || data.description || '',
    richText: data.RichText || data.richText || data.rich_text || '',
    slug: data.Slug || data.slug || category.documentId || category.id,
    icon: getCategoryIcon(data.Slug || data.slug),
    image: imageUrl,
    isActive: data.IsActive !== false && data.isActive !== false,
    colorGradient: getCategoryColor(index),
    productCount: data.products?.data?.length || data.products?.length || 0
  };
}).filter(category => category.name && category.isActive)
  .sort((a, b) => a.name.localeCompare(b.name));

// Calculate statistics
const totalCategories = categories.length;
const totalProducts = categories.reduce((sum, cat) => sum + cat.productCount, 0);
---

<style>
  body {
    margin: 0;
    padding: 0;
  }
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  .video-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(to top,  rgba(41, 163, 41, 0.35), rgba(51, 204, 51, 0.3), rgba(92, 214, 92, 0.25), rgba(133, 224, 133, 0.2), rgba(194, 240, 194, 0.15), rgba(235, 250, 235, 0.1), rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
    mix-blend-mode: color;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.4));
  }
  .hero-section {
    min-height: 7.5vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
  }

  .hero-section h1 {
    line-height: 1.2;
  }

  @media (min-width: 768px) {
    .hero-section {
      min-height: 30vh;
      padding: 1rem 0;
    }
  }

  @media (min-width: 1024px) {
    .hero-section {
      min-height: 40vh;
      padding: 2rem 0;
    }
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Rich text content styling - clean and readable */
  .rich-text-content {
    color: #d1fae5;
    line-height: 1.8;
  }

  /* Hide editor metadata elements */
  .rich-text-content source-footnote,
  .rich-text-content sources-carousel-inline,
  .rich-text-content source-inline-chips,
  .rich-text-content source-inline-chip,
  .rich-text-content .source-inline-chip-container,
  .rich-text-content sup.superscript {
    display: none !important;
  }

  /* Clean up citation spans */
  .rich-text-content span[class*="citation"] {
    background: none !important;
    color: inherit !important;
  }

  /* Professional typesetting for headings */
  .rich-text-content h1,
  .rich-text-content h2,
  .rich-text-content h3,
  .rich-text-content h4,
  .rich-text-content h5,
  .rich-text-content h6 {
    color: #fbbf24;
    font-weight: 700;
  }

  .rich-text-content h1 {
    font-size: 2rem;
    line-height: 1.2;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .rich-text-content h2 {
    font-size: 1.75rem;
    line-height: 1.25;
    margin-top: 2em;
    margin-bottom: 0.75em;
  }

  .rich-text-content h3 {
    font-size: 1.5rem;
    line-height: 1.3;
    margin-top: 1.75em;
    margin-bottom: 0.65em;
  }

  .rich-text-content h4 {
    font-size: 1.25rem;
    line-height: 1.35;
    margin-top: 1.5em;
    margin-bottom: 0.6em;
  }

  .rich-text-content h5 {
    font-size: 1.1rem;
    line-height: 1.4;
    margin-top: 1.25em;
    margin-bottom: 0.55em;
  }

  .rich-text-content h6 {
    font-size: 1rem;
    line-height: 1.4;
    margin-top: 1.25em;
    margin-bottom: 0.5em;
  }

  .rich-text-content p {
    margin-bottom: 1.25em;
    line-height: 1.8;
  }

  .rich-text-content ul,
  .rich-text-content ol {
    margin: 1em 0 1.25em 1.5em;
    line-height: 1.8;
  }

  .rich-text-content li {
    margin-bottom: 0.5em;
  }

  .rich-text-content hr {
    border: none;
    border-top: 1px solid #4ade80;
    margin: 2em 0;
  }

  .rich-text-content a {
    color: #fbbf24;
    text-decoration: underline;
  }

  .rich-text-content a:hover {
    color: #fcd34d;
  }

  .rich-text-content strong {
    color: #86efac;
    font-weight: bold;
  }

  .rich-text-content em {
    font-style: italic;
  }

  /* Gradient heading class with better browser support */
  .gradient-heading {
    background: linear-gradient(to right, #fbbf24, #f97316);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-fill-color: transparent;
    display: inline-block;
  }
</style>

<Layout title="Product Categories - Mint Cannabis Deals" description="Explore our comprehensive range of cannabis product categories">
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Hero Section -->
    <div class="text-white hero-section relative">
      <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[90%]">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm relative z-10">
          <div class="flex items-center justify-center space-x-2">
            <a href="/" class="text-yellow-400 hover:text-yellow-300">Home</a>
            <span class="text-green-300">/</span>
            <span class="text-white">Categories</span>
          </div>
        </nav>

        <div class="text-center relative">
          <!-- Center Content -->
          <div class="relative z-10">
            <h1 class="mb-4 text-4xl font-bold text-white uppercase md:text-6xl drop-shadow-2xl" style="text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8), 0 2px 4px rgba(0, 0, 0, 0.9);">
              CATEGORIES
            </h1>
            <p class="max-w-2xl mx-auto mb-6 text-lg text-green-500 pb-1 leading-snug md:text-xl drop-shadow-lg">
              Explore our comprehensive range of premium cannabis products
            </p>
            <a href="/stores" class="text-yellow-400 font-semibold hover:text-yellow-300 transition-colors">
              Find Locations â†’
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Categories Section -->
    <div class="py-16 bg-black">
      <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[90%]">
        <div class="mb-12 text-center">
          <h2 class="mb-3 text-2xl font-bold text-white uppercase md:text-3xl">
            BROWSE ALL CATEGORIES
          </h2>
        </div>

        {apiError ? (
          <div class="py-12 text-center">
            <div class="max-w-md p-8 mx-auto bg-red-900 rounded-lg bg-opacity-80">
              <h3 class="mb-2 text-lg font-medium text-white uppercase">API ERROR</h3>
              <p class="text-sm text-red-300">{apiError}</p>
            </div>
          </div>
        ) : categories.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-6 gap-1 auto-rows-[180px]">
            {categories.map((category, index) => {
              // Define bento grid sizes - some span more cells
              const bentoSizes = [
                'md:col-span-2 md:row-span-2', // 0: Large featured
                'md:col-span-2 md:row-span-2', // 1: Large featured
                'md:col-span-2 md:row-span-1', // 2: Wide
                'md:col-span-2 md:row-span-2', // 3: Large featured
                'md:col-span-2 md:row-span-1', // 4: Wide
                'md:col-span-2 md:row-span-1', // 5: Wide
                'md:col-span-3 md:row-span-1', // 6: Extra wide
                'md:col-span-3 md:row-span-1', // 7: Extra wide
                'md:col-span-2 md:row-span-1', // 8: Regular
                'md:col-span-4 md:row-span-1', // 9: Full width
              ];

              return (
                <a
                  href={`/${category.slug}`}
                  class={`bento-card group relative overflow-hidden rounded-sm shadow-lg hover:shadow-xl transition-all duration-500 hover:scale-[1.01] ${bentoSizes[index % bentoSizes.length] || 'md:col-span-2'}`}
                >
                  <div class="absolute inset-0">
                    {category.image ? (
                      <img
                        src={category.image}
                        alt={category.name}
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                      />
                    ) : (
                      <div class={`w-full h-full bg-gradient-to-br ${category.colorGradient}`}>
                        <div class="absolute inset-0 flex items-center justify-center opacity-20">
                          <span class="text-9xl">{category.icon}</span>
                        </div>
                      </div>
                    )}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                  </div>

                  <div class="relative h-full flex flex-col justify-end p-6">
                    <div class="transform transition-transform duration-300 group-hover:translate-y-[-8px]">
                      <h3 class="text-2xl font-bold text-white mb-2 drop-shadow-lg uppercase">
                        {category.name}
                      </h3>
                      <p class="text-sm text-green-300 opacity-0 group-hover:opacity-100 transition-opacity duration-300 line-clamp-2">
                        {category.description || `Explore our ${category.name.toLowerCase()} collection`}
                      </p>
                      <div class="mt-3 flex items-center text-yellow-400 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <span class="text-sm font-medium">Explore</span>
                        <svg class="w-4 h-4 ml-2 transition-transform group-hover:translate-x-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </div>
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        ) : (
          <div class="py-12 text-center">
            <div class="max-w-md p-8 mx-auto bg-gradient-to-br from-green-900/20 to-black/60 rounded-lg">
              <h3 class="mb-2 text-lg font-medium text-white uppercase">CATEGORIES COMING SOON</h3>
              <p class="text-green-500">Product categories will be available here.</p>
            </div>
          </div>
        )}
      </div>
    </div>

  </div>
</Layout>
