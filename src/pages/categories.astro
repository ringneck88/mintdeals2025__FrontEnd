---
export const prerender = true;

import Layout from '../layouts/Layout.astro';

// Fetch categories from Railway Strapi API
let categoriesData = [];
let apiError = null;

const API_BASE = 'https://mintdealsbackend-production.up.railway.app/api';

// Category icon mapping
function getCategoryIcon(slug) {
  const icons = {
    'flower': '🌿',
    'pre-rolls': '🚬',
    'vaporizers': '💨',
    'concentrates': '🍯',
    'edibles': '🍭',
    'topicals': '🧴',
    'cartridges': '🖊️',
    'tinctures': '💧',
    'accessories': '🔧',
    'cbd': '🌱'
  };
  return icons[slug] || '🌿';
}

// Category color mapping for variety
function getCategoryColor(index) {
  const colors = [
    'from-green-500 to-green-600',
    'from-yellow-400 to-yellow-500',
    'from-green-600 to-green-700',
    'from-yellow-500 to-yellow-600',
    'from-green-400 to-green-500',
    'from-yellow-300 to-yellow-400'
  ];
  return colors[index % colors.length];
}

try {
  console.log('🚀 Fetching product categories from Railway API');

  const response = await fetch(`${API_BASE}/categories?populate=*&pagination[pageSize]=100`);

  if (response.ok) {
    const data = await response.json();
    categoriesData = data?.data || [];
    console.log('✅ Categories loaded:', categoriesData.length);
  } else {
    const errorData = await response.json();
    console.error('❌ Categories API Error:', errorData);
    apiError = errorData.error?.message || 'Failed to fetch categories';
  }
} catch (error) {
  console.error('❌ Error fetching categories:', error);
  apiError = error.message;
}

// Helper function to get image URL from various possible structures
function getImageUrl(imageData) {
  if (!imageData || imageData === null) return null;

  // Case 1: Strapi v4 nested structure: image.data.attributes.url
  if (imageData?.data?.attributes?.url) {
    const url = imageData.data.attributes.url;
    return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
  }

  // Case 2: Direct image object with formats (Cloudinary or Strapi uploaded images)
  if (typeof imageData === 'object' && imageData.formats) {
    // Prefer larger formats for better quality
    if (imageData.formats.large?.url) return imageData.formats.large.url;
    if (imageData.formats.medium?.url) return imageData.formats.medium.url;
    if (imageData.formats.small?.url) return imageData.formats.small.url;
    if (imageData.formats.thumbnail?.url) return imageData.formats.thumbnail.url;
  }

  // Case 3: Direct image object with url: image.url
  if (typeof imageData === 'object' && imageData.url) {
    const url = imageData.url;
    return url.startsWith('http') ? url : `https://mintdealsbackend-production.up.railway.app${url}`;
  }

  // Case 4: String URL directly
  if (typeof imageData === 'string') {
    return imageData.startsWith('http') ? imageData : `https://mintdealsbackend-production.up.railway.app${imageData}`;
  }

  return null;
}

// Process categories for display
const categories = categoriesData.map((category, index) => {
  // Check if it's Strapi v4 format (with attributes) or direct format
  const isV4 = !!category.attributes;
  const data = isV4 ? category.attributes : category;

  // Try multiple possible image field names (case-insensitive variations)
  const imageUrl = getImageUrl(data.image)
    || getImageUrl(data.Image)
    || getImageUrl(data.IMAGE)
    || getImageUrl(category.image)
    || getImageUrl(category.Image)
    || null;

  console.log(`Category: ${data.Name || data.name}, Image URL: ${imageUrl}`);

  return {
    id: category.id,
    documentId: category.documentId,
    name: data.Name || data.name || 'Unnamed Category',
    description: data.Discription || data.description || '',
    richText: data.RichText || data.richText || data.rich_text || '',
    slug: data.Slug || data.slug || category.documentId || category.id,
    icon: getCategoryIcon(data.Slug || data.slug),
    image: imageUrl,
    isActive: data.IsActive !== false && data.isActive !== false,
    colorGradient: getCategoryColor(index),
    productCount: data.products?.data?.length || data.products?.length || 0
  };
}).filter(category => category.name && category.isActive)
  .sort((a, b) => a.name.localeCompare(b.name));

// Calculate statistics
const totalCategories = categories.length;
const totalProducts = categories.reduce((sum, cat) => sum + cat.productCount, 0);
---

<style>
  body {
    margin: 0;
    padding: 0;
  }
  .video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }
  .video-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(to top,  rgba(41, 163, 41, 0.35), rgba(51, 204, 51, 0.3), rgba(92, 214, 92, 0.25), rgba(133, 224, 133, 0.2), rgba(194, 240, 194, 0.15), rgba(235, 250, 235, 0.1), rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
    mix-blend-mode: color;
    pointer-events: none;
    z-index: 1;
  }
  .video-background video {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  .content-wrapper {
    position: relative;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.4));
  }
  .hero-section {
    min-height: 7.5vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
  }

  .hero-section h1 {
    line-height: 1.2;
  }

  @media (min-width: 768px) {
    .hero-section {
      min-height: 30vh;
      padding: 1rem 0;
    }
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Rich text content styling - clean and readable */
  .rich-text-content {
    color: #d1fae5;
    line-height: 1.8;
  }

  /* Hide editor metadata elements */
  .rich-text-content source-footnote,
  .rich-text-content sources-carousel-inline,
  .rich-text-content source-inline-chips,
  .rich-text-content source-inline-chip,
  .rich-text-content .source-inline-chip-container,
  .rich-text-content sup.superscript {
    display: none !important;
  }

  /* Clean up citation spans */
  .rich-text-content span[class*="citation"] {
    background: none !important;
    color: inherit !important;
  }

  /* Professional typesetting for headings */
  .rich-text-content h1,
  .rich-text-content h2,
  .rich-text-content h3,
  .rich-text-content h4,
  .rich-text-content h5,
  .rich-text-content h6 {
    color: #fbbf24;
    font-weight: 700;
  }

  .rich-text-content h1 {
    font-size: 2rem;
    line-height: 1.2;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .rich-text-content h2 {
    font-size: 1.75rem;
    line-height: 1.25;
    margin-top: 2em;
    margin-bottom: 0.75em;
  }

  .rich-text-content h3 {
    font-size: 1.5rem;
    line-height: 1.3;
    margin-top: 1.75em;
    margin-bottom: 0.65em;
  }

  .rich-text-content h4 {
    font-size: 1.25rem;
    line-height: 1.35;
    margin-top: 1.5em;
    margin-bottom: 0.6em;
  }

  .rich-text-content h5 {
    font-size: 1.1rem;
    line-height: 1.4;
    margin-top: 1.25em;
    margin-bottom: 0.55em;
  }

  .rich-text-content h6 {
    font-size: 1rem;
    line-height: 1.4;
    margin-top: 1.25em;
    margin-bottom: 0.5em;
  }

  .rich-text-content p {
    margin-bottom: 1.25em;
    line-height: 1.8;
  }

  .rich-text-content ul,
  .rich-text-content ol {
    margin: 1em 0 1.25em 1.5em;
    line-height: 1.8;
  }

  .rich-text-content li {
    margin-bottom: 0.5em;
  }

  .rich-text-content hr {
    border: none;
    border-top: 1px solid #4ade80;
    margin: 2em 0;
  }

  .rich-text-content a {
    color: #fbbf24;
    text-decoration: underline;
  }

  .rich-text-content a:hover {
    color: #fcd34d;
  }

  .rich-text-content strong {
    color: #86efac;
    font-weight: bold;
  }

  .rich-text-content em {
    font-style: italic;
  }

  /* Gradient heading class with better browser support */
  .gradient-heading {
    background: linear-gradient(to right, #fbbf24, #f97316);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-fill-color: transparent;
    display: inline-block;
  }
</style>

<Layout title="Product Categories - Mint Cannabis Deals" description="Explore our comprehensive range of cannabis product categories">
  <!-- Video Background -->
  <div class="video-background">
    <video autoplay loop muted playsinline>
      <source src="https://video.wixstatic.com/video/d47472_58cce06729c54ccb935886c4b3647274/1080p/mp4/file.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- Hero Section -->
    <div class="text-white hero-section">
      <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[90%]">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm">
          <div class="flex items-center justify-center space-x-2">
            <a href="/" class="text-yellow-400 hover:text-yellow-300">Home</a>
            <span class="text-green-300">/</span>
            <span class="text-white">Categories</span>
          </div>
        </nav>

        <div class="text-center">
          <h1 class="mb-4 text-4xl font-bold md:text-6xl drop-shadow-2xl">
            <span class="inline-block pb-2 leading-tight bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent" style="padding-bottom: 0.5rem;">
              Product Categories
            </span>
          </h1>
          <p class="max-w-2xl mx-auto mb-6 text-lg text-yellow-400 pb-1 leading-snug md:text-xl drop-shadow-lg">
            Explore our comprehensive range of premium cannabis products
          </p>
          <div class="flex flex-wrap justify-center gap-4">
            <a href="/stores" class="px-6 py-2.5 text-base font-semibold text-white transition-all transform rounded-lg shadow-lg bg-gradient-to-r from-yellow-400 to-transparent hover:from-yellow-500 hover:to-transparent hover:scale-105">
              Find Locations
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats Section -->
    <div class="py-4 bg-black bg-opacity-90">
      <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[90%]">
        <div class="grid grid-cols-2 gap-12 text-center md:grid-cols-4">
          <div>
            <div class="mb-1 text-2xl font-bold text-green-500">{totalCategories}+</div>
            <div class="text-sm text-yellow-400 font-semibold">Categories</div>
          </div>
          <div>
            <div class="mb-1 text-2xl font-bold text-green-500">{totalProducts}+</div>
            <div class="text-sm text-yellow-400 font-semibold">Products</div>
          </div>
          <div>
            <div class="mb-1 text-2xl font-bold text-green-500">100%</div>
            <div class="text-sm text-yellow-400 font-semibold">Legal</div>
          </div>
          <div>
            <div class="mb-1 text-2xl font-bold text-green-500">24/7</div>
            <div class="text-sm text-yellow-400 font-semibold">Available</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Categories Section -->
    <div class="py-16 bg-black">
      <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[90%]">
        <div class="mb-12 text-center">
          <h2 class="mb-3 text-2xl font-bold md:text-3xl">
            <span class="inline-block pb-2 leading-tight bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent" style="padding-bottom: 0.5rem;">
              Browse All Categories
            </span>
          </h2>
          <p class="text-lg text-green-300">
            Click on any category to explore products
          </p>
        </div>

        {apiError ? (
          <div class="py-12 text-center">
            <div class="max-w-md p-8 mx-auto bg-red-900 rounded-lg bg-opacity-80">
              <div class="mb-4 text-6xl text-red-400">⚠️</div>
              <h3 class="mb-2 text-lg font-medium gradient-heading pb-1 leading-snug">API Error</h3>
              <p class="text-sm text-red-300">{apiError}</p>
            </div>
          </div>
        ) : categories.length > 0 ? (
          <div class="grid grid-cols-2 gap-6 md:grid-cols-3 lg:grid-cols-4 xl:gap-8">
            {categories.map((category, index) => (
              <a
                href={`/${category.slug}`}
                class="relative overflow-hidden transition-all transform bg-black border-2 border-green-500 group rounded-xl hover:shadow-lg hover:shadow-yellow-400/30 hover:scale-105 hover:-translate-y-1"
              >
                {/* Category Image or Icon */}
                {category.image ? (
                  <div class="h-40 overflow-hidden bg-gradient-to-br from-green-900/30 to-black/50">
                    <img
                      src={category.image}
                      alt={category.name}
                      class="object-cover w-full h-full transition-opacity opacity-80 group-hover:opacity-100"
                    />
                  </div>
                ) : (
                  <div class={`h-40 bg-gradient-to-br ${category.colorGradient} flex items-center justify-center`}>
                    <span class="text-5xl">{category.icon}</span>
                  </div>
                )}

                {/* Category Content */}
                <div class="p-4">
                  <h3 class="mb-1 text-lg font-bold gradient-heading pb-1 leading-snug">
                    {category.name}
                  </h3>
                  {category.description && (
                    <p class="mb-2 text-xs text-green-300 line-clamp-2">
                      {category.description}
                    </p>
                  )}
                  <div class="flex items-center justify-between">
                    <span class="text-xs text-green-400">
                      {category.productCount || 0} products
                    </span>
                    <span class="text-yellow-400 transition-transform group-hover:translate-x-1">
                      →
                    </span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="py-12 text-center">
            <div class="max-w-md p-8 mx-auto bg-black border-2 border-green-500 rounded-lg">
              <div class="mb-4 text-6xl">🌿</div>
              <h3 class="mb-2 text-lg font-medium gradient-heading pb-1 leading-snug">Categories Coming Soon</h3>
              <p class="text-green-300">Product categories will be available here.</p>
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- About Section -->
    <div class="py-16 bg-gradient-to-b from-green-900/40 to-black/60">
      <div class="px-8 mx-auto sm:px-12 lg:px-16 xl:px-20 max-w-[90%]">
        <div class="mb-12 text-center">
          <h2 class="mb-3 text-2xl font-bold md:text-3xl">
            <span class="inline-block pb-2 leading-tight bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent" style="padding-bottom: 0.5rem;">
              Why Choose Mint Deals
            </span>
          </h2>
          <p class="text-lg text-green-300">
            Your trusted partner in cannabis discovery
          </p>
        </div>

        <div class="grid grid-cols-1 gap-8 md:grid-cols-3 xl:gap-12">
          <!-- Feature 1 -->
          <div class="p-6 transition-all bg-black border-2 border-green-500 rounded-lg shadow-lg hover:shadow-yellow-400/20">
            <div class="flex items-center justify-center w-12 h-12 mb-4 rounded-lg bg-gradient-to-r from-yellow-400 to-orange-500">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </div>
            <h3 class="mb-3 text-xl font-bold gradient-heading pb-1 leading-snug">Find Locations</h3>
            <p class="text-green-300">
              Discover trusted dispensaries near you with detailed information and directions.
            </p>
          </div>

          <!-- Feature 2 -->
          <div class="p-6 transition-all bg-black border-2 border-green-500 rounded-lg shadow-lg hover:shadow-yellow-400/20">
            <div class="flex items-center justify-center w-12 h-12 mb-4 rounded-lg bg-gradient-to-r from-yellow-400 to-orange-500">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
            </div>
            <h3 class="mb-3 text-xl font-bold gradient-heading pb-1 leading-snug">Browse Products</h3>
            <p class="text-green-300">
              Explore comprehensive product information and educational resources.
            </p>
          </div>

          <!-- Feature 3 -->
          <div class="p-6 transition-all bg-black border-2 border-green-500 rounded-lg shadow-lg hover:shadow-yellow-400/20">
            <div class="flex items-center justify-center w-12 h-12 mb-4 rounded-lg bg-gradient-to-r from-yellow-400 to-orange-500">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="mb-3 text-xl font-bold gradient-heading pb-1 leading-snug">Trusted Information</h3>
            <p class="text-green-300">
              Access reliable, up-to-date information from verified sources and experts.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
